<!-- AgentDashboard - SPA Fragment (converted from standalone) -->
<!-- Header -->
  <div class="header">
    <div class="welcome" id="welcomeMessage">Welcome back, Agent!</div>
    <div class="date" id="currentDate"></div>
  </div>

  <!-- Quick Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">My Leads Today</div>
      <div class="stat-value" id="statLeads">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Calls Today</div>
      <div class="stat-value" id="statCalls">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Deals This Month</div>
      <div class="stat-value" id="statDeals">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">My Revenue</div>
      <div class="stat-value" id="statRevenue">$0</div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="actions-grid">
    <button class="action-btn" onclick="goToDialer()">
      <div class="action-icon">ğŸ“</div>
      <div class="action-label">Call Next Lead</div>
    </button>
    <button class="action-btn" onclick="goToLeads()">
      <div class="action-icon">â•</div>
      <div class="action-label">Add Lead</div>
    </button>
    <button class="action-btn" onclick="goToPipeline()">
      <div class="action-icon">ğŸ¯</div>
      <div class="action-label">View Pipeline</div>
    </button>
    <button class="action-btn" onclick="goToDialer()">
      <div class="action-icon">ğŸ”¢</div>
      <div class="action-label">Open Dialer</div>
    </button>
  </div>

  <!-- Main Content -->
  <div class="content-grid">
    <!-- My Tasks -->
    <div class="glass-card">
      <div class="card-title">âœ… My Tasks</div>
      <div class="task-list" id="taskList"></div>
    </div>

    <!-- Recent Activity -->
    <div class="glass-card">
      <div class="card-title">ğŸ“‹ Recent Activity</div>
      <div class="activity-feed" id="activityFeed"></div>
    </div>

    <!-- Today's Schedule -->
    <div class="glass-card">
      <div class="card-title">ğŸ“… Today's Schedule</div>
      <div class="schedule-list" id="scheduleList"></div>
    </div>

    <!-- Performance Snapshot -->
    <div class="glass-card">
      <div class="card-title">ğŸ“Š My Calls This Week</div>
      <div class="performance-chart" id="performanceChart"></div>
    </div>
  </div>

  <script>
(function() {
  'use strict';

  // AI Agent data hidden from agent role
  // Regular agents should not see AI agent references, monitoring, or controls.

  let currentUser = null;

  (function() {
    loadAgentDashboard();
  });

  async function loadAgentDashboard() {
    currentUser = window.DebtDB.getCurrentUser();
    
    // Update welcome message
    const name = currentUser?.name || 'Agent';
    document.getElementById('welcomeMessage').textContent = `Welcome back, ${name}! ğŸ‘‹`;
    
    // Update date
    const today = new Date();
    document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    await updateStats();
    renderTasks();
    renderActivity();
    renderSchedule();
    renderPerformance();
  }

  async function fetchCallData() {
    try {
      const resp = await fetch('https://debt-voice-stack.fly.dev/api/calls?limit=50');
      const data = await resp.json();
      return data.calls || [];
    } catch(e) {
      console.warn('Voice stack API unavailable, using local data:', e);
      return window.DebtDB.getCalls() || [];
    }
  }

  async function updateStats() {
    const leads = (window.DebtDB?.getLeads?.() || []);
    const calls = await fetchCallData();
    const deals = (window.DebtDB?.getDeals?.() || []);
    
    const today = new Date().toISOString().split('T')[0];
    const thisMonth = new Date().toISOString().slice(0, 7);
    
    // Filter for current agent
    const myLeads = leads.filter(l => l.agent === currentUser?.id && l.createdAt?.startsWith(today));
    const myCalls = calls.filter(c => c.agent === currentUser?.id && c.createdAt?.startsWith(today));
    const myDeals = deals.filter(d => d.agent === currentUser?.id && d.createdAt?.startsWith(thisMonth));
    const myRevenue = myDeals.reduce((sum, d) => sum + (d.amount || 0), 0);
    
    document.getElementById('statLeads').textContent = myLeads.length;
    document.getElementById('statCalls').textContent = myCalls.length;
    document.getElementById('statDeals').textContent = myDeals.length;
    document.getElementById('statRevenue').textContent = '$' + myRevenue.toLocaleString();
  }

  function renderTasks() {
    const taskList = document.getElementById('taskList');
    
    // Get tasks from activities or create mock tasks
    const tasks = [
      { id: 1, title: 'Follow up with John Smith', time: '10:00 AM', completed: false },
      { id: 2, title: 'Complete onboarding call with Sarah Johnson', time: '2:00 PM', completed: false },
      { id: 3, title: 'Review and sign documents for Mike Davis', time: '3:30 PM', completed: false },
      { id: 4, title: 'Call back missed lead from yesterday', time: 'ASAP', completed: false },
      { id: 5, title: 'Update case notes for active clients', time: 'End of day', completed: false }
    ];
    
    taskList.innerHTML = tasks.map(task => `
      <div class="task-item" data-task-id="${task.id}">
        <div class="task-checkbox ${task.completed ? 'completed' : ''}" 
             onclick="toggleTask(${task.id})"></div>
        <div class="task-content">
          <div class="task-title">${task.title}</div>
          <div class="task-time">â° ${task.time}</div>
        </div>
        <div class="task-actions">
          <button class="btn-sm btn-success" onclick="completeTask(${task.id})">Done</button>
          <button class="btn-sm btn-danger" onclick="dismissTask(${task.id})">Dismiss</button>
        </div>
      </div>
    `).join('');
  }

  function renderActivity() {
    const activities = window.DebtDB.getActivities({ userId: currentUser?.id }).slice(0, 10);
    const feed = document.getElementById('activityFeed');
    
    if (activities.length === 0) {
      feed.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No recent activity</div>';
      return;
    }
    
    feed.innerHTML = activities.map(activity => {
      const icon = getActivityIcon(activity.type);
      const text = formatActivityText(activity);
      const time = formatTimeAgo(activity.createdAt);
      
      return `
        <div class="activity-item">
          <div class="activity-icon">${icon}</div>
          <div class="activity-content">
            <div class="activity-text">${text}</div>
            <div class="activity-time">${time}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderSchedule() {
    const scheduleList = document.getElementById('scheduleList');
    
    // Get today's callbacks and follow-ups
    const today = new Date().toISOString().split('T')[0];
    const activities = (window.DebtDB?.getActivities?.() || []).filter(a => 
      a.scheduledFor && a.scheduledFor.startsWith(today)
    );
    
    if (activities.length === 0) {
      scheduleList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No scheduled items today</div>';
      return;
    }
    
    scheduleList.innerHTML = activities.map(activity => {
      const time = new Date(activity.scheduledFor).toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit' 
      });
      
      return `
        <div class="schedule-item">
          <div class="schedule-time">${time}</div>
          <div class="schedule-content">
            <div class="schedule-title">${activity.type === 'callback' ? 'Callback' : 'Follow-up'}</div>
            <div class="schedule-client">${activity.data?.client || 'Client'}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderPerformance() {
    const chart = document.getElementById('performanceChart');
    const calls = window.DebtDB.getCalls().filter(c => c.agent === currentUser?.id);
    
    // Get last 7 days
    const days = [];
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      days.push({
        date: date.toISOString().split('T')[0],
        label: date.toLocaleDateString('en-US', { weekday: 'short' }),
        count: 0
      });
    }
    
    // Count calls per day
    calls.forEach(call => {
      const callDate = call.createdAt?.split('T')[0];
      const day = days.find(d => d.date === callDate);
      if (day) day.count++;
    });
    
    const maxCount = Math.max(...days.map(d => d.count), 1);
    
    chart.innerHTML = days.map(day => {
      const height = (day.count / maxCount) * 100;
      return `
        <div class="perf-bar-wrapper">
          <div class="perf-bar" style="height: ${height}%">
            <div class="perf-bar-value">${day.count}</div>
          </div>
          <div class="perf-bar-label">${day.label}</div>
        </div>
      `;
    }).join('');
  }

  function getActivityIcon(type) {
    const icons = {
      'call': 'ğŸ“',
      'lead_created': 'ğŸ‘¤',
      'deal_updated': 'ğŸ’¼',
      'case_created': 'ğŸ“‹',
      'note_added': 'ğŸ“',
      'email_sent': 'ğŸ“§',
      'sms_sent': 'ğŸ’¬'
    };
    return icons[type] || 'ğŸ“Œ';
  }

  function formatActivityText(activity) {
    const types = {
      'call': `Called ${activity.data?.client || 'client'}`,
      'lead_created': `Created new lead: ${activity.data?.name || 'Unknown'}`,
      'deal_updated': `Updated deal in pipeline`,
      'case_created': `Created new case`,
      'note_added': `Added note to case`,
      'email_sent': `Sent email to ${activity.data?.client || 'client'}`,
      'sms_sent': `Sent SMS to ${activity.data?.client || 'client'}`
    };
    return types[activity.type] || activity.type;
  }

  function formatTimeAgo(timestamp) {
    const now = new Date();
    const then = new Date(timestamp);
    const diff = Math.floor((now - then) / 1000);
    
    if (diff < 60) return 'Just now';
    if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
    if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
    return Math.floor(diff / 86400) + ' days ago';
  }

  function toggleTask(id) {
    const taskItem = document.querySelector(`[data-task-id="${id}"]`);
    if (taskItem) {
      const checkbox = taskItem.querySelector('.task-checkbox');
      checkbox.classList.toggle('completed');
    }
  }

  function completeTask(id) {
    const taskItem = document.querySelector(`[data-task-id="${id}"]`);
    if (taskItem) {
      taskItem.style.opacity = '0.5';
      setTimeout(() => taskItem.remove(), 300);
    }
  }

  function dismissTask(id) {
    const taskItem = document.querySelector(`[data-task-id="${id}"]`);
    if (taskItem) {
      taskItem.style.opacity = '0';
      setTimeout(() => taskItem.remove(), 300);
    }
  }

  function goToDialer() {
    if (window.App && window.App.loadPage) {
      window.App.loadPage('PowerDialer');
    } else {
      window.location.href = '/pages/PowerDialer.html';
    }
  }

  function goToLeads() {
    if (window.App && window.App.loadPage) {
      window.App.loadPage('CRMLeads');
    } else {
      window.location.href = '/pages/CRMLeads.html';
    }
  }

  function goToPipeline() {
    if (window.App && window.App.loadPage) {
      window.App.loadPage('DealPipeline');
    } else {
      window.location.href = '/pages/DealPipeline.html';
    }
  }

  // Expose functions to window for onclick handlers
  window.completeTask = completeTask;
  window.dismissTask = dismissTask;
  window.goToDialer = goToDialer;
  window.goToLeads = goToLeads;
  window.goToPipeline = goToPipeline;
  window.toggleTask = toggleTask;
})();
</script>
