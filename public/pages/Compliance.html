<!-- Compliance - SPA Fragment (converted from standalone) -->
<!-- Header -->
  <div class="header">
    <h1>
      üõ°Ô∏è Compliance Center
    </h1>
    <button class="btn btn-success btn-icon" onclick="generateReport()">
      üìÑ Generate Report
    </button>
  </div>

  <!-- Competitive Edge Alert -->
  <div class="competitive-edge">
    <div class="competitive-edge-text">
      <div class="competitive-edge-title">‚ö†Ô∏è YOUR COMPETITIVE ADVANTAGE</div>
      <div class="competitive-edge-subtitle">StratusBK & Talkt have ZERO compliance certifications. You're exposed to:</div>
    </div>
    <div class="competitive-edge-amount">$3.5M - $14.9M</div>
  </div>

  <!-- Top Section: Score + License Grid -->
  <div class="top-section">
    <!-- Compliance Score Gauge -->
    <div class="glass-card score-gauge">
      <div class="score-title">Compliance Score</div>
      <div class="gauge-wrapper">
        <div class="gauge-circle" id="gaugeCircle">
          <div class="gauge-value" id="gaugeValue">0%</div>
        </div>
      </div>
      <div class="gauge-status" id="gaugeStatus">Calculating...</div>
      
      <div class="alert-summary">
        <div class="alert-box">
          <div class="alert-box-value" style="color: var(--success);" id="completedCount">0</div>
          <div class="alert-box-label">Completed</div>
        </div>
        <div class="alert-box">
          <div class="alert-box-value" style="color: var(--warning);" id="pendingCount">0</div>
          <div class="alert-box-label">Pending</div>
        </div>
        <div class="alert-box">
          <div class="alert-box-value" style="color: var(--danger);" id="expiringCount">0</div>
          <div class="alert-box-label">Expiring</div>
        </div>
      </div>
    </div>

    <!-- State License Grid -->
    <div class="glass-card license-grid-wrapper">
      <div class="license-grid-title">üìã State Licensing (50 States)</div>
      <div class="license-grid" id="licenseGrid"></div>
      <div class="license-legend">
        <div class="legend-item">
          <div class="legend-dot" style="background: var(--success);"></div>
          <span>Active ‚úÖ</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: var(--warning);"></div>
          <span>Pending üü°</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: var(--danger);"></div>
          <span>Expired üî¥</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: rgba(148, 163, 184, 0.2);"></div>
          <span>Not Required ‚ö™</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="main-grid">
    <!-- Left Column: Compliance Checklist -->
    <div class="glass-card checklist-section">
      <h3>‚úÖ Compliance Checklist</h3>
      <div id="checklistContainer"></div>
    </div>

    <!-- Right Column: TCPA Tracker -->
    <div class="glass-card tcpa-section">
      <h3>üìû TCPA Consent Tracker</h3>
      <div class="tcpa-stats">
        <div class="tcpa-stat">
          <div class="tcpa-stat-value" id="tcpaTotal">0</div>
          <div class="tcpa-stat-label">Total Consents</div>
        </div>
        <div class="tcpa-stat">
          <div class="tcpa-stat-value" id="tcpaVerified">0</div>
          <div class="tcpa-stat-label">Verified</div>
        </div>
        <div class="tcpa-stat">
          <div class="tcpa-stat-value" id="tcpaPending">0</div>
          <div class="tcpa-stat-label">Pending</div>
        </div>
      </div>
      <div class="dnc-header">
        <input type="text" class="dnc-input" id="tcpaLeadName" placeholder="Lead Name">
        <input type="text" class="dnc-input" id="tcpaPhone" placeholder="Phone">
        <button class="btn btn-primary btn-sm" onclick="addTCPAConsent()">Add</button>
      </div>
      <div class="tcpa-table">
        <table>
          <thead>
            <tr>
              <th>Lead</th>
              <th>Phone</th>
              <th>Date</th>
              <th>Method</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tcpaTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DNC + Audit Grid -->
  <div class="main-grid">
    <!-- DNC List -->
    <div class="glass-card dnc-section">
      <h3>üö´ Do Not Call (DNC) List</h3>
      <div class="dnc-header">
        <input type="text" class="dnc-input" id="dncPhone" placeholder="Phone Number">
        <button class="btn btn-primary" onclick="addDNC()">Add to DNC</button>
        <button class="btn btn-secondary" onclick="importDNC()">Import CSV</button>
      </div>
      <div style="margin-bottom: 1rem;">
        <span style="font-family: 'Orbitron'; font-size: 1.25rem; color: var(--accent);" id="dncCount">0</span>
        <span style="color: var(--text-muted); font-size: 0.875rem;"> numbers on DNC list</span>
      </div>
      <div class="dnc-list" id="dncList"></div>
    </div>

    <!-- Audit Log -->
    <div class="glass-card audit-section">
      <h3>üìù Audit Log</h3>
      <div class="audit-log" id="auditLog"></div>
    </div>
  </div>

  <!-- License Edit Modal -->
  <div class="modal" id="licenseModal">
    <div class="modal-content">
      <div class="modal-header">Edit License: <span id="modalState"></span></div>
      <div class="form-group">
        <label class="form-label">License Number</label>
        <input type="text" class="form-input" id="licenseNumber" placeholder="e.g., IL-12345">
      </div>
      <div class="form-group">
        <label class="form-label">Expiry Date</label>
        <input type="date" class="form-input" id="licenseExpiry">
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-select" id="licenseStatus">
          <option value="active">Active ‚úÖ</option>
          <option value="pending">Pending üü°</option>
          <option value="expired">Expired üî¥</option>
          <option value="not-required">Not Required ‚ö™</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <input type="text" class="form-input" id="licenseNotes" placeholder="Additional notes">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeLicenseModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveLicense()">Save License</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span id="toastMessage"></span>
  </div>

  <script>
(function() {
'use strict';

    // State abbreviations
    const US_STATES = [
      'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
      'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
      'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
      'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
      'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
    ];

    // Operating states for DebtStoppers
    const OPERATING_STATES = ['IL', 'MI', 'GA', 'FL', 'TX'];

    // Compliance checklist structure
    const COMPLIANCE_CHECKLIST = [
      {
        category: 'üèõÔ∏è Federal Compliance',
        items: [
          { id: 'tsr', label: 'Telemarketing Sales Rule (TSR) compliance documented' },
          { id: 'tcpa', label: 'TCPA consent management system active' },
          { id: 'fdcpa', label: 'Fair Debt Collection Practices Act (FDCPA) training completed' },
          { id: 'ftc', label: 'FTC Act Section 5 consumer protection review' },
          { id: 'cfpb', label: 'CFPB debt collection rules implemented' }
        ]
      },
      {
        category: 'üè¢ State Compliance',
        items: [
          { id: 'state_lic', label: 'All operating state licenses current' },
          { id: 'state_bond', label: 'Surety bonds filed in required states' },
          { id: 'state_reg', label: 'State registration documents on file' },
          { id: 'state_annual', label: 'Annual state reports submitted' }
        ]
      },
      {
        category: 'üîê Data Protection (HIPAA Readiness)',
        items: [
          { id: 'hipaa_policy', label: 'HIPAA policies and procedures documented' },
          { id: 'phi_encryption', label: 'PHI (Protected Health Information) encrypted at rest' },
          { id: 'phi_transit', label: 'PHI encrypted in transit (TLS 1.3)' },
          { id: 'access_control', label: 'Role-based access controls (RBAC) implemented' },
          { id: 'breach_plan', label: 'Breach notification plan documented' },
          { id: 'baa', label: 'Business Associate Agreements (BAA) signed' },
          { id: 'audit_trail', label: 'Comprehensive audit logging active' }
        ]
      },
      {
        category: 'üéØ SOC 2 Control Framework',
        items: [
          { id: 'soc2_security', label: 'Security controls documented' },
          { id: 'soc2_availability', label: 'Availability monitoring in place' },
          { id: 'soc2_integrity', label: 'Data integrity checks automated' },
          { id: 'soc2_confidentiality', label: 'Confidentiality policies enforced' },
          { id: 'soc2_privacy', label: 'Privacy controls implemented' }
        ]
      },
      {
        category: '‚öñÔ∏è Operations',
        items: [
          { id: 'call_recording', label: 'Call recording consent protocols active' },
          { id: 'fee_disclosure', label: 'Fee disclosure templates current' },
          { id: 'contract_req', label: 'Contract requirements checklist complete' },
          { id: 'complaint_proc', label: 'Complaint handling procedures documented' },
          { id: 'qc_calls', label: 'Quality control call audits scheduled' }
        ]
      }
    ];

    let currentLicenseState = null;
    let tcpaConsents = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initializeCompliance();
      renderLicenseGrid();
      renderChecklist();
      renderTCPATable();
      renderDNCList();
      renderAuditLog();
      updateComplianceScore();
    });

    function initializeCompliance() {
      // Initialize compliance data if not exists
      if (!(window.DebtDB?.getComplianceChecklist?.() || []).length) {
        COMPLIANCE_CHECKLIST.forEach(cat => {
          cat.items.forEach(item => {
            window.DebtDB?.updateComplianceItem?.(item.id, {
              id: item.id,
              label: item.label,
              category: cat.category,
              completed: false
            });
          });
        });
      }

      // Initialize licenses for operating states
      const existingLicenses = window.DebtDB.getLicenses();
      OPERATING_STATES.forEach(state => {
        if (!existingLicenses.find(l => l.state === state)) {
          window.DebtDB.updateLicense(state, {
            status: 'active',
            licenseNumber: `${state}-ACTIVE-2026`,
            expiryDate: '2027-12-31',
            notes: 'Primary operating state'
          });
        }
      });

      // Load TCPA consents from storage
      const stored = localStorage.getItem('tcpa_consents');
      if (stored) {
        tcpaConsents = JSON.parse(stored);
      }
    }

    function renderLicenseGrid() {
      const grid = document.getElementById('licenseGrid');
      if (!grid) return; // Guard against SPA race condition
      const licenses = window.DebtDB.getLicenses();
      
      grid.innerHTML = US_STATES.map(state => {
        const license = licenses.find(l => l.state === state);
        let statusClass = 'not-required';
        
        if (license) {
          statusClass = license.status || 'not-required';
        } else if (OPERATING_STATES.includes(state)) {
          statusClass = 'active';
        }
        
        return `<div class="license-cell ${statusClass}" onclick="openLicenseModal('${state}')">${state}</div>`;
      }).join('');

      updateExpiringCount();
    }

    function renderChecklist() {
      const container = document.getElementById('checklistContainer');
      if (!container) return;
      const checklist = (window.DebtDB?.getComplianceChecklist?.() || []);
      
      container.innerHTML = COMPLIANCE_CHECKLIST.map(cat => {
        const items = cat.items.map(item => {
          const dbItem = checklist.find(c => c.id === item.id);
          const completed = dbItem?.completed || false;
          return `
            <div class="checklist-item ${completed ? 'completed' : ''}" onclick="toggleChecklistItem('${item.id}')">
              <div class="checklist-checkbox"></div>
              <div class="checklist-label">${item.label}</div>
            </div>
          `;
        }).join('');
        
        return `
          <div class="checklist-category">
            <div class="category-title">${cat.category}</div>
            ${items}
          </div>
        `;
      }).join('');
    }

    function renderTCPATable() {
      const tbody = document.getElementById('tcpaTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = tcpaConsents.map(consent => {
        const statusClass = consent.status === 'verified' ? 'verified' : 'pending';
        return `
          <tr>
            <td>${consent.leadName}</td>
            <td style="font-family: 'Orbitron';">${consent.phone}</td>
            <td>${consent.date}</td>
            <td>${consent.method}</td>
            <td><span class="status-badge ${statusClass}">${consent.status}</span></td>
          </tr>
        `;
      }).join('');

      // Update stats
      document.getElementById('tcpaTotal').textContent = tcpaConsents.length;
      document.getElementById('tcpaVerified').textContent = tcpaConsents.filter(c => c.status === 'verified').length;
      document.getElementById('tcpaPending').textContent = tcpaConsents.filter(c => c.status === 'pending').length;
    }

    function renderDNCList() {
      const list = document.getElementById('dncList');
      if (!list) return;
      const dncNumbers = window.DebtDB.getDNCList();
      
      document.getElementById('dncCount').textContent = dncNumbers.length;
      
      list.innerHTML = dncNumbers.map(phone => `
        <div class="dnc-item">
          <div class="dnc-phone">${phone}</div>
          <button class="btn btn-danger" onclick="removeDNC('${phone}')">Remove</button>
        </div>
      `).join('');
    }

    function renderAuditLog() {
      const log = document.getElementById('auditLog');
      if (!log) return;
      const entries = window.DebtDB.getAuditLog().slice(0, 20);
      
      log.innerHTML = entries.map(entry => {
        const date = new Date(entry.timestamp);
        return `
          <div class="audit-entry">
            <div class="audit-timestamp">${date.toLocaleString()}</div>
            <div class="audit-action">${formatAuditAction(entry)}</div>
            <div class="audit-user">by ${entry.user}</div>
          </div>
        `;
      }).join('');
    }

    function formatAuditAction(entry) {
      const actions = {
        'dnc_added': `Added ${entry.phone} to DNC list`,
        'dnc_removed': `Removed ${entry.phone} from DNC list`,
        'compliance_updated': `Updated compliance item`,
        'license_updated': `Updated license for ${entry.state}`
      };
      return actions[entry.action] || entry.action;
    }

    function updateComplianceScore() {
      const checklist = (window.DebtDB?.getComplianceChecklist?.() || []);
      const completed = checklist.filter(item => item.completed).length;
      const total = checklist.length;
      const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
      
      // Update gauge
      const gauge = document.getElementById('gaugeCircle');
      if (!gauge) return;
      gauge.style.setProperty('--score-percent', percentage + '%');
      document.getElementById('gaugeValue').textContent = percentage + '%';
      
      // Update status
      const statusEl = document.getElementById('gaugeStatus');
      if (percentage >= 80) {
        statusEl.textContent = '‚úÖ Excellent';
        statusEl.style.color = 'var(--success)';
      } else if (percentage >= 60) {
        statusEl.textContent = '‚ö†Ô∏è Good';
        statusEl.style.color = 'var(--warning)';
      } else {
        statusEl.textContent = 'üî¥ Needs Attention';
        statusEl.style.color = 'var(--danger)';
      }
      
      // Update counts
      document.getElementById('completedCount').textContent = completed;
      document.getElementById('pendingCount').textContent = total - completed;
    }

    function updateExpiringCount() {
      const licenses = window.DebtDB.getLicenses();
      const today = new Date();
      const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
      
      const expiring = licenses.filter(license => {
        if (!license.expiryDate) return false;
        const expiryDate = new Date(license.expiryDate);
        return expiryDate <= thirtyDaysFromNow && expiryDate >= today;
      }).length;
      
      document.getElementById('expiringCount').textContent = expiring;
    }

    function toggleChecklistItem(id) {
      const checklist = (window.DebtDB?.getComplianceChecklist?.() || []);
      const item = checklist.find(c => c.id === id);
      
      if (item) {
        window.DebtDB?.updateComplianceItem?.(id, { completed: !item.completed });
        window.DebtDB.addAuditEntry({ 
          action: 'compliance_updated', 
          data: { item: id, completed: !item.completed }
        });
        renderChecklist();
        updateComplianceScore();
        showToast('Compliance item updated', 'success');
      }
    }

    function openLicenseModal(state) {
      currentLicenseState = state;
      const licenses = window.DebtDB.getLicenses();
      const license = licenses.find(l => l.state === state);
      
      document.getElementById('modalState').textContent = state;
      document.getElementById('licenseNumber').value = license?.licenseNumber || '';
      document.getElementById('licenseExpiry').value = license?.expiryDate || '';
      document.getElementById('licenseStatus').value = license?.status || 'not-required';
      document.getElementById('licenseNotes').value = license?.notes || '';
      
      document.getElementById('licenseModal').classList.add('active');
    }

    function closeLicenseModal() {
      document.getElementById('licenseModal').classList.remove('active');
      currentLicenseState = null;
    }

    function saveLicense() {
      if (!currentLicenseState) return;
      
      const data = {
        licenseNumber: document.getElementById('licenseNumber').value,
        expiryDate: document.getElementById('licenseExpiry').value,
        status: document.getElementById('licenseStatus').value,
        notes: document.getElementById('licenseNotes').value
      };
      
      window.DebtDB.updateLicense(currentLicenseState, data);
      window.DebtDB.addAuditEntry({ 
        action: 'license_updated', 
        state: currentLicenseState,
        data 
      });
      
      renderLicenseGrid();
      renderAuditLog();
      closeLicenseModal();
      showToast(`License updated for ${currentLicenseState}`, 'success');
    }

    function addTCPAConsent() {
      const leadName = document.getElementById('tcpaLeadName').value.trim();
      const phone = document.getElementById('tcpaPhone').value.trim();
      
      if (!leadName || !phone) {
        showToast('Please enter lead name and phone', 'error');
        return;
      }
      
      tcpaConsents.push({
        leadName,
        phone,
        date: new Date().toISOString().split('T')[0],
        method: 'verbal',
        status: 'verified'
      });
      
      localStorage.setItem('tcpa_consents', JSON.stringify(tcpaConsents));
      
      document.getElementById('tcpaLeadName').value = '';
      document.getElementById('tcpaPhone').value = '';
      
      renderTCPATable();
      showToast('TCPA consent recorded', 'success');
    }

    function addDNC() {
      const phone = document.getElementById('dncPhone').value.trim();
      
      if (!phone) {
        showToast('Please enter a phone number', 'error');
        return;
      }
      
      window.DebtDB.addToDNC(phone);
      document.getElementById('dncPhone').value = '';
      renderDNCList();
      renderAuditLog();
      showToast('Added to DNC list', 'success');
    }

    function removeDNC(phone) {
      window.DebtDB.removeFromDNC(phone);
      renderDNCList();
      renderAuditLog();
      showToast('Removed from DNC list', 'success');
    }

    function importDNC() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.csv';
      input.onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
          const csv = event.target.result;
          const lines = csv.split('\n');
          let count = 0;
          lines.forEach(line => {
            const phone = line.trim();
            if (phone) {
              window.DebtDB.addToDNC(phone);
              count++;
            }
          });
          renderDNCList();
          showToast(`Imported ${count} numbers to DNC list`, 'success');
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function generateReport() {
      const checklist = (window.DebtDB?.getComplianceChecklist?.() || []);
      const licenses = window.DebtDB.getLicenses();
      const dncList = window.DebtDB.getDNCList();
      const auditLog = window.DebtDB.getAuditLog();
      
      const completed = checklist.filter(item => item.completed).length;
      const total = checklist.length;
      const percentage = Math.round((completed / total) * 100);
      
      const report = {
        generatedAt: new Date().toISOString(),
        complianceScore: percentage,
        checklist: checklist,
        licenses: licenses,
        dncCount: dncList.length,
        tcpaConsents: tcpaConsents.length,
        auditEntries: auditLog.length,
        operatingStates: OPERATING_STATES,
        summary: {
          totalItems: total,
          completed: completed,
          pending: total - completed,
          activeLicenses: licenses.filter(l => l.status === 'active').length
        }
      };
      
      // Download as JSON
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `compliance-report-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      showToast('Compliance report generated', 'success');
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      
      toastMessage.textContent = message;
      toast.className = `toast toast-${type} active`;
      
      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }

    // Close modal on outside click
    document.getElementById('licenseModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeLicenseModal();
      }
    });

  // Expose functions to window for onclick handlers
  window.addDNC = addDNC;
  window.addTCPAConsent = addTCPAConsent;
  window.closeLicenseModal = closeLicenseModal;
  window.generateReport = generateReport;
  window.importDNC = importDNC;
  window.initializeCompliance = initializeCompliance;
  window.openLicenseModal = openLicenseModal;
  window.removeDNC = removeDNC;
  window.saveLicense = saveLicense;
  window.toggleChecklistItem = toggleChecklistItem;
})();
</script>
