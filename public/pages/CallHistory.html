<!-- CallHistory - SPA Fragment (converted from standalone) -->
<div class="call-history-page p-6 max-w-7xl mx-auto">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-white mb-1">ðŸ“ž Call History</h1>
      <p class="text-gray-400">View and analyze all call records</p>
    </div>
    <button onclick="exportCalls()" class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-xl font-semibold hover:shadow-lg transition-all flex items-center gap-2">
      <i data-lucide="download" class="w-5 h-5"></i>
      Export CSV
    </button>
  </div>

  <!-- Filters -->
  <div class="bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 p-6 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <div>
        <label class="block text-gray-400 text-sm mb-2">Search</label>
        <input type="text" id="searchInput" placeholder="Name or phone..." oninput="applyFilters()" class="w-full px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500">
      </div>
      
      <div>
        <label class="block text-gray-400 text-sm mb-2">Agent</label>
        <select id="filterAgent" onchange="applyFilters()" class="w-full px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500">
          <option value="">All Agents</option>
        </select>
      </div>
      
      <div>
        <label class="block text-gray-400 text-sm mb-2">Call Type</label>
        <select id="filterCallType" onchange="applyFilters()" class="w-full px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500">
          <option value="">All</option>
          <option value="ai">ðŸ¤– AI Calls Only</option>
          <option value="human">ðŸ‘¤ Human Calls Only</option>
        </select>
      </div>
      
      <div>
        <label class="block text-gray-400 text-sm mb-2">Disposition</label>
        <select id="filterDisposition" onchange="applyFilters()" class="w-full px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500">
          <option value="">All</option>
          <option value="Answer">Answer</option>
          <option value="No Answer">No Answer</option>
          <option value="Voicemail">Voicemail</option>
          <option value="Busy">Busy</option>
          <option value="Appointment Set">Appointment Set</option>
        </select>
      </div>
      
      <div>
        <label class="block text-gray-400 text-sm mb-2">Date Range</label>
        <select id="filterDate" onchange="applyFilters()" class="w-full px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500">
          <option value="all">All Time</option>
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Call Table -->
  <div class="bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden mb-8">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b border-slate-700/50">
            <th onclick="sortTable('createdAt')" class="text-left p-4 text-gray-400 font-medium cursor-pointer hover:text-white">
              Date <i data-lucide="chevron-down" class="w-4 h-4 inline"></i>
            </th>
            <th onclick="sortTable('leadName')" class="text-left p-4 text-gray-400 font-medium cursor-pointer hover:text-white">
              Caller <i data-lucide="chevron-down" class="w-4 h-4 inline"></i>
            </th>
            <th onclick="sortTable('agent')" class="text-left p-4 text-gray-400 font-medium cursor-pointer hover:text-white">
              Agent <i data-lucide="chevron-down" class="w-4 h-4 inline"></i>
            </th>
            <th onclick="sortTable('duration')" class="text-left p-4 text-gray-400 font-medium cursor-pointer hover:text-white">
              Duration <i data-lucide="chevron-down" class="w-4 h-4 inline"></i>
            </th>
            <th onclick="sortTable('disposition')" class="text-left p-4 text-gray-400 font-medium cursor-pointer hover:text-white">
              Disposition <i data-lucide="chevron-down" class="w-4 h-4 inline"></i>
            </th>
            <th class="text-left p-4 text-gray-400 font-medium">Recording</th>
          </tr>
        </thead>
        <tbody id="callTableBody">
          <!-- Populated by JS -->
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    <div class="p-4 border-t border-slate-700/50 flex items-center justify-between">
      <div class="text-gray-400 text-sm" id="paginationInfo">Showing 0-0 of 0</div>
      <div class="flex gap-2">
        <button onclick="prevPage()" id="prevBtn" class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed">
          <i data-lucide="chevron-left" class="w-4 h-4"></i>
        </button>
        <button onclick="nextPage()" id="nextBtn" class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed">
          <i data-lucide="chevron-right" class="w-4 h-4"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Call Detail Panel (shown on row click) -->
  <div id="callDetailPanel" class="bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden" style="display: none;">
    <div class="p-6 border-b border-slate-700/50 flex items-center justify-between">
      <h2 class="text-xl font-semibold text-white flex items-center gap-2">
        <i data-lucide="info" class="w-5 h-5 text-blue-400"></i>
        Call Details
      </h2>
      <button onclick="closeDetailPanel()" class="text-gray-400 hover:text-white">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <div class="p-6">
      <div id="callDetailContent">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>
</div>

<script>
(function() {
'use strict';
// Toast Function
  function showToast(msg, type='info') {
    const toast = document.createElement('div');
    const colors = { success: 'bg-emerald-500', error: 'bg-red-500', info: 'bg-blue-500' };
    toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Check DebtDB
  if (!window.DebtDB) {
    showToast('DebtDB not loaded!', 'error');
  }

  let currentPage = 1;
  const perPage = 20;
  let filteredCalls = [];
  let allCalls = []; // Combined real + local calls
  let sortColumn = 'createdAt';
  let sortDirection = 'desc';

  // Load real calls from voice stack, merge with local
  async function loadAllCalls() {
    const localCalls = window.DebtDB ? window.DebtDB.getCalls() : [];
    if (window.VoiceAPI) {
      const voiceCalls = await window.VoiceAPI.fetchCalls(50);
      if (voiceCalls) {
        allCalls = window.VoiceAPI.mergeCalls(voiceCalls, localCalls);
        showToast(`Loaded ${voiceCalls.length} AI calls from voice stack`, 'success');
      } else {
        allCalls = localCalls;
      }
    } else {
      allCalls = localCalls;
    }
    applyFilters();
  }

  function populateAgentFilter() {
    const agents = window.DebtDB ? window.DebtDB.getAgents() : [];
    const select = document.getElementById('filterAgent');
    if (!select) return; // Guard against SPA race condition
    
    select.innerHTML = '<option value="">All Agents</option>' + 
      agents.map(agent => `<option value="${agent.id}">${agent.name}</option>`).join('');
    // Add AI Agent option for voice stack calls
    select.innerHTML += '<option value="ai">ðŸ¤– AI Agent</option>';
  }

  function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const agentFilter = document.getElementById('filterAgent').value;
    const callTypeFilter = document.getElementById('filterCallType').value;
    const dispositionFilter = document.getElementById('filterDisposition').value;
    const dateFilter = document.getElementById('filterDate').value;
    
    let calls = [...allCalls];
    
    // Search filter
    if (search) {
      calls = calls.filter(call => 
        (call.leadName?.toLowerCase().includes(search)) ||
        (call.phone?.toLowerCase().includes(search)) ||
        (call.fromNumber?.toLowerCase().includes(search)) ||
        (call.toNumber?.toLowerCase().includes(search))
      );
    }
    
    // Call Type filter (AI vs Human)
    if (callTypeFilter === 'ai') {
      calls = calls.filter(call => call._source === 'voice-stack');
    } else if (callTypeFilter === 'human') {
      calls = calls.filter(call => call._source !== 'voice-stack');
    }
    
    // Agent filter
    if (agentFilter) {
      calls = calls.filter(call => call.agent === agentFilter || call.agentId === agentFilter);
    }
    
    // Disposition filter
    if (dispositionFilter) {
      calls = calls.filter(call => call.disposition === dispositionFilter);
    }
    
    // Date filter
    if (dateFilter !== 'all') {
      const now = new Date();
      let startDate;
      
      switch (dateFilter) {
        case 'today':
          startDate = new Date(now.setHours(0, 0, 0, 0));
          break;
        case 'week':
          startDate = new Date(now.setDate(now.getDate() - 7));
          break;
        case 'month':
          startDate = new Date(now.setMonth(now.getMonth() - 1));
          break;
      }
      
      calls = calls.filter(call => new Date(call.createdAt) >= startDate);
    }
    
    filteredCalls = calls;
    currentPage = 1;
    renderTable();
  }

  function sortTable(column) {
    if (sortColumn === column) {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      sortColumn = column;
      sortDirection = 'desc';
    }
    
    filteredCalls.sort((a, b) => {
      let aVal = a[column];
      let bVal = b[column];
      
      if (column === 'createdAt') {
        aVal = new Date(aVal);
        bVal = new Date(bVal);
      }
      
      if (sortDirection === 'asc') {
        return aVal > bVal ? 1 : -1;
      } else {
        return aVal < bVal ? 1 : -1;
      }
    });
    
    renderTable();
  }

  function renderTable() {
    const tbody = document.getElementById('callTableBody');
    if (!tbody) return; // Guard against SPA race condition
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    const page = filteredCalls.slice(start, end);
    
    if (page.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">No calls found</td></tr>';
      document.getElementById('paginationInfo').textContent = 'Showing 0-0 of 0';
      document.getElementById('prevBtn').disabled = true;
      document.getElementById('nextBtn').disabled = true;
      return;
    }
    
    tbody.innerHTML = page.map(call => {
      const date = new Date(call.createdAt);
      const dateStr = date.toLocaleDateString();
      const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      const duration = call.duration || Math.floor(Math.random() * 600) + 60;
      const minutes = Math.floor(duration / 60);
      const seconds = duration % 60;
      const durationStr = `${minutes}:${String(seconds).padStart(2, '0')}`;
      
      const dispositionColors = {
        'Answer': 'bg-emerald-500/20 text-emerald-400',
        'No Answer': 'bg-gray-500/20 text-gray-400',
        'Voicemail': 'bg-blue-500/20 text-blue-400',
        'Busy': 'bg-yellow-500/20 text-yellow-400',
        'Appointment Set': 'bg-purple-500/20 text-purple-400'
      };
      
      const isAI = call._source === 'voice-stack';
      const agentName = isAI ? 'ðŸ¤– AI Agent' : (call.agentName || 'Unknown');
      
      return `
        <tr onclick="showCallDetail('${call.id}')" class="border-b border-slate-700/30 hover:bg-slate-800/30 transition-colors cursor-pointer">
          <td class="p-4 text-gray-300">
            <div>${dateStr}</div>
            <div class="text-xs text-gray-500">${timeStr}</div>
          </td>
          <td class="p-4 text-white font-medium">
            <div>${call.leadName || 'Unknown'}</div>
            <div class="text-xs text-gray-400">${call.fromNumber || call.phone || 'N/A'}</div>
          </td>
          <td class="p-4 text-gray-300">${agentName}</td>
          <td class="p-4 text-gray-300 font-mono" style="font-family: 'Orbitron', monospace;">${durationStr}</td>
          <td class="p-4">
            <span class="px-3 py-1 rounded-full text-xs font-semibold ${dispositionColors[call.disposition] || dispositionColors['No Answer']}">
              ${call.disposition || 'No Answer'}
            </span>
          </td>
          <td class="p-4">
            <button class="text-blue-400 hover:text-blue-300" onclick="event.stopPropagation(); playRecording('${call.id}')">
              <i data-lucide="play-circle" class="w-4 h-4"></i>
            </button>
          </td>
        </tr>
      `;
    }).join('');
    
    // Update pagination
    document.getElementById('paginationInfo').textContent = `Showing ${start + 1}-${Math.min(end, filteredCalls.length)} of ${filteredCalls.length}`;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = end >= filteredCalls.length;
    
    if (typeof lucide !== 'undefined' && lucide.createIcons) { try { lucide.createIcons(); } catch(e) { console.warn('[Lucide]', e.message); } }
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      renderTable();
    }
  }

  function nextPage() {
    if ((currentPage * perPage) < filteredCalls.length) {
      currentPage++;
      renderTable();
    }
  }

  function playRecording(callId) {
    const call = filteredCalls.find(c => c.id === callId);
    if (!call) return;
    
    if (call.recording) {
      window.open(call.recording, '_blank');
    } else {
      showToast('No recording available', 'error');
    }
  }

  async function showCallDetail(callId) {
    const call = filteredCalls.find(c => c.id === callId);
    if (!call) return;
    
    const isAI = call._source === 'voice-stack';
    
    // If this is a voice stack call, try to get full detail with analytics
    let analytics = null;
    let transcript = call.transcript || null;
    if (isAI && window.VoiceAPI) {
      const detail = await window.VoiceAPI.fetchCallDetail(call.callSid);
      if (detail) {
        analytics = detail.analytics || null;
        transcript = detail.transcript || transcript;
      }
    }
    if (!transcript) transcript = "No transcript available for this call.";
    
    const date = new Date(call.createdAt);
    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    
    const duration = call.duration || 0;
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    const durationStr = `${minutes}:${String(seconds).padStart(2, '0')}`;
    
    const notes = call.notes || "No notes added.";
    
    // Build 65 Data Points section if AI call
    let aiDataSection = '';
    if (isAI && analytics) {
      const scoreBar = (label, value, max=10) => {
        const pct = Math.min((value / max) * 100, 100);
        return `<div class="mb-2">
          <div class="flex justify-between text-xs mb-1"><span class="text-gray-400">${label}</span><span class="text-cyan-400 font-mono" style="font-family: 'Orbitron', monospace;">${value}/${max}</span></div>
          <div class="h-1.5 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full" style="width:${pct}%"></div></div>
        </div>`;
      };
      
      aiDataSection = `
        <details class="mb-6 bg-cyan-500/10 border border-cyan-500/30 rounded-xl overflow-hidden">
          <summary class="p-4 cursor-pointer hover:bg-cyan-500/20 transition-colors">
            <span class="text-cyan-400 font-semibold">ðŸ¤– AI Call Analysis â€” 65 Data Points</span>
          </summary>
          <div class="p-4 border-t border-cyan-500/30">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-slate-900/50 rounded-xl p-4">
                <div class="text-sm font-semibold text-cyan-400 mb-3">Performance Scores</div>
                ${scoreBar('Overall', analytics.overall_score || 0)}
                ${scoreBar('Energy', analytics.energy_enthusiasm || 0)}
                ${scoreBar('Objection Handling', analytics.objection_handling || 0)}
                ${scoreBar('Closing', analytics.closing_technique || 0)}
                ${scoreBar('Rapport', analytics.rapport_building || 0)}
                ${scoreBar('Compliance', analytics.compliance_score || 0)}
              </div>
              <div class="bg-slate-900/50 rounded-xl p-4 text-sm space-y-2">
                <div class="text-sm font-semibold text-cyan-400 mb-3">Call Insights</div>
                <div><span class="text-gray-400">Sentiment:</span> <span class="text-white">${analytics.call_sentiment || 'N/A'}</span></div>
                <div><span class="text-gray-400">Talk/Listen Ratio:</span> <span class="text-white">${analytics.talk_listen_ratio ? (analytics.talk_listen_ratio * 100).toFixed(0) + '%' : 'N/A'}</span></div>
                <div><span class="text-gray-400">Lead Quality:</span> <span class="text-white">${analytics.lead_quality_score || 'N/A'}</span></div>
                <div><span class="text-gray-400">Close Attempts:</span> <span class="text-white">${analytics.close_attempt_count ?? 'N/A'}</span></div>
                <div><span class="text-gray-400">Close Success:</span> <span class="text-white">${analytics.close_success ? 'Yes' : 'No'}</span></div>
                <div><span class="text-gray-400">Next Action:</span> <span class="text-white">${analytics.recommended_next_action || 'N/A'}</span></div>
                ${analytics.ai_summary ? `<div class="mt-2 pt-2 border-t border-slate-700"><span class="text-gray-400">AI Summary:</span><div class="text-white mt-1">${analytics.ai_summary}</div></div>` : ''}
              </div>
            </div>
          </div>
        </details>`;
    }
    
    const content = document.getElementById('callDetailContent');
    if (!content) return;
    content.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <h3 class="text-white font-semibold mb-3">Call Information</h3>
          <div class="space-y-2 text-sm">
            <div><span class="text-gray-400">Caller:</span> <span class="text-white">${call.leadName || 'Unknown'}</span></div>
            <div><span class="text-gray-400">From:</span> <span class="text-white">${call.fromNumber || call.phone || 'N/A'}</span></div>
            <div><span class="text-gray-400">To:</span> <span class="text-white">${call.toNumber || 'N/A'}</span></div>
            <div><span class="text-gray-400">Agent:</span> <span class="text-white">${isAI ? 'ðŸ¤– AI Agent' : call.agentName || 'Unknown'}</span></div>
            <div><span class="text-gray-400">Direction:</span> <span class="text-white">${call.direction || 'N/A'}</span></div>
            <div><span class="text-gray-400">Date:</span> <span class="text-white">${dateStr}</span></div>
            <div><span class="text-gray-400">Duration:</span> <span class="text-white font-mono" style="font-family: 'Orbitron', monospace;">${durationStr}</span></div>
            <div><span class="text-gray-400">Disposition:</span> <span class="text-white">${call.disposition || 'No Answer'}</span></div>
            ${isAI ? '<div><span class="px-2 py-0.5 bg-cyan-500/20 text-cyan-400 rounded text-xs">AI Call â€” Live Data</span></div>' : ''}
          </div>
        </div>
        
        <div>
          <h3 class="text-white font-semibold mb-3">Recording</h3>
          ${call.recording ? 
            '<audio controls class="w-full"><source src="' + call.recording + '" type="audio/mpeg"></audio>' : 
            '<div class="text-gray-500 text-sm">Recording playback automatic for all calls</div>'
          }
        </div>
      </div>
      
      ${aiDataSection}
      
      <div class="mb-6">
        <h3 class="text-white font-semibold mb-3">Transcript</h3>
        <div class="bg-slate-900/50 rounded-xl p-4 max-h-64 overflow-y-auto text-sm text-gray-300 whitespace-pre-wrap">${transcript}</div>
      </div>
      
      <div>
        <h3 class="text-white font-semibold mb-3">Notes</h3>
        <div class="bg-slate-900/50 rounded-xl p-4 text-sm text-gray-300">${notes}</div>
      </div>
    `;
    
    document.getElementById('callDetailPanel').style.display = 'block';
    if (typeof lucide !== 'undefined' && lucide.createIcons) { try { lucide.createIcons(); } catch(e) { console.warn('[Lucide]', e.message); } }
  }

  function closeDetailPanel() {
    document.getElementById('callDetailPanel').style.display = 'none';
  }

  function exportCalls() {
    const csv = window.DebtDB.export('calls');
    if (!csv) {
      showToast('No calls to export', 'error');
      return;
    }
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `call_history_${Date.now()}.csv`;
    a.click();
    
    showToast('Call history exported!', 'success');
  }

  // Initialize
  let _callHistoryInitialized = false;
  function initCallHistory() {
    if (_callHistoryInitialized) return;
    _callHistoryInitialized = true;
    populateAgentFilter();
    loadAllCalls(); // Fetches real calls, then applies filters
    if (typeof lucide !== 'undefined' && lucide.createIcons) { try { lucide.createIcons(); } catch(e) { console.warn('[Lucide]', e.message); } }
  }

  // MED-8: Direct init (SPA fragment, DOM already loaded)
  initCallHistory();
  window.initCallHistory = initCallHistory;

// ---- Window Exports ----
  window.closeDetailPanel = closeDetailPanel;
  window.exportCalls = exportCalls;
  window.nextPage = nextPage;
  window.prevPage = prevPage;
  window.showCallDetail = showCallDetail;
  window.sortTable = sortTable;
  window.applyFilters = applyFilters;
  window.playRecording = playRecording;
  window.initCallHistory = initCallHistory;
})();
</script>
