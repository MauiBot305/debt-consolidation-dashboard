<div id="callHistory" class="page-container">
  <style>
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      animation: slideInDown 0.5s ease-out;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .filters-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      color: #64748B;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .filter-input, .filter-select {
      padding: 12px 16px;
      background: rgba(10, 15, 26, 0.6);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      color: white;
      font-size: 14px;
      transition: all 0.3s;
    }

    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: #3B82F6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .calls-table-container {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 24px;
      padding: 24px;
      overflow-x: auto;
      animation: fadeInUp 0.7s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .calls-table {
      width: 100%;
      border-collapse: collapse;
    }

    .calls-table thead th {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
      color: #3B82F6;
      font-weight: 600;
      text-align: left;
      padding: 16px;
      border-bottom: 2px solid rgba(59, 130, 246, 0.3);
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 1px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .calls-table tbody tr {
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .calls-table tbody tr:hover {
      background: rgba(59, 130, 246, 0.05);
      transform: translateX(4px);
    }

    .calls-table tbody td {
      padding: 16px;
      color: #E2E8F0;
      font-size: 14px;
    }

    .direction-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .direction-inbound {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.1));
      color: #22C55E;
      border: 1px solid rgba(34, 197, 94, 0.5);
    }

    .direction-outbound {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(59, 130, 246, 0.1));
      color: #3B82F6;
      border: 1px solid rgba(59, 130, 246, 0.5);
    }

    .disposition-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid currentColor;
    }

    .disposition-enrolled {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.1));
      color: #22C55E;
    }

    .disposition-callback {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(245, 158, 11, 0.1));
      color: #F59E0B;
    }

    .disposition-no-answer, .disposition-voicemail {
      background: linear-gradient(135deg, rgba(100, 116, 139, 0.3), rgba(100, 116, 139, 0.1));
      color: #94A3B8;
    }

    .disposition-not-interested {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.1));
      color: #EF4444;
    }

    .recording-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .recording-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
    }

    .recording-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .call-details-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s;
    }

    .call-details-modal.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.95));
      border: 2px solid rgba(59, 130, 246, 0.5);
      border-radius: 24px;
      padding: 32px;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #EF4444;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #EF4444;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: #EF4444;
      color: white;
      transform: rotate(90deg);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
    }

    .detail-label {
      color: #64748B;
      font-weight: 500;
    }

    .detail-value {
      color: white;
      font-weight: 600;
    }

    .export-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #22C55E, #16A34A);
      border: 2px solid #22C55E;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-box {
      background: linear-gradient(135deg, rgba(10, 15, 26, 0.8), rgba(15, 23, 42, 0.8));
      padding: 20px;
      border-radius: 16px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      transition: all 0.3s;
    }

    .stat-box:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.5);
    }

    .stat-label {
      color: #64748B;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .stat-value {
      color: #3B82F6;
      font-size: 28px;
      font-weight: 700;
      font-family: 'Orbitron', monospace;
    }

    .empty-state {
      text-align: center;
      padding: 64px 32px;
      color: #64748B;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .audio-player {
      width: 100%;
      margin-top: 16px;
      background: rgba(10, 15, 26, 0.8);
      border-radius: 12px;
      padding: 8px;
    }
  </style>

  <!-- Header -->
  <div class="history-header">
    <h1 style="color: white; font-weight: 700; margin: 0;">üìû Call History</h1>
    <button class="export-btn" id="exportBtn">
      üìä Export CSV
    </button>
  </div>

  <!-- Stats Summary -->
  <div class="stats-summary">
    <div class="stat-box">
      <div class="stat-label">Total Calls</div>
      <div class="stat-value" id="totalCalls">0</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Total Talk Time</div>
      <div class="stat-value" id="totalTalkTime">0h 0m</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Avg Duration</div>
      <div class="stat-value" id="avgDuration">0:00</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Connect Rate</div>
      <div class="stat-value" id="connectRate">0%</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="filter-group">
      <label class="filter-label">Search</label>
      <input type="text" class="filter-input" id="searchInput" placeholder="Lead name, phone..." style="width: 250px;">
    </div>
    <div class="filter-group">
      <label class="filter-label">Date From</label>
      <input type="date" class="filter-input" id="dateFrom">
    </div>
    <div class="filter-group">
      <label class="filter-label">Date To</label>
      <input type="date" class="filter-input" id="dateTo">
    </div>
    <div class="filter-group">
      <label class="filter-label">Direction</label>
      <select class="filter-select" id="directionFilter">
        <option value="">All</option>
        <option value="inbound">Inbound</option>
        <option value="outbound">Outbound</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Disposition</label>
      <select class="filter-select" id="dispositionFilter">
        <option value="">All</option>
        <option value="enrolled">Enrolled</option>
        <option value="callback">Callback</option>
        <option value="not-interested">Not Interested</option>
        <option value="voicemail">Voicemail</option>
        <option value="no-answer">No Answer</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Agent</label>
      <select class="filter-select" id="agentFilter">
        <option value="">All Agents</option>
        <option value="AGT001">John Smith</option>
        <option value="AGT002">Jane Doe</option>
      </select>
    </div>
  </div>

  <!-- Calls Table -->
  <div class="calls-table-container">
    <table class="calls-table">
      <thead>
        <tr>
          <th>Date/Time</th>
          <th>Direction</th>
          <th>Lead</th>
          <th>Agent</th>
          <th>Duration</th>
          <th>Disposition</th>
          <th>Recording</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="callsTableBody">
        <!-- Populated dynamically -->
      </tbody>
    </table>
    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="empty-state-icon">üìû</div>
      <h3 style="color: #64748B; margin-bottom: 8px;">No calls found</h3>
      <p style="color: #475569;">Try adjusting your filters or start making calls!</p>
    </div>
  </div>

  <!-- Call Details Modal -->
  <div class="call-details-modal" id="callDetailsModal">
    <div class="modal-content" style="position: relative;">
      <button class="modal-close" onclick="closeCallDetails()">√ó</button>
      <h2 style="color: white; margin-bottom: 24px; font-weight: 700;">Call Details</h2>
      <div id="callDetailsContent">
        <!-- Populated dynamically -->
      </div>
    </div>
  </div>

  <script>
    let allCalls = [];
    let filteredCalls = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadCalls();
      setupFilters();
      document.getElementById('exportBtn').addEventListener('click', exportToCSV);
    });

    /**
     * Load calls from localStorage and API
     */
    async function loadCalls() {
      // Get calls from localStorage (simulator + real calls)
      const localCalls = JSON.parse(localStorage.getItem('callHistory') || '[]');
      
      // In production, also fetch from API
      // const apiCalls = await fetchCallsFromAPI();
      
      allCalls = localCalls;
      applyFilters();
      updateStats();
    }

    /**
     * Setup filter event listeners
     */
    function setupFilters() {
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      document.getElementById('dateFrom').addEventListener('change', applyFilters);
      document.getElementById('dateTo').addEventListener('change', applyFilters);
      document.getElementById('directionFilter').addEventListener('change', applyFilters);
      document.getElementById('dispositionFilter').addEventListener('change', applyFilters);
      document.getElementById('agentFilter').addEventListener('change', applyFilters);
    }

    /**
     * Apply filters
     */
    function applyFilters() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const direction = document.getElementById('directionFilter').value;
      const disposition = document.getElementById('dispositionFilter').value;
      const agent = document.getElementById('agentFilter').value;

      filteredCalls = allCalls.filter(call => {
        // Search filter
        if (search) {
          const leadName = call.leadData?.name?.toLowerCase() || '';
          const phone = call.phoneNumber?.toLowerCase() || '';
          if (!leadName.includes(search) && !phone.includes(search)) {
            return false;
          }
        }

        // Date filters
        if (dateFrom) {
          const callDate = new Date(call.startTime).toISOString().split('T')[0];
          if (callDate < dateFrom) return false;
        }
        if (dateTo) {
          const callDate = new Date(call.startTime).toISOString().split('T')[0];
          if (callDate > dateTo) return false;
        }

        // Direction filter
        if (direction && call.direction !== direction) return false;

        // Disposition filter
        if (disposition && call.disposition !== disposition) return false;

        // Agent filter
        if (agent && call.agentId !== agent) return false;

        return true;
      });

      renderCallsTable();
    }

    /**
     * Render calls table
     */
    function renderCallsTable() {
      const tbody = document.getElementById('callsTableBody');
      const emptyState = document.getElementById('emptyState');

      if (filteredCalls.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      tbody.innerHTML = filteredCalls.map(call => {
        const date = new Date(call.startTime);
        const leadName = call.leadData?.name || 'Unknown';
        const direction = call.direction || 'outbound';
        const disposition = call.disposition || 'N/A';
        const duration = formatDuration(call.duration || 0);
        const hasRecording = !!call.recordingUrl;

        return `
          <tr onclick="showCallDetails('${call.id}')">
            <td>${date.toLocaleString()}</td>
            <td>
              <span class="direction-badge direction-${direction}">
                ${direction === 'inbound' ? 'üì•' : 'üì§'} ${direction}
              </span>
            </td>
            <td>
              <div style="font-weight: 600;">${leadName}</div>
              <div style="color: #64748B; font-size: 12px;">${call.phoneNumber || 'N/A'}</div>
            </td>
            <td>${call.agentId || 'N/A'}</td>
            <td>${duration}</td>
            <td>
              <span class="disposition-badge disposition-${disposition.toLowerCase().replace(' ', '-')}">
                ${disposition}
              </span>
            </td>
            <td>
              <button class="recording-btn" ${!hasRecording ? 'disabled' : ''} 
                      onclick="event.stopPropagation(); playRecording('${call.recordingUrl || ''}')">
                ${hasRecording ? '‚ñ∂Ô∏è Play' : 'üö´ N/A'}
              </button>
            </td>
            <td>
              <button class="recording-btn" onclick="event.stopPropagation(); showCallDetails('${call.id}')">
                üìã Details
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    /**
     * Show call details in modal
     */
    function showCallDetails(callId) {
      const call = allCalls.find(c => c.id === callId);
      if (!call) return;

      const modal = document.getElementById('callDetailsModal');
      const content = document.getElementById('callDetailsContent');

      const date = new Date(call.startTime);
      const leadName = call.leadData?.name || 'Unknown';
      const duration = formatDuration(call.duration || 0);

      content.innerHTML = `
        <div class="detail-row">
          <span class="detail-label">Call ID</span>
          <span class="detail-value">${call.id}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Date/Time</span>
          <span class="detail-value">${date.toLocaleString()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Direction</span>
          <span class="detail-value">${call.direction || 'outbound'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Lead</span>
          <span class="detail-value">${leadName}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Phone</span>
          <span class="detail-value">${call.phoneNumber || 'N/A'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Agent</span>
          <span class="detail-value">${call.agentId || 'N/A'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Duration</span>
          <span class="detail-value">${duration}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Disposition</span>
          <span class="detail-value">${call.disposition || 'N/A'}</span>
        </div>
        ${call.notes ? `
          <div style="margin-top: 20px;">
            <div class="detail-label" style="margin-bottom: 8px;">Notes:</div>
            <div style="background: rgba(10, 15, 26, 0.6); padding: 16px; border-radius: 12px; color: #E2E8F0; line-height: 1.6;">
              ${call.notes}
            </div>
          </div>
        ` : ''}
        ${call.recordingUrl ? `
          <div style="margin-top: 20px;">
            <div class="detail-label" style="margin-bottom: 8px;">Recording:</div>
            <audio controls class="audio-player" src="${call.recordingUrl}"></audio>
          </div>
        ` : ''}
      `;

      modal.classList.add('active');
    }

    /**
     * Close call details modal
     */
    window.closeCallDetails = function() {
      document.getElementById('callDetailsModal').classList.remove('active');
    };

    /**
     * Play recording
     */
    function playRecording(url) {
      if (!url) return;
      // In production, fetch from Twilio or R2 storage
      Toast.info('Recording playback coming soon');
    }

    /**
     * Update stats
     */
    function updateStats() {
      const totalCalls = allCalls.length;
      const totalSeconds = allCalls.reduce((sum, c) => sum + (c.duration || 0), 0);
      const avgSeconds = totalCalls > 0 ? Math.round(totalSeconds / totalCalls) : 0;
      const connectedCalls = allCalls.filter(c => c.status === 'completed' || c.duration > 0).length;
      const connectRate = totalCalls > 0 ? Math.round((connectedCalls / totalCalls) * 100) : 0;

      document.getElementById('totalCalls').textContent = totalCalls;
      
      const hours = Math.floor(totalSeconds / 3600);
      const mins = Math.floor((totalSeconds % 3600) / 60);
      document.getElementById('totalTalkTime').textContent = `${hours}h ${mins}m`;
      
      document.getElementById('avgDuration').textContent = formatDuration(avgSeconds);
      document.getElementById('connectRate').textContent = `${connectRate}%`;
    }

    /**
     * Format duration
     */
    function formatDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    /**
     * Export to CSV
     */
    function exportToCSV() {
      if (filteredCalls.length === 0) {
        Toast.warning('No calls to export');
        return;
      }

      const headers = ['Date/Time', 'Direction', 'Lead', 'Phone', 'Agent', 'Duration (s)', 'Disposition', 'Notes'];
      const rows = filteredCalls.map(call => [
        new Date(call.startTime).toLocaleString(),
        call.direction || 'outbound',
        call.leadData?.name || 'Unknown',
        call.phoneNumber || '',
        call.agentId || '',
        call.duration || 0,
        call.disposition || '',
        (call.notes || '').replace(/"/g, '""') // Escape quotes
      ]);

      const csv = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `call-history-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      Toast.success('Call history exported!');
    }

    // Close modal on background click
    document.getElementById('callDetailsModal').addEventListener('click', (e) => {
      if (e.target.id === 'callDetailsModal') {
        closeCallDetails();
      }
    });
  </script>
</div>
