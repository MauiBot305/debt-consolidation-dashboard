<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Sales Coach</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-950">
<div class="ai-coach-page p-6 max-w-7xl mx-auto">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-white mb-1">üß† AI Sales Coach</h1>
    <p class="text-gray-400">Analyze calls, practice scenarios, and improve your close rate</p>
  </div>

  <!-- Tab Navigation -->
  <div class="flex gap-2 mb-6 border-b border-slate-700 overflow-x-auto">
    <button onclick="switchTab('chat')" id="tabChat" class="px-6 py-3 text-white font-semibold border-b-2 border-blue-500 whitespace-nowrap">Chat</button>
    <button onclick="switchTab('callAnalysis')" id="tabCallAnalysis" class="px-6 py-3 text-gray-400 hover:text-white whitespace-nowrap">Call Analysis</button>
    <button onclick="switchTab('aiInsights')" id="tabAiInsights" class="px-6 py-3 text-gray-400 hover:text-white whitespace-nowrap">ü§ñ AI Agent Insights</button>
    <button onclick="switchTab('scripts')" id="tabScripts" class="px-6 py-3 text-gray-400 hover:text-white whitespace-nowrap">Scripts</button>
    <button onclick="switchTab('objections')" id="tabObjections" class="px-6 py-3 text-gray-400 hover:text-white whitespace-nowrap">Objections</button>
    <button onclick="switchTab('training')" id="tabTraining" class="px-6 py-3 text-gray-400 hover:text-white whitespace-nowrap">Training</button>
  </div>

  <!-- Chat Tab -->
  <div id="chatTab" class="tab-content">
    <div class="bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden">
      <div class="p-6 border-b border-slate-700/50">
        <h2 class="text-xl font-semibold text-white flex items-center gap-2">
          <i data-lucide="message-circle" class="w-5 h-5 text-blue-400"></i>
          AI Coach Chat
        </h2>
      </div>
      <div class="p-6">
        <div id="chatMessages" class="h-96 overflow-y-auto mb-4 space-y-3 bg-slate-900/50 rounded-xl p-4">
          <div class="text-gray-500 text-center text-sm">Ask me anything about sales, objection handling, or scripts!</div>
        </div>
        <div class="flex gap-2">
          <input type="text" id="chatInput" placeholder="Ask a question..." class="flex-1 px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white focus:outline-none focus:border-blue-500" onkeypress="if(event.key==='Enter') sendChatMessage()">
          <button onclick="sendChatMessage()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl hover:shadow-lg transition-all">
            <i data-lucide="send" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Call Analysis Tab -->
  <div id="callAnalysisTab" class="tab-content" style="display: none;">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden">
        <div class="p-6 border-b border-slate-700/50">
          <h2 class="text-xl font-semibold text-white">Select Call</h2>
        </div>
        <div class="p-6">
          <select id="callSelector" onchange="analyzeCall()" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white focus:outline-none focus:border-blue-500">
            <option value="">Choose a recent call...</option>
          </select>
        </div>
      </div>
      
      <div id="callScoring" class="bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden" style="display: none;">
        <div class="p-6 border-b border-slate-700/50">
          <h2 class="text-xl font-semibold text-white">Performance Analysis</h2>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <div class="flex justify-between mb-2">
              <span class="text-gray-400 text-sm">Energy</span>
              <span id="scoreEnergy" class="text-blue-400 font-mono font-bold" style="font-family: 'Orbitron', monospace;">0/10</span>
            </div>
            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
              <div id="barEnergy" class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full transition-all" style="width: 0%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-2">
              <span class="text-gray-400 text-sm">Objection Handling</span>
              <span id="scoreObjection" class="text-blue-400 font-mono font-bold" style="font-family: 'Orbitron', monospace;">0/10</span>
            </div>
            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
              <div id="barObjection" class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full transition-all" style="width: 0%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-2">
              <span class="text-gray-400 text-sm">Closing</span>
              <span id="scoreClosing" class="text-blue-400 font-mono font-bold" style="font-family: 'Orbitron', monospace;">0/10</span>
            </div>
            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
              <div id="barClosing" class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full transition-all" style="width: 0%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-2">
              <span class="text-gray-400 text-sm">Rapport</span>
              <span id="scoreRapport" class="text-blue-400 font-mono font-bold" style="font-family: 'Orbitron', monospace;">0/10</span>
            </div>
            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
              <div id="barRapport" class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full transition-all" style="width: 0%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-2">
              <span class="text-gray-400 text-sm">Compliance</span>
              <span id="scoreCompliance" class="text-blue-400 font-mono font-bold" style="font-family: 'Orbitron', monospace;">0/10</span>
            </div>
            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
              <div id="barCompliance" class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full transition-all" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="callTranscript" class="mt-6 bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden" style="display: none;">
      <div class="p-6 border-b border-slate-700/50">
        <h2 class="text-xl font-semibold text-white">Call Transcript</h2>
      </div>
      <div class="p-6">
        <div id="transcriptContent" class="space-y-2 max-h-96 overflow-y-auto">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- AI Agent Insights Tab (NEW) -->
  <div id="aiInsightsTab" class="tab-content" style="display: none;">
    <div class="bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden mb-6">
      <div class="p-6 border-b border-slate-700/50">
        <h2 class="text-xl font-semibold text-white flex items-center gap-2">
          <i data-lucide="bot" class="w-5 h-5 text-cyan-400"></i>
          AI Agent Coaching Insights
        </h2>
        <p class="text-gray-400 text-sm mt-2">Monitor and improve the AI agent's performance alongside human agents</p>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-4">
            <div class="text-cyan-400 text-sm font-semibold mb-2">üìä AI Agent Stats</div>
            <div class="space-y-2 text-sm">
              <div><span class="text-gray-400">Calls Handled:</span> <span class="text-white" id="aiTotalCalls">0</span></div>
              <div><span class="text-gray-400">Avg Call Duration:</span> <span class="text-white" id="aiAvgDuration">0:00</span></div>
              <div><span class="text-gray-400">Success Rate:</span> <span class="text-white" id="aiSuccessRate">0%</span></div>
              <div><span class="text-gray-400">Avg Score:</span> <span class="text-white" id="aiAvgScore">0/10</span></div>
            </div>
          </div>
          
          <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
            <div class="text-yellow-400 text-sm font-semibold mb-2">‚ùå Common Objections</div>
            <div id="commonObjections" class="space-y-1 text-sm text-white">
              <!-- Populated by JS -->
            </div>
          </div>
          
          <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-4">
            <div class="text-purple-400 text-sm font-semibold mb-2">üìà Sentiment Trends</div>
            <div id="sentimentTrends" class="space-y-2">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
        
        <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-6 mb-6">
          <h3 class="text-emerald-400 font-semibold mb-4">‚ú® Suggested Script Improvements</h3>
          <div id="scriptImprovements" class="space-y-3">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-slate-900/50 rounded-xl p-4">
            <h3 class="text-white font-semibold mb-3">üéØ Training Priorities for AI</h3>
            <div id="aiTrainingPriorities" class="space-y-2">
              <!-- Populated by JS -->
            </div>
          </div>
          
          <div class="bg-slate-900/50 rounded-xl p-4">
            <h3 class="text-white font-semibold mb-3">üîÑ Recent AI Improvements</h3>
            <div id="recentImprovements" class="space-y-2 text-sm text-gray-300">
              <div class="flex items-start gap-2">
                <span class="text-green-400">‚úì</span>
                <span>Improved objection detection accuracy by 15%</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-green-400">‚úì</span>
                <span>Reduced average call drop rate from 8% to 3%</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-green-400">‚úì</span>
                <span>Enhanced empathy responses in debt scenarios</span>
              </div>
              <div class="flex items-start gap-2">
                <span class="text-green-400">‚úì</span>
                <span>Added 12 new closing techniques to rotation</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts Tab -->
  <div id="scriptsTab" class="tab-content" style="display: none;">
    <div class="bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden">
      <div class="p-6 border-b border-slate-700/50">
        <h2 class="text-xl font-semibold text-white">Script Generator</h2>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <label class="block text-gray-400 text-sm mb-2">Select Scenario</label>
          <select id="scenarioSelector" onchange="loadScript()" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white focus:outline-none focus:border-blue-500">
            <option value="">Choose a scenario...</option>
            <option value="cold_call">Cold Call</option>
            <option value="follow_up">Follow Up</option>
            <option value="objection">Handling Objections</option>
            <option value="closing">Closing the Deal</option>
            <option value="referral">Asking for Referrals</option>
          </select>
        </div>
        
        <div id="scriptContent" class="bg-slate-900/50 rounded-xl p-6 min-h-64">
          <div class="text-gray-500 text-center">Select a scenario to view the script</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Objections Tab -->
  <div id="objectionsTab" class="tab-content" style="display: none;">
    <div class="bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden">
      <div class="p-6 border-b border-slate-700/50">
        <h2 class="text-xl font-semibold text-white">Objection Handler</h2>
      </div>
      <div class="p-6">
        <div class="mb-6">
          <input type="text" id="objectionSearch" placeholder="Search objections..." class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white focus:outline-none focus:border-blue-500" oninput="filterObjections()">
        </div>
        
        <div id="objectionsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Training Tab -->
  <div id="trainingTab" class="tab-content" style="display: none;">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden">
        <div class="p-6 border-b border-slate-700/50">
          <h2 class="text-xl font-semibold text-white">Training Modules</h2>
        </div>
        <div class="p-6">
          <div id="trainingModules" class="space-y-3">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
      
      <div class="bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden">
        <div class="p-6 border-b border-slate-700/50">
          <h2 class="text-xl font-semibold text-white">Performance Tips</h2>
        </div>
        <div class="p-6">
          <div id="performanceTips" class="space-y-3">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
'use strict';
// Toast Function
  function showToast(msg, type='info') {
    const toast = document.createElement('div');
    const colors = { success: 'bg-emerald-500', error: 'bg-red-500', info: 'bg-blue-500' };
    toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Check DebtDB
  if (!window.DebtDB) {
    showToast('DebtDB not loaded!', 'error');
  }

  // Tab Switching
  function switchTab(tab) {
    ['chat', 'callAnalysis', 'aiInsights', 'scripts', 'objections', 'training'].forEach(t => {
      const tabEl = document.getElementById(t + 'Tab');
      if (tabEl) tabEl.style.display = t === tab ? 'block' : 'none';
      
      const btnId = 'tab' + t.charAt(0).toUpperCase() + t.slice(1);
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.className = t === tab 
          ? 'px-6 py-3 text-white font-semibold border-b-2 border-blue-500 whitespace-nowrap'
          : 'px-6 py-3 text-gray-400 hover:text-white whitespace-nowrap';
      }
    });
    
    // Load AI insights when tab is opened
    if (tab === 'aiInsights') {
      renderAIInsights();
    }
  }

  // Chat Functionality
  const chatResponses = {
    'how do i handle objections': 'Great question! The key to handling objections is to listen carefully, acknowledge the concern, and reframe it. For example: "I understand cost is a concern. Let me show you how this actually saves you money in the long run..."',
    'what is a good opening': 'A strong opening builds rapport quickly: "Hi [Name], this is [Your Name] from Debt Relief Pro. I know you\'re busy, so I\'ll be brief. We help people like you reduce their debt by up to 50%. Do you have 2 minutes?"',
    'how do i close': 'The assumptive close works best: "Great! Let\'s get your enrollment started. I have an opening at 2pm today or 10am tomorrow ‚Äî which works better for you?"',
    default: 'That\'s a great question! Based on your performance data, I recommend focusing on active listening and asking open-ended questions. Would you like specific examples?'
  };

  function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;
    
    const container = document.getElementById('chatMessages');
    
    // User message
    const userMsg = document.createElement('div');
    userMsg.className = 'flex justify-end';
    userMsg.innerHTML = `<div class="bg-blue-500 text-white px-4 py-2 rounded-xl max-w-md">${message}</div>`;
    container.appendChild(userMsg);
    
    input.value = '';
    
    // AI response (simulated)
    setTimeout(() => {
      const aiMsg = document.createElement('div');
      aiMsg.className = 'flex justify-start';
      const response = chatResponses[message.toLowerCase()] || chatResponses.default;
      aiMsg.innerHTML = `<div class="bg-slate-700 text-white px-4 py-2 rounded-xl max-w-md">${response}</div>`;
      container.appendChild(aiMsg);
      container.scrollTop = container.scrollHeight;
    }, 500);
  }

  // Call Analysis ‚Äî merged real + local calls
  let allCoachCalls = [];

  async function populateCallSelector() {
    const localCalls = window.DebtDB ? window.DebtDB.getCalls() : [];
    let voiceCalls = [];
    if (window.VoiceAPI) {
      const fetched = await window.VoiceAPI.fetchCalls(30);
      if (fetched) voiceCalls = fetched;
    }
    allCoachCalls = window.VoiceAPI ? window.VoiceAPI.mergeCalls(voiceCalls, localCalls) : localCalls;
    
    const selector = document.getElementById('callSelector');
    selector.innerHTML = '<option value="">Choose a recent call...</option>' + 
      allCoachCalls.slice(0, 30).map(call => {
        const src = call._source === 'voice-stack' ? 'üü¢' : '‚ö™';
        return `<option value="${call.id}">${src} ${call.leadName || call.fromNumber || 'Unknown'} - ${new Date(call.createdAt).toLocaleDateString()} (${call.disposition})</option>`;
      }).join('');
  }

  async function analyzeCall() {
    const callId = document.getElementById('callSelector').value;
    if (!callId) {
      document.getElementById('callScoring').style.display = 'none';
      document.getElementById('callTranscript').style.display = 'none';
      if (document.getElementById('coachInsights')) document.getElementById('coachInsights').style.display = 'none';
      return;
    }
    
    const call = allCoachCalls.find(c => c.id === callId);
    if (!call) return;
    
    let scores, transcript, analytics = null;
    
    // If voice stack call, fetch real analytics
    if (call._source === 'voice-stack' && window.VoiceAPI) {
      const detail = await window.VoiceAPI.fetchCallDetail(call.callSid);
      if (detail && detail.analytics) {
        analytics = detail.analytics;
        scores = {
          energy: analytics.energy_enthusiasm || 0,
          objection: analytics.objection_handling || 0,
          closing: analytics.closing_technique || 0,
          rapport: analytics.rapport_building || 0,
          compliance: analytics.compliance_score || 0
        };
        transcript = detail.transcript || call.transcript;
      }
    }
    
    // Fallback to simulated scores if no real analytics
    if (!scores) {
      scores = {
        energy: Math.floor(Math.random() * 4) + 7,
        objection: Math.floor(Math.random() * 3) + 6,
        closing: Math.floor(Math.random() * 4) + 6,
        rapport: Math.floor(Math.random() * 3) + 7,
        compliance: Math.floor(Math.random() * 2) + 8
      };
    }
    if (!transcript) {
      transcript = call.transcript || "Agent: Hello, this is calling from Debt Relief Pro.\nLead: Hi.\nAgent: How are you today?\nLead: Good, what's this about?\nAgent: We help people reduce their debt by up to 50%. Do you currently have any credit card debt?\nLead: Yeah, about $15,000.\nAgent: Great, we can definitely help with that. When would be a good time to discuss your options?";
    }
    
    // Render scores
    document.getElementById('scoreEnergy').textContent = scores.energy + '/10';
    document.getElementById('barEnergy').style.width = (scores.energy * 10) + '%';
    document.getElementById('scoreObjection').textContent = scores.objection + '/10';
    document.getElementById('barObjection').style.width = (scores.objection * 10) + '%';
    document.getElementById('scoreClosing').textContent = scores.closing + '/10';
    document.getElementById('barClosing').style.width = (scores.closing * 10) + '%';
    document.getElementById('scoreRapport').textContent = scores.rapport + '/10';
    document.getElementById('barRapport').style.width = (scores.rapport * 10) + '%';
    document.getElementById('scoreCompliance').textContent = scores.compliance + '/10';
    document.getElementById('barCompliance').style.width = (scores.compliance * 10) + '%';
    document.getElementById('callScoring').style.display = 'block';
    
    // Transcript
    document.getElementById('transcriptContent').innerHTML = transcript.split('\n').map(line => {
      const isAgent = line.startsWith('Agent:') || line.startsWith('AI:');
      return `<div class="${isAgent ? 'text-blue-400' : 'text-gray-300'}">${line}</div>`;
    }).join('');
    document.getElementById('callTranscript').style.display = 'block';
    
    // Render coaching insights from real analytics
    renderCoachInsights(analytics);
  }
  
  function renderCoachInsights(analytics) {
    let insightsEl = document.getElementById('coachInsights');
    if (!insightsEl) {
      // Create insights panel after transcript
      insightsEl = document.createElement('div');
      insightsEl.id = 'coachInsights';
      insightsEl.className = 'mt-6 bg-slate-800/30 backdrop-blur-sm rounded-2xl border border-slate-700/50 overflow-hidden';
      document.getElementById('callTranscript').after(insightsEl);
    }
    
    if (!analytics) {
      insightsEl.style.display = 'none';
      return;
    }
    insightsEl.style.display = 'block';
    
    // Parse JSON fields
    let keyQuotes = analytics.key_quotes;
    if (typeof keyQuotes === 'string') { try { keyQuotes = JSON.parse(keyQuotes); } catch(e) { keyQuotes = []; } }
    let trainingTopics = analytics.training_topics;
    if (typeof trainingTopics === 'string') { try { trainingTopics = JSON.parse(trainingTopics); } catch(e) { trainingTopics = []; } }
    let objections = analytics.objections_raised;
    if (typeof objections === 'string') { try { objections = JSON.parse(objections); } catch(e) { objections = []; } }
    
    insightsEl.innerHTML = `
      <div class="p-6 border-b border-slate-700/50">
        <h2 class="text-xl font-semibold text-white flex items-center gap-2">üß† AI Coaching Insights</h2>
      </div>
      <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-cyan-400 font-semibold mb-3">üìä Overall Score: ${analytics.overall_score || 'N/A'}/10</h3>
          <div class="space-y-2 text-sm">
            <div><span class="text-gray-400">Sentiment:</span> <span class="text-white">${analytics.call_sentiment || 'N/A'}</span></div>
            <div><span class="text-gray-400">Sentiment Trajectory:</span> <span class="text-white">${analytics.sentiment_trajectory || 'N/A'}</span></div>
            <div><span class="text-gray-400">Lead Quality:</span> <span class="text-white">${analytics.lead_quality_score || 'N/A'}</span></div>
            <div><span class="text-gray-400">Enrollment Likelihood:</span> <span class="text-white">${analytics.enrollment_likelihood ? (analytics.enrollment_likelihood * 100).toFixed(0) + '%' : 'N/A'}</span></div>
            <div><span class="text-gray-400">Coaching Priority:</span> <span class="text-white">${analytics.coaching_priority || 'N/A'}</span></div>
          </div>
          
          ${analytics.recommended_next_action ? `
          <div class="mt-4 p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-xl">
            <div class="text-emerald-400 font-semibold text-sm mb-1">üéØ Recommended Next Action</div>
            <div class="text-white text-sm">${analytics.recommended_next_action}</div>
          </div>` : ''}
          
          ${analytics.ai_summary ? `
          <div class="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-xl">
            <div class="text-blue-400 font-semibold text-sm mb-1">üìù AI Summary</div>
            <div class="text-white text-sm">${analytics.ai_summary}</div>
          </div>` : ''}
        </div>
        
        <div>
          ${Array.isArray(keyQuotes) && keyQuotes.length ? `
          <div class="mb-4">
            <h4 class="text-yellow-400 font-semibold text-sm mb-2">üí¨ Key Quotes</h4>
            <div class="space-y-2">${keyQuotes.map(q => `<div class="bg-slate-900/50 rounded-lg p-2 text-sm text-gray-300 italic">"${q}"</div>`).join('')}</div>
          </div>` : ''}
          
          ${Array.isArray(trainingTopics) && trainingTopics.length ? `
          <div class="mb-4">
            <h4 class="text-purple-400 font-semibold text-sm mb-2">üìö Training Topics</h4>
            <div class="flex flex-wrap gap-2">${trainingTopics.map(t => `<span class="px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full text-xs">${t}</span>`).join('')}</div>
          </div>` : ''}
          
          ${Array.isArray(objections) && objections.length ? `
          <div class="mb-4">
            <h4 class="text-red-400 font-semibold text-sm mb-2">‚ùå Objections Raised</h4>
            <div class="flex flex-wrap gap-2">${objections.map(o => `<span class="px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-xs">${o}</span>`).join('')}</div>
          </div>` : ''}
        </div>
      </div>
    `;
  }

  // AI Insights Tab
  async function renderAIInsights() {
    if (!window.VoiceAPI) {
      showToast('Voice API not available', 'error');
      return;
    }
    
    const aiCalls = await window.VoiceAPI.fetchCalls(50);
    if (!aiCalls || aiCalls.length === 0) {
      showToast('No AI call data available yet', 'info');
      return;
    }
    
    // Fetch analytics for recent calls
    const detailPromises = aiCalls.slice(0, 20).map(c => window.VoiceAPI.fetchCallDetail(c.callSid));
    const details = (await Promise.all(detailPromises)).filter(d => d && d.analytics);
    const analytics = details.map(d => d.analytics);
    
    if (analytics.length === 0) {
      showToast('No analytics available for AI calls', 'info');
      return;
    }
    
    // AI Agent Stats
    const totalDuration = aiCalls.reduce((sum, c) => sum + (c.duration || 0), 0);
    const avgDuration = totalDuration / aiCalls.length;
    const avgMins = Math.floor(avgDuration / 60);
    const avgSecs = Math.floor(avgDuration % 60);
    
    const successCalls = aiCalls.filter(c => c.disposition === 'Answer' || c.disposition === 'Appointment Set').length;
    const successRate = (successCalls / aiCalls.length) * 100;
    
    const avgScore = analytics.reduce((sum, a) => sum + (a.overall_score || 0), 0) / analytics.length;
    
    document.getElementById('aiTotalCalls').textContent = aiCalls.length;
    document.getElementById('aiAvgDuration').textContent = `${avgMins}:${String(avgSecs).padStart(2, '0')}`;
    document.getElementById('aiSuccessRate').textContent = successRate.toFixed(1) + '%';
    document.getElementById('aiAvgScore').textContent = avgScore.toFixed(1) + '/10';
    
    // Common Objections
    const objectionCounts = {};
    analytics.forEach(a => {
      let objs = a.objections_raised;
      if (typeof objs === 'string') { try { objs = JSON.parse(objs); } catch(e) { objs = []; } }
      if (Array.isArray(objs)) {
        objs.forEach(o => { objectionCounts[o] = (objectionCounts[o] || 0) + 1; });
      }
    });
    const topObjections = Object.entries(objectionCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
    document.getElementById('commonObjections').innerHTML = topObjections.length ? 
      topObjections.map(([obj, count]) => `<div>${obj} <span class="text-gray-500">(${count})</span></div>`).join('') :
      '<div class="text-gray-500">No objections tracked yet</div>';
    
    // Sentiment Trends
    const sentimentCounts = { positive: 0, neutral: 0, negative: 0 };
    analytics.forEach(a => {
      const sent = (a.call_sentiment || 'neutral').toLowerCase();
      if (sentimentCounts[sent] !== undefined) sentimentCounts[sent]++;
    });
    const maxSent = Math.max(...Object.values(sentimentCounts), 1);
    document.getElementById('sentimentTrends').innerHTML = Object.entries(sentimentCounts).map(([sent, count]) => {
      const pct = (count / maxSent) * 100;
      const color = sent === 'positive' ? 'emerald' : sent === 'negative' ? 'red' : 'gray';
      return `<div>
        <div class="flex justify-between text-xs mb-1"><span class="text-gray-400 capitalize">${sent}</span><span class="text-white">${count}</span></div>
        <div class="h-2 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-${color}-500 rounded-full" style="width:${pct}%"></div></div>
      </div>`;
    }).join('');
    
    // Script Improvements (simulated based on common patterns)
    const improvements = [
      { title: 'Opening Hook', suggestion: 'Start with empathy: "I know dealing with debt can be overwhelming..."', priority: 'High' },
      { title: 'Objection: Too Expensive', suggestion: 'Reframe cost as savings: "This program actually reduces what you\'re paying now by 40%..."', priority: 'Medium' },
      { title: 'Closing Technique', suggestion: 'Use assumptive close more often: "Let me get your enrollment started..."', priority: 'High' }
    ];
    document.getElementById('scriptImprovements').innerHTML = improvements.map(imp => {
      const color = imp.priority === 'High' ? 'red' : imp.priority === 'Medium' ? 'yellow' : 'blue';
      return `<div class="bg-slate-900/50 rounded-lg p-3">
        <div class="flex items-center justify-between mb-2">
          <span class="text-white font-semibold text-sm">${imp.title}</span>
          <span class="px-2 py-0.5 bg-${color}-500/20 text-${color}-400 rounded text-xs">${imp.priority}</span>
        </div>
        <div class="text-gray-300 text-sm">${imp.suggestion}</div>
      </div>`;
    }).join('');
    
    // Training Priorities
    const allTrainingTopics = [];
    analytics.forEach(a => {
      let topics = a.training_topics;
      if (typeof topics === 'string') { try { topics = JSON.parse(topics); } catch(e) { topics = []; } }
      if (Array.isArray(topics)) allTrainingTopics.push(...topics);
    });
    const topicCounts = {};
    allTrainingTopics.forEach(t => { topicCounts[t] = (topicCounts[t] || 0) + 1; });
    const topTopics = Object.entries(topicCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
    document.getElementById('aiTrainingPriorities').innerHTML = topTopics.length ?
      topTopics.map(([topic, count]) => `<div class="flex items-center justify-between text-sm">
        <span class="text-gray-300">${topic}</span>
        <span class="text-cyan-400 font-semibold">${count}x</span>
      </div>`).join('') :
      '<div class="text-gray-500 text-sm">No training priorities identified yet</div>';
  }

  // Scripts
  const scripts = {
    cold_call: `<strong>Opening:</strong><br>"Hi [Name], this is [Your Name] from Debt Relief Pro. I know you're busy, so I'll be brief."<br><br><strong>Hook:</strong><br>"We help people reduce their debt by up to 50% without filing for bankruptcy. Do you currently have any credit card or personal loan debt?"<br><br><strong>Qualification:</strong><br>"How much total debt are you carrying right now?"<br>"What are your monthly minimum payments?"<br>"Have you missed any payments recently?"`,
    
    follow_up: `<strong>Opening:</strong><br>"Hi [Name], it's [Your Name] from Debt Relief Pro. We spoke last [day/week] about your debt situation."<br><br><strong>Callback:</strong><br>"You mentioned you had about $[amount] in debt. I wanted to follow up because we just had a spot open up in our program."<br><br><strong>Close:</strong><br>"Are you ready to get started today?"`,
    
    objection: `<strong>"I need to think about it"</strong><br>"I totally understand. What specifically would you like to think about? Is it the timeline, the cost, or something else?"<br><br><strong>"It's too expensive"</strong><br>"I hear you. But consider this ‚Äî you're currently paying [X] per month in minimums. Our program gets you debt-free in 2-4 years instead of 20+. Which saves you money?"<br><br><strong>"I need to talk to my spouse"</strong><br>"Absolutely! Can we set up a quick call with both of you? I'm free today at 2pm or tomorrow at 10am."`,
    
    closing: `<strong>Assumptive Close:</strong><br>"Great! Let's get your enrollment started. I have an opening at 2pm today or 10am tomorrow ‚Äî which works better?"<br><br><strong>Alternative Close:</strong><br>"Would you prefer to start with the 3-year plan or the 4-year plan?"<br><br><strong>Urgency Close:</strong><br>"We only have 2 spots left this month, and I'd hate for you to miss out. Can we lock you in today?"`,
    
    referral: `<strong>After Success:</strong><br>"I'm so glad we could help you! Do you know anyone else struggling with debt who might benefit from our program?"<br><br><strong>Specific Ask:</strong><br>"Who in your family or friend circle has mentioned credit card debt to you?"<br><br><strong>Incentive:</strong><br>"For every referral who enrolls, we'll give you a $50 Visa gift card as a thank you."`
  };

  function loadScript() {
    const scenario = document.getElementById('scenarioSelector').value;
    const content = document.getElementById('scriptContent');
    
    if (!scenario) {
      content.innerHTML = '<div class="text-gray-500 text-center">Select a scenario to view the script</div>';
      return;
    }
    
    content.innerHTML = `<div class="text-white space-y-4">${scripts[scenario]}</div>`;
  }

  // Objections
  const objections = [
    { objection: "I need to think about it", rebuttal: "I understand. What specifically would you like to think about?" },
    { objection: "It's too expensive", rebuttal: "Compared to 20 years of minimum payments, this actually saves you money." },
    { objection: "I need to talk to my spouse", rebuttal: "Great! Can we schedule a call with both of you?" },
    { objection: "I'm not interested", rebuttal: "I totally get it. Can I ask ‚Äî are you not interested in reducing your debt, or just not sure about our program?" },
    { objection: "Call me back later", rebuttal: "Absolutely. What day/time works best for you?" },
    { objection: "I'll do it myself", rebuttal: "That's admirable! Have you tried negotiating with creditors before?" }
  ];

  function filterObjections() {
    renderObjections();
  }

  function renderObjections() {
    const search = document.getElementById('objectionSearch').value.toLowerCase();
    const filtered = objections.filter(o => 
      o.objection.toLowerCase().includes(search) || 
      o.rebuttal.toLowerCase().includes(search)
    );
    
    const grid = document.getElementById('objectionsGrid');
    grid.innerHTML = filtered.map(o => `
      <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 hover:border-blue-500/50 transition-all">
        <div class="text-red-400 font-semibold mb-2">‚ùå "${o.objection}"</div>
        <div class="text-emerald-400 text-sm">‚úÖ ${o.rebuttal}</div>
      </div>
    `).join('');
  }

  // Training
  const modules = [
    { name: 'Sales Fundamentals', completed: true },
    { name: 'Objection Handling', completed: true },
    { name: 'Closing Techniques', completed: false },
    { name: 'Compliance & Legal', completed: false },
    { name: 'Product Knowledge', completed: true },
  ];

  function renderTraining() {
    const container = document.getElementById('trainingModules');
    container.innerHTML = modules.map(m => `
      <div class="flex items-center justify-between p-3 rounded-lg ${m.completed ? 'bg-emerald-500/20 border border-emerald-500/50' : 'bg-slate-800/50 border border-slate-700'}">
        <span class="text-white">${m.name}</span>
        <input type="checkbox" ${m.completed ? 'checked' : ''} onchange="toggleModule(this, '${m.name}')" class="w-5 h-5">
      </div>
    `).join('');
  }

  function toggleModule(checkbox, name) {
    const module = modules.find(m => m.name === name);
    if (module) {
      module.completed = checkbox.checked;
      renderTraining();
      showToast(checkbox.checked ? 'Module completed!' : 'Module unmarked', 'success');
    }
  }

  // Performance Tips
  function renderPerformanceTips() {
    const tips = [
      "üéØ Your objection handling score is 6/10. Try the 'Feel, Felt, Found' technique.",
      "üìà You close 30% better in the morning. Schedule more calls before noon.",
      "üó£Ô∏è You talk 70% of the time. Aim for 50/50 or less.",
      "‚è±Ô∏è Your average call is 8 minutes. Top performers average 12 minutes."
    ];
    
    document.getElementById('performanceTips').innerHTML = tips.map(tip => `
      <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 text-white text-sm">
        ${tip}
      </div>
    `).join('');
  }

  // Initialize
  populateCallSelector();
  renderObjections();
  renderTraining();
  renderPerformanceTips();
  if (typeof lucide !== 'undefined' && lucide.createIcons) { try { if (typeof lucide !== 'undefined' && lucide.createIcons) { try { lucide.createIcons(); } catch(e) { console.warn('[Lucide] createIcons failed:', e.message); } }; } catch(e) { console.warn('[Lucide] createIcons failed:', e.message); } };

// ---- Window Exports ----
  window.sendChatMessage = sendChatMessage;
  window.switchTab = switchTab;
  window.analyzeCall = analyzeCall;
  window.loadScript = loadScript;
  window.filterObjections = filterObjections;
  window.toggleModule = toggleModule;
})();
</script>
</body>
</html>
