<!-- OwnerDashboard - SPA Fragment (converted from standalone) -->
<!-- Header -->
  <div class="header">
    <div class="empire-title">üèÜ DEBT CONSOLIDATION EMPIRE</div>
    <div class="subtitle">OWNER COMMAND CENTER</div>
  </div>

  <!-- Revenue Hero -->
  <div class="revenue-hero">
    <div class="revenue-label">TOTAL REVENUE</div>
    <div class="revenue-amount" id="totalRevenue">$0</div>
    <div class="revenue-growth">
      <span>‚Üë</span>
      <span id="revenueGrowth">+0%</span>
      <span style="color: var(--text-muted); font-size: 1rem;">vs last month</span>
    </div>
  </div>

  <!-- God View Metrics -->
  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-label">TOTAL CLIENTS</div>
      <div class="metric-value" id="totalClients">0</div>
      <div class="metric-subtext">Active accounts</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">ACTIVE CASES</div>
      <div class="metric-value" id="activeCases">0</div>
      <div class="metric-subtext">In progress</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">SETTLEMENT RATE</div>
      <div class="metric-value" id="settlementRate">0%</div>
      <div class="metric-subtext">Success ratio</div>
    </div>
  </div>

  <!-- Financial Overview -->
  <div class="financial-grid">
    <div class="glass-card">
      <div class="card-title">üí∞ Financial Overview</div>
      <div class="financial-row">
        <div class="financial-label">Monthly Recurring Revenue (MRR)</div>
        <div class="financial-value" id="mrr">$0</div>
      </div>
      <div class="financial-row">
        <div class="financial-label">Average Savings %</div>
        <div class="financial-value" id="avgSavings">0%</div>
      </div>
      <div class="financial-row">
        <div class="financial-label">Net Revenue (after costs)</div>
        <div class="financial-value" id="netRevenue">$0</div>
      </div>
      <div class="financial-row">
        <div class="financial-label">Profit Margin</div>
        <div class="financial-value" id="profitMargin">0%</div>
      </div>
      <div class="financial-row">
        <div class="financial-label">Outstanding Receivables</div>
        <div class="financial-value" id="receivables">$0</div>
      </div>
    </div>

    <!-- Top Performers -->
    <div class="glass-card">
      <div class="card-title">üèÖ Top Agent Rankings</div>
      <div id="topPerformersContainer" style="min-height: 200px;"></div>
    </div>
  </div>

  <!-- Growth Chart -->
  <div class="glass-card">
    <div class="card-title">üìà Monthly Revenue Growth (Last 6 Months)</div>
    <div class="growth-chart" id="growthChart"></div>
  </div>

  <!-- Department Health -->
  <div class="glass-card" style="margin-top: 2rem;">
    <div class="card-title">üè¢ Department Health</div>
    <div class="departments-grid">
      <div class="department-card">
        <div class="department-header">
          <div class="department-name">Sales</div>
          <div class="department-status" id="salesStatus"></div>
        </div>
        <div class="department-metrics" id="salesMetrics">
          Loading...
        </div>
      </div>
      <div class="department-card">
        <div class="department-header">
          <div class="department-name">Operations</div>
          <div class="department-status" id="opsStatus"></div>
        </div>
        <div class="department-metrics" id="opsMetrics">
          Loading...
        </div>
      </div>
      <div class="department-card">
        <div class="department-header">
          <div class="department-name">Compliance</div>
          <div class="department-status" id="complianceStatus"></div>
        </div>
        <div class="department-metrics" id="complianceMetrics">
          Loading...
        </div>
      </div>
    </div>
  </div>

  <!-- ü§ñ AI Operations -->
  <div class="glass-card" style="margin-top: 2rem;">
    <div class="card-title">ü§ñ AI Operations ‚Äî Alex (AI Agent)</div>

    <!-- Row 1: ROI + AI vs Human -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
      <!-- AI ROI Card -->
      <div style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(6,182,212,0.1)); border: 1px solid var(--success); border-radius: 1rem; padding: 1.5rem;">
        <div style="font-family: 'Orbitron'; font-size: 1rem; font-weight: 700; margin-bottom: 1rem;">üí∞ AI ROI</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <div style="font-size: 0.75rem; color: var(--text-muted);">Cost Per Call</div>
            <div style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 900; color: var(--success);">$0.22</div>
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">$0.15 Claude + $0.05 ElevenLabs + $0.02 Deepgram</div>
          </div>
          <div>
            <div style="font-size: 0.75rem; color: var(--text-muted);">Est. Revenue Generated</div>
            <div id="aiRevenueGenerated" style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 900; color: var(--accent);">$0</div>
          </div>
          <div>
            <div style="font-size: 0.75rem; color: var(--text-muted);">Total AI Cost</div>
            <div id="aiTotalCost" style="font-family: 'Orbitron'; font-size: 1.25rem; font-weight: 700; color: var(--warning);">$0</div>
          </div>
          <div>
            <div style="font-size: 0.75rem; color: var(--text-muted);">ROI</div>
            <div id="aiROI" style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 900; color: var(--success);">0%</div>
          </div>
        </div>
      </div>

      <!-- AI vs Human Comparison -->
      <div style="background: rgba(148,163,184,0.03); border: 1px solid var(--border-subtle); border-radius: 1rem; padding: 1.5rem;">
        <div style="font-family: 'Orbitron'; font-size: 1rem; font-weight: 700; margin-bottom: 1rem;">‚ö° AI vs Human</div>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 0.5rem; font-size: 0.7rem; color: var(--text-muted); border-bottom: 1px solid var(--border-subtle);">Metric</th>
              <th style="text-align: center; padding: 0.5rem; font-size: 0.7rem; color: var(--accent); border-bottom: 1px solid var(--border-subtle);">ü§ñ AI</th>
              <th style="text-align: center; padding: 0.5rem; font-size: 0.7rem; color: var(--primary); border-bottom: 1px solid var(--border-subtle);">üë§ Human</th>
            </tr>
          </thead>
          <tbody>
            <tr><td style="padding: 0.5rem; font-size: 0.85rem;">Calls/Day</td><td style="text-align: center; font-family: 'Orbitron'; font-weight: 700; color: var(--success);">‚àû</td><td style="text-align: center; font-family: 'Orbitron'; font-weight: 700;">~80</td></tr>
            <tr><td style="padding: 0.5rem; font-size: 0.85rem;">Cost/Lead</td><td style="text-align: center; font-family: 'Orbitron'; font-weight: 700; color: var(--success);">$0.22</td><td style="text-align: center; font-family: 'Orbitron'; font-weight: 700;">$8-15</td></tr>
            <tr><td style="padding: 0.5rem; font-size: 0.85rem;">Handle Time</td><td id="aiCompareHandle" style="text-align: center; font-family: 'Orbitron'; font-weight: 700; color: var(--success);">~4m</td><td style="text-align: center; font-family: 'Orbitron'; font-weight: 700;">~12m</td></tr>
            <tr><td style="padding: 0.5rem; font-size: 0.85rem;">Conversion</td><td id="aiCompareConversion" style="text-align: center; font-family: 'Orbitron'; font-weight: 700;">--%</td><td style="text-align: center; font-family: 'Orbitron'; font-weight: 700;">~15%</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Row 2: Capacity Gauge + Caller Intelligence -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
      <!-- AI Capacity Gauge -->
      <div style="background: rgba(148,163,184,0.03); border: 1px solid var(--border-subtle); border-radius: 1rem; padding: 1.5rem; text-align: center;">
        <div style="font-family: 'Orbitron'; font-size: 1rem; font-weight: 700; margin-bottom: 1rem;">üì° AI Capacity</div>
        <div style="position: relative; width: 160px; height: 160px; margin: 0 auto;">
          <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="rgba(148,163,184,0.1)" stroke-width="3" />
            <path id="aiCapacityArc" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round" />
          </svg>
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <div id="aiCapacityCount" style="font-family: 'Orbitron'; font-size: 1.75rem; font-weight: 900; color: var(--accent);">0</div>
            <div style="font-size: 0.7rem; color: var(--text-muted);">/ 10 max</div>
          </div>
        </div>
        <div style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-secondary);">Active concurrent calls</div>
      </div>

      <!-- Caller Intelligence -->
      <div style="background: rgba(148,163,184,0.03); border: 1px solid var(--border-subtle); border-radius: 1rem; padding: 1.5rem;">
        <div style="font-family: 'Orbitron'; font-size: 1rem; font-weight: 700; margin-bottom: 1rem;">üß† Caller Intelligence</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div style="text-align: center; padding: 1rem; background: rgba(148,163,184,0.05); border-radius: 0.5rem;">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Unique Callers</div>
            <div id="aiUniqueCaller" style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 900; color: var(--primary);">0</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: rgba(148,163,184,0.05); border-radius: 0.5rem;">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Repeat %</div>
            <div id="aiRepeatPct" style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 900; color: var(--accent);">0%</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: rgba(148,163,184,0.05); border-radius: 0.5rem;">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Avg Calls/Caller</div>
            <div id="aiAvgCallsPerCaller" style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 900; color: var(--warning);">0</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: rgba(148,163,184,0.05); border-radius: 0.5rem;">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">AI Status</div>
            <div id="aiOwnerStatus" style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 900; color: var(--success);">üü¢</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 3: Active AI Calls with Listen/Whisper/Barge -->
    <div style="margin-bottom: 1rem;">
      <div style="font-family: 'Orbitron'; font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-secondary);">
        Active AI Calls ‚Äî Monitor & Intervene
      </div>
      <div id="ownerAICallsList"></div>
    </div>
  </div>

  <!-- AI Auto-Dial Dialog (Owner) -->
  <div id="ownerAIDialDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border-radius: 1rem; padding: 2rem; max-width: 500px; width: 90%;">
      <h3 style="font-family: 'Orbitron'; margin-bottom: 1rem;">ü§ñ AI Quick Dial</h3>
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Phone Number</label>
        <input type="tel" id="ownerDialPhone" placeholder="+1234567890" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-subtle); background: var(--bg-glass); color: var(--text-primary); font-family: 'Orbitron';" />
      </div>
      <div style="display: flex; gap: 1rem;">
        <button class="btn btn-success" onclick="ownerStartAIDial()">üìû Call</button>
        <button class="btn btn-primary" onclick="document.getElementById('ownerAIDialDialog').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="action-bar">
    <button class="btn btn-primary" onclick="goToAnalytics()">üìä View All Analytics</button>
    <button class="btn btn-success" onclick="exportFullReport()">üì• Export Full Report</button>
    <button class="btn btn-primary" onclick="goToSettings()">‚öôÔ∏è System Settings</button>
  </div>

  <script>
(function() {
  'use strict';

  document.addEventListener('DOMContentLoaded', function() {
    loadOwnerDashboard();
  });

  function loadOwnerDashboard() {
    const ownerStats = (window.DebtDB?.getOwnerStats?.() || {});
    const deals = (window.DebtDB?.getDeals?.() || []);
    const cases = (window.DebtDB?.getCases?.() || []);
    
    // Total Revenue
    document.getElementById('totalRevenue').textContent = '$' + ownerStats.totalRevenue.toLocaleString();
    
    // Calculate real growth (compare current month to previous)
    const thisMonth = new Date().toISOString().slice(0, 7);
    const lastMonth = new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().slice(0, 7);
    
    const thisMonthRevenue = deals.filter(d => d.createdAt?.startsWith(thisMonth))
      .reduce((sum, d) => sum + (d.amount || 0), 0);
    const lastMonthRevenue = deals.filter(d => d.createdAt?.startsWith(lastMonth))
      .reduce((sum, d) => sum + (d.amount || 0), 0);
    
    const growth = lastMonthRevenue > 0 
      ? ((thisMonthRevenue - lastMonthRevenue) / lastMonthRevenue * 100)
      : 0;
    
    document.getElementById('revenueGrowth').textContent = 
      (growth >= 0 ? '+' : '') + growth.toFixed(1) + '%';
    
    // God View Metrics
    document.getElementById('totalClients').textContent = ownerStats.totalLeads.toLocaleString();
    document.getElementById('activeCases').textContent = ownerStats.totalCases.toLocaleString();
    
    // Settlement Rate
    const settledCases = cases.filter(c => c.status === 'Settled' || c.status === 'Closed').length;
    const settlementRate = cases.length > 0 ? (settledCases / cases.length * 100).toFixed(1) : 0;
    document.getElementById('settlementRate').textContent = settlementRate + '%';
    
    // Financial Overview
    const mrr = thisMonthRevenue;
    document.getElementById('mrr').textContent = '$' + Math.round(mrr).toLocaleString();
    
    // Average Savings (calculated from deals)
    const totalSavings = deals.reduce((sum, d) => sum + (d.savings || 0), 0);
    const avgSavingsPercent = deals.length > 0 ? (totalSavings / deals.length).toFixed(0) : 0;
    document.getElementById('avgSavings').textContent = avgSavingsPercent + '%';
    
    // Net Revenue (assuming 35% cost ratio)
    const costs = ownerStats.totalRevenue * 0.35;
    const netRevenue = ownerStats.totalRevenue - costs;
    document.getElementById('netRevenue').textContent = '$' + Math.round(netRevenue).toLocaleString();
    
    // Profit Margin
    const profitMargin = ownerStats.totalRevenue > 0 
      ? ((netRevenue / ownerStats.totalRevenue) * 100).toFixed(1) 
      : 0;
    document.getElementById('profitMargin').textContent = profitMargin + '%';
    
    // Outstanding Receivables (estimated at 15% of revenue)
    const receivables = ownerStats.totalRevenue * 0.15;
    document.getElementById('receivables').textContent = '$' + Math.round(receivables).toLocaleString();
    
    // Top Performers
    renderTopPerformers();
    
    // Growth Chart
    renderGrowthChart();
    
    // Department Health
    updateDepartmentHealth();
  }

  function renderTopPerformers() {
    const managerStats = (window.DebtDB?.getManagerStats?.() || []);
    
    // Sort by revenue and take top 3
    const topAgents = managerStats
      .sort((a, b) => b.revenue - a.revenue)
      .slice(0, 3);
    
    const container = document.getElementById('topPerformersContainer');
    
    if (topAgents.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No agent data available</div>';
      return;
    }
    
    // Use grid layout for performers
    container.innerHTML = `
      <div class="performers-grid">
        ${topAgents.map((agent, index) => {
          const rank = index + 1;
          const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : 'ü•â';
          const commission = agent.revenue * 0.1; // 10% commission
          
          return `
            <div class="performer-card rank-${rank}">
              <div class="performer-rank">${medal}</div>
              <div class="performer-name">#${rank} ${agent.agentName}</div>
              <div class="performer-revenue">$${agent.revenue.toLocaleString()}</div>
              <div class="performer-commission">Commission: $${commission.toLocaleString()}</div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  function renderGrowthChart() {
    const chart = document.getElementById('growthChart');
    const deals = (window.DebtDB?.getDeals?.() || []);
    
    // Group by month (last 6 months)
    const months = [];
    for (let i = 5; i >= 0; i--) {
      const date = new Date();
      date.setMonth(date.getMonth() - i);
      months.push({
        month: date.toLocaleDateString('en-US', { month: 'short' }),
        revenue: 0
      });
    }
    
    // Sum revenue per month
    deals.forEach(deal => {
      const dealDate = new Date(deal.createdAt);
      const monthIndex = 5 - Math.floor((new Date() - dealDate) / (30 * 24 * 60 * 60 * 1000));
      if (monthIndex >= 0 && monthIndex < 6) {
        months[monthIndex].revenue += deal.amount || 0;
      }
    });
    
    const maxRevenue = Math.max(...months.map(m => m.revenue), 1);
    
    chart.innerHTML = months.map(m => {
      const height = (m.revenue / maxRevenue) * 100;
      return `
        <div class="growth-bar">
          <div class="bar" style="height: ${height}%">
            <div class="bar-value">$${(m.revenue / 1000).toFixed(0)}K</div>
          </div>
          <div class="bar-label">${m.month}</div>
        </div>
      `;
    }).join('');
  }

  function updateDepartmentHealth() {
    const agents = window.DebtDB.getAgents();
    const cases = (window.DebtDB?.getCases?.() || []);
    const checklist = (window.DebtDB?.getComplianceChecklist?.() || []);
    
    // Sales Health
    const salesStatus = document.getElementById('salesStatus');
    const salesMetrics = document.getElementById('salesMetrics');
    
    if (agents.length >= 5) {
      salesStatus.className = 'department-status';
      salesMetrics.innerHTML = `${agents.length} active agents<br>Pipeline healthy`;
    } else {
      salesStatus.className = 'department-status warning';
      salesMetrics.innerHTML = `${agents.length} active agents<br>Consider hiring`;
    }
    
    // Operations Health
    const opsStatus = document.getElementById('opsStatus');
    const opsMetrics = document.getElementById('opsMetrics');
    
    const activeCases = cases.filter(c => c.status === 'Active' || c.status === 'In Progress').length;
    
    if (activeCases < 100) {
      opsStatus.className = 'department-status';
      opsMetrics.innerHTML = `${activeCases} active cases<br>Workload normal`;
    } else {
      opsStatus.className = 'department-status warning';
      opsMetrics.innerHTML = `${activeCases} active cases<br>High volume`;
    }
    
    // Compliance Health
    const complianceStatus = document.getElementById('complianceStatus');
    const complianceMetrics = document.getElementById('complianceMetrics');
    
    const completed = checklist.filter(item => item.completed).length;
    const total = checklist.length;
    const complianceScore = total > 0 ? Math.round((completed / total) * 100) : 0;
    
    if (complianceScore >= 80) {
      complianceStatus.className = 'department-status';
      complianceMetrics.innerHTML = `${complianceScore}% compliance score<br>Excellent standing`;
    } else if (complianceScore >= 60) {
      complianceStatus.className = 'department-status warning';
      complianceMetrics.innerHTML = `${complianceScore}% compliance score<br>Needs attention`;
    } else {
      complianceStatus.className = 'department-status critical';
      complianceMetrics.innerHTML = `${complianceScore}% compliance score<br>CRITICAL - Action Required`;
    }
  }

  function goToAnalytics() {
    if (window.App && window.App.loadPage) {
      window.App.loadPage('Analytics');
    } else {
      window.location.href = '/pages/Analytics.html';
    }
  }

  function exportFullReport() {
    const ownerStats = (window.DebtDB?.getOwnerStats?.() || {});
    const managerStats = (window.DebtDB?.getManagerStats?.() || []);
    const checklist = (window.DebtDB?.getComplianceChecklist?.() || []);
    const deals = (window.DebtDB?.getDeals?.() || []);
    
    // Calculate additional metrics
    const thisMonth = new Date().toISOString().slice(0, 7);
    const thisMonthRevenue = deals.filter(d => d.createdAt?.startsWith(thisMonth))
      .reduce((sum, d) => sum + (d.amount || 0), 0);
    const costs = ownerStats.totalRevenue * 0.35;
    const netRevenue = ownerStats.totalRevenue - costs;
    const profitMargin = ((netRevenue / ownerStats.totalRevenue) * 100).toFixed(1);
    
    const report = {
      generatedAt: new Date().toISOString(),
      reportType: 'Owner Full Report',
      overview: {
        totalRevenue: ownerStats.totalRevenue,
        monthlyRevenue: thisMonthRevenue,
        netRevenue: netRevenue,
        profitMargin: profitMargin + '%',
        totalClients: ownerStats.totalLeads,
        totalCases: ownerStats.totalCases,
        totalDeals: ownerStats.totalDeals,
        totalAgents: ownerStats.totalAgents,
        avgDealSize: ownerStats.avgDealSize,
        activeCampaigns: ownerStats.activeCampaigns
      },
      compliance: {
        score: (checklist.filter(i => i.completed).length / checklist.length * 100).toFixed(1) + '%',
        checklist: checklist
      },
      topPerformers: managerStats.sort((a, b) => b.revenue - a.revenue).slice(0, 5),
      departmentHealth: {
        sales: ownerStats.totalAgents >= 5 ? 'Healthy' : 'Needs Attention',
        operations: 'Normal',
        compliance: checklist.filter(i => i.completed).length / checklist.length >= 0.8 ? 'Excellent' : 'Needs Improvement'
      }
    };
    
    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `owner-full-report-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert('Full owner report exported successfully');
  }

  function goToSettings() {
    if (window.App && window.App.loadPage) {
      window.App.loadPage('Settings');
    } else {
      window.location.href = '/pages/Settings.html';
    }
  }

  // ‚îÄ‚îÄ AI Operations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const OWNER_PHONE = '+13059659624';
  let ownerAITimers = {};

  // Start AI polling
  setInterval(loadOwnerAICalls, 5000);
  loadOwnerAICalls();
  loadCallerIntelligence();
  setInterval(loadCallerIntelligence, 30000);

  async function loadOwnerAICalls() {
    try {
      const resp = await fetch('https://debt-voice-stack.fly.dev/api/calls/active');
      const data = await resp.json();
      const calls = data.calls || data.active_calls || [];

      // Capacity gauge
      const count = calls.length;
      const max = 10;
      const pct = Math.round((count / max) * 100);
      const arcEl = document.getElementById('aiCapacityArc');
      if (arcEl) arcEl.setAttribute('stroke-dasharray', pct + ', 100');
      const countEl = document.getElementById('aiCapacityCount');
      if (countEl) countEl.textContent = count;

      // Agent status
      try {
        const sResp = await fetch('https://debt-voice-stack.fly.dev/api/agent/status');
        const s = await sResp.json();
        const callsToday = s.calls_today || s.callsToday || 0;
        const qualRate = s.qualification_rate || s.qualificationRate || 0;
        const avgTime = s.avg_handle_time || s.avgHandleTime || '4m';

        // ROI calculations
        const costPerCall = 0.22;
        const totalCost = (callsToday * costPerCall);
        const estRevPerQualified = 500;
        const qualifiedCount = Math.round(callsToday * (qualRate / 100));
        const estRevenue = qualifiedCount * estRevPerQualified;
        const roi = totalCost > 0 ? Math.round(((estRevenue - totalCost) / totalCost) * 100) : 0;

        const el1 = document.getElementById('aiTotalCost');
        if (el1) el1.textContent = '$' + totalCost.toFixed(2);
        const el2 = document.getElementById('aiRevenueGenerated');
        if (el2) el2.textContent = '$' + estRevenue.toLocaleString();
        const el3 = document.getElementById('aiROI');
        if (el3) el3.textContent = roi + '%';
        const el4 = document.getElementById('aiCompareConversion');
        if (el4) el4.textContent = qualRate + '%';
        const el5 = document.getElementById('aiCompareHandle');
        if (el5) el5.textContent = typeof avgTime === 'number' ? '~' + avgTime + 'm' : '~' + avgTime;
      } catch(e) { console.warn('Agent status unavailable:', e); }

      // Render active calls
      const container = document.getElementById('ownerAICallsList');
      if (!container) return;

      if (calls.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No active AI calls</div>';
        return;
      }

      container.innerHTML = calls.map(call => {
        const sid = call.call_sid || call.callSid || call.sid || call.id;
        const callerName = call.caller_name || call.callerName || 'Unknown';
        const callerPhone = call.caller_phone || call.callerPhone || call.from || '';
        const sentiment = call.sentiment || 'neutral';
        const topic = call.topic || call.current_topic || 'General';
        const captured = call.data_points_captured || call.dataPointsCaptured || 0;
        const total = call.data_points_total || call.dataPointsTotal || 65;
        const pct = total > 0 ? Math.round((captured / total) * 100) : 0;

        if (!ownerAITimers[sid]) ownerAITimers[sid] = call.started_at || call.startedAt || Date.now();
        const elapsed = Math.floor((Date.now() - new Date(ownerAITimers[sid]).getTime()) / 1000);
        const dur = Math.floor(elapsed / 60) + ':' + String(elapsed % 60).padStart(2, '0');

        const sColors = { positive: 'var(--success)', neutral: 'var(--warning)', negative: 'var(--danger)' };
        const sEmoji = { positive: 'üòä', neutral: 'üòê', negative: 'üòü' };

        return `
          <div style="background: rgba(148,163,184,0.03); border-left: 3px solid var(--accent); border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 0.75rem;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
              <div>
                <div style="font-weight: 600;">${callerName}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${callerPhone}</div>
              </div>
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-family: 'Orbitron'; color: var(--accent);">${dur}</span>
                <span style="background: ${sColors[sentiment] || sColors.neutral}; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.75rem;">${sEmoji[sentiment] || 'üòê'} ${sentiment}</span>
              </div>
            </div>
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Topic: <strong>${topic}</strong></div>
            <div style="margin-bottom: 0.75rem;">
              <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                <span>Data Points</span><span>${captured}/${total}</span>
              </div>
              <div style="height: 6px; background: rgba(148,163,184,0.1); border-radius: 3px; overflow: hidden;">
                <div style="height: 100%; width: ${pct}%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 3px;"></div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.75rem;" onclick="ownerAIListen('${sid}')">üéß Listen</button>
              <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.75rem;" onclick="ownerAIWhisperToggle('${sid}')">üí¨ Whisper</button>
              <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.75rem;" onclick="ownerAIBarge('${sid}')">üìû Barge</button>
            </div>
            <div id="owner-whisper-${sid}" style="display: none; margin-top: 0.5rem;">
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="owner-whisper-text-${sid}" placeholder="Whisper message..." style="flex: 1; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-subtle); background: var(--bg-glass); color: var(--text-primary);" />
                <button class="btn btn-success" style="padding: 0.5rem 1rem; font-size: 0.75rem;" onclick="ownerAIWhisperSend('${sid}')">Send</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    } catch(e) {
      console.warn('AI calls fetch failed:', e);
    }
  }

  async function loadCallerIntelligence() {
    try {
      const resp = await fetch('https://debt-voice-stack.fly.dev/api/callers');
      const data = await resp.json();
      const callers = data.callers || data || [];
      const total = callers.length;
      const repeats = callers.filter(c => (c.call_count || c.callCount || 1) > 1).length;
      const repeatPct = total > 0 ? Math.round((repeats / total) * 100) : 0;
      const totalCalls = callers.reduce((s, c) => s + (c.call_count || c.callCount || 1), 0);
      const avg = total > 0 ? (totalCalls / total).toFixed(1) : 0;

      const el1 = document.getElementById('aiUniqueCaller');
      if (el1) el1.textContent = total;
      const el2 = document.getElementById('aiRepeatPct');
      if (el2) el2.textContent = repeatPct + '%';
      const el3 = document.getElementById('aiAvgCallsPerCaller');
      if (el3) el3.textContent = avg;
    } catch(e) { console.warn('Callers API unavailable:', e); }
  }

  async function ownerAIListen(sid) {
    try {
      const r = await fetch(`https://debt-voice-stack.fly.dev/api/calls/${sid}/listen`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ monitor_phone: OWNER_PHONE })
      });
      alert(r.ok ? 'üéß Listen mode ‚Äî call incoming' : 'Failed');
    } catch(e) { alert('Voice stack unavailable'); }
  }

  function ownerAIWhisperToggle(sid) {
    const el = document.getElementById('owner-whisper-' + sid);
    if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
  }

  async function ownerAIWhisperSend(sid) {
    const el = document.getElementById('owner-whisper-text-' + sid);
    if (!el || !el.value.trim()) return;
    try {
      const r = await fetch(`https://debt-voice-stack.fly.dev/api/calls/${sid}/whisper`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ message: el.value.trim() })
      });
      if (r.ok) { el.value = ''; alert('üí¨ Whisper sent'); }
    } catch(e) { alert('Voice stack unavailable'); }
  }

  async function ownerAIBarge(sid) {
    try {
      const r = await fetch(`https://debt-voice-stack.fly.dev/api/calls/${sid}/barge`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ monitor_phone: OWNER_PHONE })
      });
      alert(r.ok ? 'üìû Barge activated' : 'Failed');
    } catch(e) { alert('Voice stack unavailable'); }
  }

  async function ownerStartAIDial() {
    const ph = document.getElementById('ownerDialPhone');
    if (!ph || !ph.value.trim()) return;
    try {
      const r = await fetch('https://debt-voice-stack.fly.dev/api/calls/outbound-ai', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ phone_number: ph.value.trim() })
      });
      if (r.ok) {
        alert('ü§ñ AI call initiated');
        document.getElementById('ownerAIDialDialog').style.display = 'none';
        ph.value = '';
      }
    } catch(e) { alert('Voice stack unavailable'); }
  }

  // Expose functions to window for onclick handlers
  window.exportFullReport = exportFullReport;
  window.goToAnalytics = goToAnalytics;
  window.goToSettings = goToSettings;
  window.ownerAIListen = ownerAIListen;
  window.ownerAIWhisperToggle = ownerAIWhisperToggle;
  window.ownerAIWhisperSend = ownerAIWhisperSend;
  window.ownerAIBarge = ownerAIBarge;
  window.ownerStartAIDial = ownerStartAIDial;
})();
</script>
