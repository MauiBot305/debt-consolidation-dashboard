<!-- ManagerDashboard - SPA Fragment (converted from standalone) -->
<!-- Header -->
  <div class="header">
    <h1>ğŸ‘¥ Manager Dashboard</h1>
    <button class="btn btn-success" onclick="exportTeamReport()">ğŸ“¥ Export Team Report</button>
  </div>

  <!-- Team Overview -->
  <div class="overview-grid">
    <div class="overview-card">
      <div class="overview-label">Total Agents</div>
      <div class="overview-value" id="totalAgents">0</div>
    </div>
    <div class="overview-card">
      <div class="overview-label">Active Calls Now</div>
      <div class="overview-value" id="activeCalls">0</div>
    </div>
    <div class="overview-card">
      <div class="overview-label">Pending Leads</div>
      <div class="overview-value" id="pendingLeads">0</div>
    </div>
    <div class="overview-card">
      <div class="overview-label">Compliance Score</div>
      <div class="overview-value" id="complianceScore">0%</div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="actions-bar">
    <button class="action-btn" onclick="assignLeads()">
      <span style="font-size: 1.5rem;">ğŸ¯</span>
      <span class="action-label">Assign Leads (Auto)</span>
    </button>
    <button class="action-btn" onclick="reviewCases()">
      <span style="font-size: 1.5rem;">ğŸ“‹</span>
      <span class="action-label">Review Cases</span>
    </button>
    <button class="action-btn" onclick="runComplianceCheck()">
      <span style="font-size: 1.5rem;">ğŸ›¡ï¸</span>
      <span class="action-label">Run Compliance Check</span>
    </button>
  </div>

  <!-- Main Content -->
  <div class="main-grid">
    <!-- Agent Performance Table -->
    <div class="glass-card">
      <div class="card-title">ğŸ“Š Agent Performance</div>
      <table>
        <thead>
          <tr>
            <th onclick="sortTable('name')">Agent</th>
            <th onclick="sortTable('callsToday')">Calls Today</th>
            <th onclick="sortTable('dealsWeek')">Deals This Week</th>
            <th onclick="sortTable('revenue')">Revenue</th>
            <th onclick="sortTable('conversion')">Conversion %</th>
          </tr>
        </thead>
        <tbody id="agentTableBody"></tbody>
      </table>
    </div>

    <!-- Right Column -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
      <!-- Active Calls Panel -->
      <div class="glass-card">
        <div class="card-title">ğŸ“ Active Calls</div>
        <div id="activeCallsList"></div>
      </div>

      <!-- Alert Panel -->
      <div class="glass-card">
        <div class="card-title">âš ï¸ Alerts</div>
        <div class="alert-list" id="alertList"></div>
      </div>
    </div>
  </div>

  <!-- AI Agent Monitor Section -->
  <div class="glass-card" style="margin-bottom: 1.5rem;">
    <div class="card-title">ğŸ¤– AI Agent Monitor</div>
    
    <!-- AI Agent Status Card -->
    <div style="background: rgba(148, 163, 184, 0.03); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div>
          <div style="font-family: 'Orbitron'; font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">
            Alex (AI Agent)
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span id="aiAgentStatus" style="font-size: 1.25rem;">ğŸŸ¢</span>
            <span id="aiAgentStatusText" style="color: var(--success); font-weight: 600;">Active</span>
            <span id="aiConcurrentCount" style="margin-left: 1rem; font-family: 'Orbitron'; font-weight: 700; color: var(--accent);">0/10 Calls</span>
          </div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.25rem;">Calls Today</div>
          <div id="aiCallsToday" style="font-family: 'Orbitron'; font-size: 2rem; font-weight: 900; color: var(--accent);">0</div>
        </div>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn btn-success btn-sm" onclick="showAIAutoDialDialog()">ğŸ¤– AI Auto-Dial</button>
      </div>
    </div>

    <!-- AI Performance Quick Stats -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
      <div style="text-align: center; padding: 1rem; background: rgba(148, 163, 184, 0.03); border-radius: 0.5rem;">
        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Calls Today</div>
        <div id="aiPerfCallsToday" style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 700; color: var(--accent);">0</div>
      </div>
      <div style="text-align: center; padding: 1rem; background: rgba(148, 163, 184, 0.03); border-radius: 0.5rem;">
        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Avg Handle Time</div>
        <div id="aiPerfAvgTime" style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 700; color: var(--primary);">0m</div>
      </div>
      <div style="text-align: center; padding: 1rem; background: rgba(148, 163, 184, 0.03); border-radius: 0.5rem;">
        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Qualification Rate</div>
        <div id="aiPerfQualRate" style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 700; color: var(--success);">0%</div>
      </div>
      <div style="text-align: center; padding: 1rem; background: rgba(148, 163, 184, 0.03); border-radius: 0.5rem;">
        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Appointments Set</div>
        <div id="aiPerfAppointments" style="font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 700; color: var(--warning);">0</div>
      </div>
    </div>

    <!-- Active AI Calls Table -->
    <div style="margin-top: 1rem;">
      <div style="font-family: 'Orbitron'; font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-secondary);">
        Active AI Calls (Multiple Concurrent)
      </div>
      <div id="aiActiveCallsList"></div>
    </div>
  </div>

  <!-- AI Auto-Dial Dialog (hidden by default) -->
  <div id="aiAutoDialDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border-radius: 1rem; padding: 2rem; max-width: 500px; width: 90%;">
      <h3 style="font-family: 'Orbitron'; margin-bottom: 1rem;">ğŸ¤– AI Auto-Dial</h3>
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Lead Phone Number</label>
        <input type="tel" id="aiDialPhoneInput" placeholder="+1234567890" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-subtle); background: var(--bg-glass); color: var(--text-primary); font-family: 'Orbitron';" />
      </div>
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Lead Name (Optional)</label>
        <input type="text" id="aiDialNameInput" placeholder="John Doe" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-subtle); background: var(--bg-glass); color: var(--text-primary);" />
      </div>
      <div style="display: flex; gap: 1rem;">
        <button class="btn btn-success" onclick="startAIAutoDial()">ğŸ“ Start Call</button>
        <button class="btn btn-primary" onclick="closeAIAutoDialDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
(function() {
  'use strict';

  let agentData = [];
  let sortColumn = 'revenue';
  let sortDirection = 'desc';
  const MANAGER_PHONE = '+13059659624'; // Patrick's number

  let aiCallTimers = {};

  (function() {
    loadManagerDashboard();
    // Refresh active calls every 10 seconds
    if (window._pageIntervals) window._pageIntervals.forEach(clearInterval);
    window._pageIntervals = [];
    window._pageIntervals.push(setInterval(loadActiveCalls, 10000));
    // Refresh AI calls every 5 seconds
    window._pageIntervals.push(setInterval(loadAICalls, 5000));
    loadAICalls(); // Initial load
  })();

  async function loadManagerDashboard() {
    await updateOverview();
    await loadAgentPerformance();
    await loadActiveCalls();
    loadAlerts();
  }

  async function fetchCallData() {
    try {
      const resp = await fetch('https://debt-voice-stack.fly.dev/api/calls?limit=50');
      const data = await resp.json();
      return data.calls || [];
    } catch(e) {
      console.warn('Voice stack API unavailable, using local data:', e);
      return window.DebtDB.getCalls() || [];
    }
  }

  async function updateOverview() {
    const agents = window.DebtDB.getAgents();
    const leads = (window.DebtDB?.getLeads?.() || []);
    const calls = await fetchCallData();
    const checklist = (window.DebtDB?.getComplianceChecklist?.() || []);
    
    // Total Agents
    document.getElementById('totalAgents').textContent = agents.length;
    
    // Active Calls (from voice stack API)
    const activeCalls = calls.filter(c => c.status === 'in-progress' || c.status === 'ringing').length;
    document.getElementById('activeCalls').textContent = activeCalls;
    
    // Pending Leads
    const pendingLeads = leads.filter(l => l.stage === 'Lead' || l.stage === 'Contacted').length;
    document.getElementById('pendingLeads').textContent = pendingLeads;
    
    // Compliance Score
    const completed = checklist.filter(item => item.completed).length;
    const total = checklist.length;
    const complianceScore = total > 0 ? Math.round((completed / total) * 100) : 0;
    document.getElementById('complianceScore').textContent = complianceScore + '%';
  }

  async function loadAgentPerformance() {
    const managerStats = (window.DebtDB?.getManagerStats?.() || []);
    const calls = await fetchCallData();
    
    agentData = managerStats.map(agent => {
      const agentCalls = calls.filter(c => c.agent === agent.agentId);
      const conversion = agentCalls.length > 0 
        ? ((agent.dealsThisWeek / agentCalls.length) * 100).toFixed(1) 
        : 0;
      
      return {
        id: agent.agentId,
        name: agent.agentName,
        callsToday: agent.callsToday,
        dealsWeek: agent.dealsThisWeek,
        revenue: agent.revenue,
        conversion: parseFloat(conversion)
      };
    });
    
    sortTable(sortColumn);
  }

  async function loadActiveCalls() {
    const calls = await fetchCallData();
    const activeCalls = calls.filter(c => c.status === 'in-progress' || c.status === 'ringing');
    const container = document.getElementById('activeCallsList');
    
    if (activeCalls.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No active calls</div>';
      return;
    }
    
    container.innerHTML = activeCalls.map(call => {
      const agent = window.DebtDB.getAgents().find(a => a.id === call.agent);
      const agentName = agent?.name || 'Unknown Agent';
      const leadName = call.lead?.name || call.to || 'Unknown Lead';
      
      return `
        <div class="call-item">
          <div class="call-info">
            <div class="call-agent">${agentName}</div>
            <div class="call-lead">â†’ ${leadName}</div>
          </div>
          <div class="call-actions">
            <button class="btn btn-primary btn-sm" onclick="listenToCall('${call.callSid || call.id}')">ğŸ‘‚ Listen</button>
            <button class="btn btn-primary btn-sm" onclick="whisperToCall('${call.callSid || call.id}')">ğŸ’¬ Whisper</button>
            <button class="btn btn-primary btn-sm" onclick="bargeIntoCall('${call.callSid || call.id}')">ğŸš¨ Barge</button>
          </div>
        </div>
      `;
    }).join('');
  }

  async function listenToCall(callSid) {
    try {
      const resp = await fetch(`https://debt-voice-stack.fly.dev/api/calls/${callSid}/listen`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ manager_phone: MANAGER_PHONE })
      });
      
      if (resp.ok) {
        showToast('Listen mode activated. You will receive a call shortly.');
      } else {
        showToast('Failed to activate listen mode');
      }
    } catch(e) {
      console.error('Listen API error:', e);
      showToast('Error: Voice stack API unavailable');
    }
  }

  async function whisperToCall(callSid) {
    try {
      const resp = await fetch(`https://debt-voice-stack.fly.dev/api/calls/${callSid}/whisper`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ manager_phone: MANAGER_PHONE })
      });
      
      if (resp.ok) {
        showToast('Whisper mode activated. Only agent can hear you.');
      } else {
        showToast('Failed to activate whisper mode');
      }
    } catch(e) {
      console.error('Whisper API error:', e);
      showToast('Error: Voice stack API unavailable');
    }
  }

  async function bargeIntoCall(callSid) {
    try {
      const resp = await fetch(`https://debt-voice-stack.fly.dev/api/calls/${callSid}/barge`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ manager_phone: MANAGER_PHONE })
      });
      
      if (resp.ok) {
        showToast('Barge mode activated. All parties can hear you.');
      } else {
        showToast('Failed to activate barge mode');
      }
    } catch(e) {
      console.error('Barge API error:', e);
      showToast('Error: Voice stack API unavailable');
    }
  }

  function sortTable(column) {
    if (sortColumn === column) {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      sortColumn = column;
      sortDirection = 'desc';
    }
    
    agentData.sort((a, b) => {
      let aVal = a[column];
      let bVal = b[column];
      
      if (typeof aVal === 'string') {
        aVal = aVal.toLowerCase();
        bVal = bVal.toLowerCase();
      }
      
      if (sortDirection === 'asc') {
        return aVal > bVal ? 1 : -1;
      } else {
        return aVal < bVal ? 1 : -1;
      }
    });
    
    renderAgentTable();
  }

  function renderAgentTable() {
    const tbody = document.getElementById('agentTableBody');
    
    tbody.innerHTML = agentData.map(agent => {
      const initials = agent.name.split(' ').map(n => n[0]).join('');
      const conversionPercent = Math.min(agent.conversion, 100);
      
      return `
        <tr>
          <td>
            <div class="agent-name">
              <div class="agent-avatar">${initials}</div>
              <span>${agent.name}</span>
            </div>
          </td>
          <td>${agent.callsToday}</td>
          <td>${agent.dealsWeek}</td>
          <td style="font-family: 'Orbitron'; color: var(--success); font-weight: 700;">
            $${agent.revenue.toLocaleString()}
          </td>
          <td>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div class="performance-bar" style="flex: 1;">
                <div class="performance-fill" style="width: ${conversionPercent}%"></div>
              </div>
              <span style="font-family: 'Orbitron'; font-size: 0.75rem; min-width: 40px;">
                ${agent.conversion}%
              </span>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function loadAlerts() {
    const alertList = document.getElementById('alertList');
    
    // Generate alerts based on system state
    const alerts = [];
    
    // Check for overdue follow-ups
    const activities = (window.DebtDB?.getActivities?.() || []);
    const overdue = activities.filter(a => {
      if (!a.scheduledFor) return false;
      return new Date(a.scheduledFor) < new Date();
    }).length;
    
    if (overdue > 0) {
      alerts.push({
        type: 'critical',
        icon: 'ğŸ”´',
        title: `${overdue} Overdue Follow-ups`,
        text: 'Multiple callbacks and follow-ups are past due'
      });
    }
    
    // Check compliance
    const checklist = (window.DebtDB?.getComplianceChecklist?.() || []);
    const completed = checklist.filter(item => item.completed).length;
    const complianceScore = (completed / checklist.length) * 100;
    
    if (complianceScore < 80) {
      alerts.push({
        type: 'warning',
        icon: 'âš ï¸',
        title: 'Compliance Score Below Target',
        text: `Current score: ${complianceScore.toFixed(0)}% (target: 80%)`
      });
    }
    
    // Check for expiring licenses
    const licenses = window.DebtDB.getLicenses();
    const today = new Date();
    const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
    
    const expiring = licenses.filter(license => {
      if (!license.expiryDate) return false;
      const expiryDate = new Date(license.expiryDate);
      return expiryDate <= thirtyDaysFromNow && expiryDate >= today;
    });
    
    if (expiring.length > 0) {
      alerts.push({
        type: 'warning',
        icon: 'ğŸ“‹',
        title: `${expiring.length} License(s) Expiring Soon`,
        text: 'Review and renew state licenses within 30 days'
      });
    }
    
    // Success alert if everything is good
    if (alerts.length === 0) {
      alerts.push({
        type: 'info',
        icon: 'âœ…',
        title: 'All Systems Operational',
        text: 'No alerts at this time. Team is performing well!'
      });
    }
    
    alertList.innerHTML = alerts.map(alert => `
      <div class="alert-item ${alert.type}">
        <div class="alert-icon">${alert.icon}</div>
        <div class="alert-content">
          <div class="alert-title">${alert.title}</div>
          <div class="alert-text">${alert.text}</div>
        </div>
      </div>
    `).join('');
  }

  function assignLeads() {
    const leads = (window.DebtDB?.getLeads?.() || []).filter(l => !l.agent);
    const agents = window.DebtDB.getAgents();
    
    if (leads.length === 0) {
      showToast('No unassigned leads found');
      return;
    }
    
    if (agents.length === 0) {
      showToast('No agents available');
      return;
    }
    
    // Round-robin assignment
    let agentIndex = 0;
    leads.forEach(lead => {
      const agent = agents[agentIndex % agents.length];
      window.DebtDB?.updateLead?.(lead.id, { agent: agent.id });
      agentIndex++;
    });
    
    showToast(`Assigned ${leads.length} leads to ${agents.length} agents`);
    loadManagerDashboard();
  }

  function reviewCases() {
    if (window.App && window.App.loadPage) {
      window.App.loadPage('CaseManagement');
    } else {
      window.location.href = '/pages/CaseManagement.html';
    }
  }

  function runComplianceCheck() {
    if (window.App && window.App.loadPage) {
      window.App.loadPage('Compliance');
    } else {
      window.location.href = '/pages/Compliance.html';
    }
  }

  function exportTeamReport() {
    // CSV format export
    const headers = ['Agent Name', 'Calls Today', 'Deals This Week', 'Revenue', 'Conversion %'];
    const rows = agentData.map(agent => [
      agent.name,
      agent.callsToday,
      agent.dealsWeek,
      agent.revenue,
      agent.conversion
    ]);
    
    let csvContent = headers.join(',') + '\n';
    rows.forEach(row => {
      csvContent += row.join(',') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `team-report-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('Team report exported successfully');
  }

  function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('active');
    
    setTimeout(() => {
      toast.classList.remove('active');
    }, 3000);
  }

  // â”€â”€ AI Agent Monitor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function loadAICalls() {
    try {
      // Fetch active AI calls
      const resp = await fetch('https://debt-voice-stack.fly.dev/api/calls/active');
      const data = await resp.json();
      const activeCalls = (data.calls || data.active_calls || []);

      // Update concurrent count
      const countEl = document.getElementById('aiConcurrentCount');
      if (countEl) countEl.textContent = activeCalls.length + '/10 Calls';

      // Fetch agent status for performance stats
      try {
        const statusResp = await fetch('https://debt-voice-stack.fly.dev/api/agent/status');
        const status = await statusResp.json();
        const callsToday = status.calls_today || status.callsToday || 0;
        const avgTime = status.avg_handle_time || status.avgHandleTime || '0m';
        const qualRate = status.qualification_rate || status.qualificationRate || 0;
        const appointments = status.appointments_set || status.appointmentsSet || 0;

        const el1 = document.getElementById('aiCallsToday');
        if (el1) el1.textContent = callsToday;
        const el2 = document.getElementById('aiPerfCallsToday');
        if (el2) el2.textContent = callsToday;
        const el3 = document.getElementById('aiPerfAvgTime');
        if (el3) el3.textContent = typeof avgTime === 'number' ? avgTime + 'm' : avgTime;
        const el4 = document.getElementById('aiPerfQualRate');
        if (el4) el4.textContent = qualRate + '%';
        const el5 = document.getElementById('aiPerfAppointments');
        if (el5) el5.textContent = appointments;

        // Update status indicator
        const statusEl = document.getElementById('aiAgentStatus');
        const statusTextEl = document.getElementById('aiAgentStatusText');
        if (statusEl && statusTextEl) {
          const isOnline = status.status === 'online' || status.status === 'active' || true;
          statusEl.textContent = isOnline ? 'ğŸŸ¢' : 'ğŸ”´';
          statusTextEl.textContent = isOnline ? 'Online' : 'Offline';
          statusTextEl.style.color = isOnline ? 'var(--success)' : 'var(--danger)';
        }
      } catch(e) {
        console.warn('Agent status API unavailable:', e);
      }

      // Render active AI calls grid
      const container = document.getElementById('aiActiveCallsList');
      if (!container) return;

      if (activeCalls.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No active AI calls right now</div>';
        return;
      }

      container.innerHTML = activeCalls.map(call => {
        const sid = call.call_sid || call.callSid || call.sid || call.id;
        const callerName = call.caller_name || call.callerName || 'Unknown';
        const callerPhone = call.caller_phone || call.callerPhone || call.from || '';
        const sentiment = call.sentiment || 'neutral';
        const topic = call.topic || call.current_topic || 'General';
        const captured = call.data_points_captured || call.dataPointsCaptured || 0;
        const totalPoints = call.data_points_total || call.dataPointsTotal || 65;
        const progressPct = totalPoints > 0 ? Math.round((captured / totalPoints) * 100) : 0;

        // Manage live duration timer
        if (!aiCallTimers[sid]) {
          aiCallTimers[sid] = call.started_at || call.startedAt || Date.now();
        }
        const elapsed = Math.floor((Date.now() - new Date(aiCallTimers[sid]).getTime()) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        const duration = mins + ':' + String(secs).padStart(2, '0');

        const sentimentColors = { positive: 'var(--success)', neutral: 'var(--warning)', negative: 'var(--danger)' };
        const sentimentEmoji = { positive: 'ğŸ˜Š', neutral: 'ğŸ˜', negative: 'ğŸ˜Ÿ' };

        return `
          <div style="background: rgba(148,163,184,0.03); border-left: 3px solid var(--accent); border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 0.75rem;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
              <div>
                <div style="font-weight: 600; font-size: 0.95rem;">${callerName}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${callerPhone}</div>
              </div>
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-family: 'Orbitron'; font-size: 1rem; color: var(--accent);">${duration}</span>
                <span style="background: ${sentimentColors[sentiment] || sentimentColors.neutral}; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.75rem;">
                  ${sentimentEmoji[sentiment] || 'ğŸ˜'} ${sentiment}
                </span>
              </div>
            </div>
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Topic: <strong>${topic}</strong></div>
            <div style="margin-bottom: 0.75rem;">
              <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                <span>Data Points</span>
                <span>${captured}/${totalPoints} captured</span>
              </div>
              <div style="height: 6px; background: rgba(148,163,184,0.1); border-radius: 3px; overflow: hidden;">
                <div style="height: 100%; width: ${progressPct}%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 3px;"></div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button class="btn btn-primary btn-sm" onclick="aiListen('${sid}')">ğŸ§ Listen</button>
              <button class="btn btn-primary btn-sm" onclick="aiWhisperToggle('${sid}', this)">ğŸ’¬ Whisper</button>
              <button class="btn btn-primary btn-sm" onclick="aiBarge('${sid}')">ğŸ“ Barge</button>
            </div>
            <div id="whisper-input-${sid}" style="display: none; margin-top: 0.5rem;">
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="whisper-text-${sid}" placeholder="Type message to whisper..." style="flex: 1; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-subtle); background: var(--bg-glass); color: var(--text-primary); font-size: 0.85rem;" />
                <button class="btn btn-success btn-sm" onclick="aiWhisperSend('${sid}')">Send</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

    } catch(e) {
      console.warn('AI calls fetch failed:', e);
      const container = document.getElementById('aiActiveCallsList');
      if (container) container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-muted);">AI call data unavailable</div>';
    }
  }

  // Clean up timers for calls that ended
  function cleanupAITimers(activeSids) {
    Object.keys(aiCallTimers).forEach(sid => {
      if (!activeSids.includes(sid)) delete aiCallTimers[sid];
    });
  }

  async function aiListen(sid) {
    try {
      const resp = await fetch(`https://debt-voice-stack.fly.dev/api/calls/${sid}/listen`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ monitor_phone: MANAGER_PHONE })
      });
      showToast(resp.ok ? 'ğŸ§ Listen mode activated â€” call incoming to your phone' : 'Failed to activate listen');
    } catch(e) { showToast('Error: Voice stack unavailable'); }
  }

  function aiWhisperToggle(sid, btn) {
    const input = document.getElementById('whisper-input-' + sid);
    if (input) input.style.display = input.style.display === 'none' ? 'block' : 'none';
  }

  async function aiWhisperSend(sid) {
    const textEl = document.getElementById('whisper-text-' + sid);
    if (!textEl) return;
    const message = textEl.value.trim();
    if (!message) return;
    try {
      const resp = await fetch(`https://debt-voice-stack.fly.dev/api/calls/${sid}/whisper`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ message: message })
      });
      if (resp.ok) {
        showToast('ğŸ’¬ Whisper sent to AI agent');
        textEl.value = '';
      } else {
        showToast('Failed to send whisper');
      }
    } catch(e) { showToast('Error: Voice stack unavailable'); }
  }

  async function aiBarge(sid) {
    try {
      const resp = await fetch(`https://debt-voice-stack.fly.dev/api/calls/${sid}/barge`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ monitor_phone: MANAGER_PHONE })
      });
      showToast(resp.ok ? 'ğŸ“ Barge activated â€” joining call' : 'Failed to barge');
    } catch(e) { showToast('Error: Voice stack unavailable'); }
  }

  function showAIAutoDialDialog() {
    const dialog = document.getElementById('aiAutoDialDialog');
    if (dialog) dialog.style.display = 'flex';
  }

  function closeAIAutoDialDialog() {
    const dialog = document.getElementById('aiAutoDialDialog');
    if (dialog) dialog.style.display = 'none';
  }

  async function startAIAutoDial() {
    const phone = document.getElementById('aiDialPhoneInput');
    const name = document.getElementById('aiDialNameInput');
    if (!phone || !phone.value.trim()) { showToast('Enter a phone number'); return; }
    try {
      const resp = await fetch('https://debt-voice-stack.fly.dev/api/calls/outbound-ai', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ phone_number: phone.value.trim(), lead_name: name ? name.value.trim() : '' })
      });
      if (resp.ok) {
        showToast('ğŸ¤– AI outbound call initiated!');
        closeAIAutoDialDialog();
        phone.value = '';
        if (name) name.value = '';
      } else {
        showToast('Failed to initiate AI call');
      }
    } catch(e) { showToast('Error: Voice stack unavailable'); }
  }

  // Expose functions to window for onclick handlers
  window.assignLeads = assignLeads;
  window.bargeIntoCall = bargeIntoCall;
  window.exportTeamReport = exportTeamReport;
  window.listenToCall = listenToCall;
  window.reviewCases = reviewCases;
  window.runComplianceCheck = runComplianceCheck;
  window.sortTable = sortTable;
  window.whisperToCall = whisperToCall;
  window.aiListen = aiListen;
  window.aiWhisperToggle = aiWhisperToggle;
  window.aiWhisperSend = aiWhisperSend;
  window.aiBarge = aiBarge;
  window.showAIAutoDialDialog = showAIAutoDialDialog;
  window.closeAIAutoDialDialog = closeAIAutoDialDialog;
  window.startAIAutoDial = startAIAutoDial;
})();
</script>
