<!-- CASE MANAGEMENT - P0 PRIORITY - Bankruptcy-Grade Case Tracking -->
<div id="caseManagement" class="page-container">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap');

    /* Layout */
    .case-layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 20px;
      height: calc(100vh - 180px);
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Case List Panel */
    .case-list-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow: hidden;
    }

    .case-search-bar {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(10px);
    }

    .case-search-input {
      width: 100%;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 10px;
      padding: 12px 16px;
      color: white;
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }

    .case-search-input:focus {
      border-color: rgba(59, 130, 246, 0.5);
      background: rgba(30, 41, 59, 0.8);
    }

    .case-filters {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .filter-chip {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 6px 12px;
      color: #94A3B8;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-chip:hover,
    .filter-chip.active {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.5);
      color: white;
    }

    .case-list-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 8px;
    }

    .case-list-container::-webkit-scrollbar {
      width: 6px;
    }

    .case-list-container::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.4);
      border-radius: 10px;
    }

    .case-list-container::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.3);
      border-radius: 10px;
    }

    .case-list-container::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.5);
    }

    .case-card {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .case-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #3B82F6, #06B6D4);
    }

    .case-card:hover {
      transform: translateX(4px);
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
    }

    .case-card.active {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
      border-color: rgba(59, 130, 246, 0.6);
    }

    .case-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .case-number {
      font-family: 'Orbitron', monospace;
      font-size: 13px;
      color: #3B82F6;
      font-weight: 600;
    }

    .case-type-badge {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.4);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 10px;
      color: #3B82F6;
      text-transform: uppercase;
      font-weight: 600;
    }

    .case-type-badge.ch7 { background: rgba(168, 85, 247, 0.2); border-color: rgba(168, 85, 247, 0.4); color: #A855F7; }
    .case-type-badge.ch13 { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4); color: #3B82F6; }
    .case-type-badge.consolidation { background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #22C55E; }
    .case-type-badge.settlement { background: rgba(245, 158, 11, 0.2); border-color: rgba(245, 158, 11, 0.4); color: #F59E0B; }

    .case-client-name {
      font-size: 15px;
      color: white;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .case-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: #64748B;
      margin-bottom: 8px;
    }

    .case-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .case-status {
      display: inline-block;
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.4);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 11px;
      color: #22C55E;
      font-weight: 600;
    }

    .case-status.active { background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #22C55E; }
    .case-status.negotiating { background: rgba(245, 158, 11, 0.2); border-color: rgba(245, 158, 11, 0.4); color: #F59E0B; }
    .case-status.settled { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4); color: #3B82F6; }
    .case-status.closed { background: rgba(100, 116, 139, 0.2); border-color: rgba(100, 116, 139, 0.4); color: #64748B; }

    /* Case Detail Panel */
    .case-detail-panel {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(10px);
      overflow-y: auto;
    }

    .case-detail-panel::-webkit-scrollbar {
      width: 8px;
    }

    .case-detail-panel::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.4);
      border-radius: 10px;
    }

    .case-detail-panel::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.3);
      border-radius: 10px;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }

    .detail-title {
      font-size: 24px;
      color: white;
      font-weight: 700;
    }

    .detail-subtitle {
      font-size: 14px;
      color: #64748B;
      margin-top: 4px;
    }

    .detail-actions {
      display: flex;
      gap: 8px;
    }

    .detail-action-btn {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.4);
      border-radius: 8px;
      padding: 8px 16px;
      color: #3B82F6;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .detail-action-btn:hover {
      background: rgba(59, 130, 246, 0.3);
      border-color: rgba(59, 130, 246, 0.6);
      transform: translateY(-2px);
    }

    /* Tabs */
    .case-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }

    .case-tab {
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      padding: 12px 20px;
      color: #64748B;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .case-tab:hover {
      color: #94A3B8;
    }

    .case-tab.active {
      color: white;
      border-bottom-color: #3B82F6;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    .tab-content.active {
      display: block;
    }

    /* Overview Tab */
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .overview-card {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 16px;
    }

    .overview-label {
      font-size: 12px;
      color: #64748B;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .overview-value {
      font-size: 20px;
      color: white;
      font-weight: 700;
      font-family: 'Orbitron', monospace;
    }

    .overview-value.amount {
      background: linear-gradient(135deg, #22C55E, #10B981);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Creditors Table */
    .creditors-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }

    .creditors-table thead th {
      background: rgba(30, 41, 59, 0.5);
      padding: 12px;
      text-align: left;
      color: #64748B;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }

    .creditors-table tbody tr {
      background: rgba(30, 41, 59, 0.3);
      transition: all 0.3s;
    }

    .creditors-table tbody tr:hover {
      background: rgba(30, 41, 59, 0.5);
      transform: translateX(4px);
    }

    .creditors-table tbody td {
      padding: 14px 12px;
      color: white;
      font-size: 13px;
      border-top: 1px solid rgba(59, 130, 246, 0.1);
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
    }

    .creditors-table tbody td:first-child {
      border-left: 1px solid rgba(59, 130, 246, 0.1);
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }

    .creditors-table tbody td:last-child {
      border-right: 1px solid rgba(59, 130, 246, 0.1);
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    .creditor-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .creditor-status.active { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
    .creditor-status.negotiating { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
    .creditor-status.settled { background: rgba(34, 197, 94, 0.2); color: #22C55E; }
    .creditor-status.paid { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }

    /* Payments Table */
    .payments-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }

    .payments-table thead th {
      background: rgba(30, 41, 59, 0.5);
      padding: 12px;
      text-align: left;
      color: #64748B;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }

    .payments-table tbody tr {
      background: rgba(30, 41, 59, 0.3);
      transition: all 0.3s;
    }

    .payments-table tbody tr:hover {
      background: rgba(30, 41, 59, 0.5);
    }

    .payments-table tbody td {
      padding: 12px;
      color: white;
      font-size: 13px;
      border-top: 1px solid rgba(59, 130, 246, 0.1);
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
    }

    .payments-table tbody td:first-child {
      border-left: 1px solid rgba(59, 130, 246, 0.1);
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }

    .payments-table tbody td:last-child {
      border-right: 1px solid rgba(59, 130, 246, 0.1);
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    .payment-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .payment-status.received { background: rgba(34, 197, 94, 0.2); color: #22C55E; }
    .payment-status.pending { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
    .payment-status.failed { background: rgba(239, 68, 68, 0.2); color: #EF4444; }

    /* Documents Grid */
    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .document-card {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .document-card:hover {
      background: rgba(30, 41, 59, 0.7);
      border-color: rgba(59, 130, 246, 0.4);
      transform: translateY(-4px);
    }

    .document-icon {
      width: 48px;
      height: 48px;
      background: rgba(59, 130, 246, 0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    .document-name {
      font-size: 13px;
      color: white;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .document-meta {
      font-size: 11px;
      color: #64748B;
    }

    /* Notes Feed */
    .notes-feed {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .note-item {
      background: rgba(30, 41, 59, 0.3);
      border-left: 3px solid #3B82F6;
      border-radius: 8px;
      padding: 16px;
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .note-author {
      font-size: 13px;
      color: #3B82F6;
      font-weight: 600;
    }

    .note-timestamp {
      font-size: 11px;
      color: #64748B;
    }

    .note-text {
      font-size: 14px;
      color: #E2E8F0;
      line-height: 1.6;
    }

    /* Timeline */
    .timeline {
      position: relative;
      padding-left: 30px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(180deg, #3B82F6, rgba(59, 130, 246, 0.2));
    }

    .timeline-item {
      position: relative;
      margin-bottom: 24px;
    }

    .timeline-dot {
      position: absolute;
      left: -24px;
      top: 4px;
      width: 12px;
      height: 12px;
      background: #3B82F6;
      border: 2px solid rgba(15, 23, 42, 1);
      border-radius: 50%;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
    }

    .timeline-content {
      background: rgba(30, 41, 59, 0.3);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 12px 16px;
    }

    .timeline-title {
      font-size: 14px;
      color: white;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .timeline-description {
      font-size: 12px;
      color: #94A3B8;
      margin-bottom: 6px;
    }

    .timeline-timestamp {
      font-size: 11px;
      color: #64748B;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      width: 80px;
      height: 80px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .empty-title {
      font-size: 18px;
      color: white;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-description {
      font-size: 14px;
      color: #64748B;
      margin-bottom: 24px;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 20px;
      padding: 32px;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }

    .modal-title {
      font-size: 22px;
      color: white;
      font-weight: 700;
    }

    .modal-close {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 8px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #EF4444;
      cursor: pointer;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: rotate(90deg);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      font-size: 13px;
      color: #94A3B8;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 10px 14px;
      color: white;
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: rgba(59, 130, 246, 0.5);
      background: rgba(30, 41, 59, 0.7);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .creditor-row {
      background: rgba(30, 41, 59, 0.3);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      display: grid;
      grid-template-columns: 2fr 1.5fr 1.5fr 1fr auto;
      gap: 12px;
      align-items: end;
    }

    .btn {
      background: linear-gradient(135deg, #3B82F6, #2563EB);
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .btn:hover {
      background: linear-gradient(135deg, #2563EB, #1D4ED8);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.4);
      color: #3B82F6;
    }

    .btn-secondary:hover {
      background: rgba(59, 130, 246, 0.3);
      box-shadow: none;
    }

    .btn-danger {
      background: linear-gradient(135deg, #EF4444, #DC2626);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #DC2626, #B91C1C);
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
    }

    .add-btn {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: #22C55E;
      margin-top: 8px;
    }

    .add-btn:hover {
      background: rgba(34, 197, 94, 0.3);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .top-bar h2 {
      font-size: 28px;
      color: white;
      font-weight: 700;
    }
  </style>

  <!-- Top Bar -->
  <div class="top-bar">
    <h2>Case Management</h2>
    <button class="btn" onclick="openAddCaseModal()">
      <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
      Add Case
    </button>
  </div>

  <!-- Main Layout -->
  <div class="case-layout">
    <!-- Case List Panel -->
    <div class="case-list-panel">
      <div class="case-search-bar">
        <input 
          type="text" 
          class="case-search-input" 
          placeholder="Search cases by name, number, or status..."
          id="caseSearchInput"
          oninput="filterCases()"
        >
        <div class="case-filters">
          <div class="filter-chip active" data-type="all" onclick="selectFilter(this, 'all')">All</div>
          <div class="filter-chip" data-type="ch7" onclick="selectFilter(this, 'ch7')">Chapter 7</div>
          <div class="filter-chip" data-type="ch13" onclick="selectFilter(this, 'ch13')">Chapter 13</div>
          <div class="filter-chip" data-type="consolidation" onclick="selectFilter(this, 'consolidation')">Consolidation</div>
          <div class="filter-chip" data-type="settlement" onclick="selectFilter(this, 'settlement')">Settlement</div>
        </div>
      </div>

      <div class="case-list-container" id="caseListContainer">
        <!-- Cases populated by JavaScript -->
      </div>
    </div>

    <!-- Case Detail Panel -->
    <div class="case-detail-panel" id="caseDetailPanel">
      <div id="caseDetailContent">
        <div class="empty-state">
          <div class="empty-icon">
            <i data-lucide="briefcase" style="width: 40px; height: 40px; color: #3B82F6;"></i>
          </div>
          <div class="empty-title">No Case Selected</div>
          <div class="empty-description">Select a case from the list to view details</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Case Modal -->
  <div class="modal-overlay" id="addCaseModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add New Case</h3>
        <div class="modal-close" onclick="closeAddCaseModal()">
          <i data-lucide="x" style="width: 18px; height: 18px;"></i>
        </div>
      </div>

      <form id="addCaseForm" onsubmit="submitAddCase(event)">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Client Name</label>
            <input type="text" class="form-input" name="clientName" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" name="email" required>
          </div>
          <div class="form-group">
            <label class="form-label">Phone</label>
            <input type="tel" class="form-input" name="phone" required>
          </div>
          <div class="form-group">
            <label class="form-label">Case Type</label>
            <select class="form-select" name="caseType" required>
              <option value="">Select Type</option>
              <option value="ch7">Chapter 7</option>
              <option value="ch13">Chapter 13</option>
              <option value="consolidation">Debt Consolidation</option>
              <option value="settlement">Debt Settlement</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label class="form-label">Address</label>
            <input type="text" class="form-input" name="address">
          </div>
          <div class="form-group">
            <label class="form-label">Total Debt</label>
            <input type="number" class="form-input" name="totalDebt" step="0.01" required>
          </div>
          <div class="form-group">
            <label class="form-label">Assigned Agent</label>
            <select class="form-select" name="assignedAgent" id="agentSelect" required>
              <option value="">Select Agent</option>
            </select>
          </div>
        </div>

        <div class="form-group full-width" style="margin-top: 16px;">
          <label class="form-label">Creditors</label>
          <div id="creditorsContainer">
            <div class="creditor-row">
              <div class="form-group" style="margin: 0;">
                <input type="text" class="form-input" placeholder="Creditor Name (e.g., Chase)" name="creditorName[]" required>
              </div>
              <div class="form-group" style="margin: 0;">
                <input type="text" class="form-input" placeholder="Account Number" name="creditorAccount[]">
              </div>
              <div class="form-group" style="margin: 0;">
                <input type="number" class="form-input" placeholder="Balance" name="creditorBalance[]" step="0.01" required>
              </div>
              <div class="form-group" style="margin: 0;">
                <select class="form-select" name="creditorStatus[]">
                  <option value="active">Active</option>
                  <option value="negotiating">Negotiating</option>
                  <option value="settled">Settled</option>
                  <option value="paid">Paid</option>
                </select>
              </div>
              <button type="button" class="btn-danger btn-icon" onclick="removeCreditorRow(this)" title="Remove">
                <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
              </button>
            </div>
          </div>
          <button type="button" class="btn add-btn" onclick="addCreditorRow()">
            <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
            Add Creditor
          </button>
        </div>

        <div class="form-group full-width" style="margin-top: 16px;">
          <label class="form-label">Initial Notes</label>
          <textarea class="form-textarea" name="notes" placeholder="Add any initial case notes..."></textarea>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button type="button" class="btn btn-secondary" onclick="closeAddCaseModal()">Cancel</button>
          <button type="submit" class="btn">Create Case</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Payment Modal -->
  <div class="modal-overlay" id="addPaymentModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Payment</h3>
        <div class="modal-close" onclick="closeAddPaymentModal()">
          <i data-lucide="x" style="width: 18px; height: 18px;"></i>
        </div>
      </div>

      <form id="addPaymentForm" onsubmit="submitAddPayment(event)">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Amount</label>
            <input type="number" class="form-input" name="amount" step="0.01" required>
          </div>
          <div class="form-group">
            <label class="form-label">Date</label>
            <input type="date" class="form-input" name="date" required>
          </div>
          <div class="form-group">
            <label class="form-label">Method</label>
            <select class="form-select" name="method" required>
              <option value="Credit Card">Credit Card</option>
              <option value="ACH">ACH</option>
              <option value="Wire Transfer">Wire Transfer</option>
              <option value="Check">Check</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" name="status" required>
              <option value="received">Received</option>
              <option value="pending">Pending</option>
              <option value="failed">Failed</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label class="form-label">Notes</label>
            <textarea class="form-textarea" name="notes" placeholder="Payment notes..."></textarea>
          </div>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button type="button" class="btn btn-secondary" onclick="closeAddPaymentModal()">Cancel</button>
          <button type="submit" class="btn">Add Payment</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Note Modal -->
  <div class="modal-overlay" id="addNoteModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Note</h3>
        <div class="modal-close" onclick="closeAddNoteModal()">
          <i data-lucide="x" style="width: 18px; height: 18px;"></i>
        </div>
      </div>

      <form id="addNoteForm" onsubmit="submitAddNote(event)">
        <div class="form-group">
          <label class="form-label">Note</label>
          <textarea class="form-textarea" name="note" placeholder="Enter case note..." required style="min-height: 120px;"></textarea>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button type="button" class="btn btn-secondary" onclick="closeAddNoteModal()">Cancel</button>
          <button type="submit" class="btn">Add Note</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Document Modal -->
  <div class="modal-overlay" id="addDocumentModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Upload Document</h3>
        <div class="modal-close" onclick="closeAddDocumentModal()">
          <i data-lucide="x" style="width: 18px; height: 18px;"></i>
        </div>
      </div>

      <form id="addDocumentForm" onsubmit="submitAddDocument(event)">
        <div class="form-grid">
          <div class="form-group full-width">
            <label class="form-label">Document Name</label>
            <input type="text" class="form-input" name="name" required placeholder="e.g., 2024 Tax Return">
          </div>
          <div class="form-group full-width">
            <label class="form-label">Category</label>
            <select class="form-select" name="category" required>
              <option value="">Select Category</option>
              <option value="Financial Statements">Financial Statements</option>
              <option value="Tax Returns">Tax Returns</option>
              <option value="Pay Stubs">Pay Stubs</option>
              <option value="Creditor Letters">Creditor Letters</option>
              <option value="Court Documents">Court Documents</option>
              <option value="Settlement Letters">Settlement Letters</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label class="form-label">File (Simulated Upload)</label>
            <input type="text" class="form-input" name="filename" required placeholder="Enter filename (e.g., tax_return_2024.pdf)">
          </div>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button type="button" class="btn btn-secondary" onclick="closeAddDocumentModal()">Cancel</button>
          <button type="submit" class="btn">Upload Document</button>
        </div>
      </form>
    </div>
  </div>

  <script>
(function() {
'use strict';

    // State
    let cases = [];
    let selectedCase = null;
    let selectedFilter = 'all';

    // Initialize
    function initCaseManagement() {
      loadCases();
      loadAgents();
      renderCaseList();
      lucide.createIcons();
    }

    // Load cases from DebtDB
    function loadCases() {
      cases = (window.DebtDB?.getCases?.() || []) || [];
      
      // If no cases, seed some demo data
      if (cases.length === 0) {
        seedDemoCases();
        cases = (window.DebtDB?.getCases?.() || []);
      }
    }

    // Seed demo cases
    function seedDemoCases() {
      const demoCreditors = [
        { name: 'Chase Bank', account: '****4521', balance: 12500, status: 'active' },
        { name: 'Capital One', account: '****8932', balance: 8900, status: 'negotiating' },
        { name: 'Bank of America', account: '****1203', balance: 15600, status: 'active' },
        { name: 'Discover', account: '****7845', balance: 6200, status: 'settled' },
        { name: 'Citibank', account: '****3421', balance: 10300, status: 'active' }
      ];

      const demoCases = [
        {
          client: 'Michael Rodriguez',
          email: 'michael.r@email.com',
          phone: '(305) 555-0123',
          address: '1234 Main St, Miami, FL 33101',
          caseType: 'ch7',
          totalDebt: 45200,
          status: 'Active',
          assignedAgent: 'agent_001',
          creditors: [demoCreditors[0], demoCreditors[1], demoCreditors[3]]
        },
        {
          client: 'Sarah Johnson',
          email: 'sarah.j@email.com',
          phone: '(312) 555-0456',
          address: '5678 Oak Ave, Chicago, IL 60601',
          caseType: 'ch13',
          totalDebt: 67800,
          status: 'Negotiating',
          assignedAgent: 'agent_002',
          creditors: [demoCreditors[2], demoCreditors[4]]
        },
        {
          client: 'David Chen',
          email: 'david.c@email.com',
          phone: '(415) 555-0789',
          address: '9012 Pine St, San Francisco, CA 94102',
          caseType: 'consolidation',
          totalDebt: 32100,
          status: 'Active',
          assignedAgent: 'agent_001',
          creditors: [demoCreditors[1], demoCreditors[3]]
        },
        {
          client: 'Emily Martinez',
          email: 'emily.m@email.com',
          phone: '(786) 555-0234',
          address: '3456 Beach Rd, Miami Beach, FL 33139',
          caseType: 'settlement',
          totalDebt: 28900,
          status: 'Settled',
          assignedAgent: 'agent_003',
          creditors: [demoCreditors[0], demoCreditors[2]]
        }
      ];

      demoCases.forEach(caseData => {
        window.DebtDB?.addCase?.(caseData);
      });
    }

    // Load agents for dropdown
    function loadAgents() {
      const agents = window.DebtDB.getAgents() || [];
      const select = document.getElementById('agentSelect');
      
      agents.forEach(agent => {
        const option = document.createElement('option');
        option.value = agent.id;
        option.textContent = agent.name;
        select.appendChild(option);
      });
    }

    // Render case list
    function renderCaseList() {
      const container = document.getElementById('caseListContainer');
      const searchTerm = document.getElementById('caseSearchInput').value.toLowerCase();

      let filteredCases = cases.filter(c => {
        const matchesSearch = !searchTerm || 
          c.client.toLowerCase().includes(searchTerm) ||
          c.id.toLowerCase().includes(searchTerm) ||
          c.status.toLowerCase().includes(searchTerm);

        const matchesFilter = selectedFilter === 'all' || c.caseType === selectedFilter;

        return matchesSearch && matchesFilter;
      });

      if (filteredCases.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 40px 20px;">
            <div class="empty-icon" style="width: 60px; height: 60px; margin: 0 auto 16px;">
              <i data-lucide="search" style="width: 30px; height: 30px; color: #3B82F6;"></i>
            </div>
            <div class="empty-title" style="font-size: 16px;">No cases found</div>
            <div class="empty-description">Try adjusting your search or filters</div>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      container.innerHTML = filteredCases.map(caseItem => `
        <div class="case-card ${selectedCase?.id === caseItem.id ? 'active' : ''}" onclick="selectCase('${caseItem.id}')">
          <div class="case-card-header">
            <div class="case-number">${caseItem.id}</div>
            <div class="case-type-badge ${caseItem.caseType}">
              ${getCaseTypeLabel(caseItem.caseType)}
            </div>
          </div>
          <div class="case-client-name">${caseItem.client}</div>
          <div class="case-meta">
            <div class="case-meta-item">
              <i data-lucide="dollar-sign" style="width: 14px; height: 14px;"></i>
              $${(caseItem.totalDebt || 0).toLocaleString()}
            </div>
            <div class="case-meta-item">
              <i data-lucide="calendar" style="width: 14px; height: 14px;"></i>
              ${new Date(caseItem.createdAt).toLocaleDateString()}
            </div>
          </div>
          <div class="case-status ${caseItem.status.toLowerCase().replace(' ', '-')}">${caseItem.status}</div>
        </div>
      `).join('');

      lucide.createIcons();
    }

    // Get case type label
    function getCaseTypeLabel(type) {
      const labels = {
        'ch7': 'Chapter 7',
        'ch13': 'Chapter 13',
        'consolidation': 'Consolidation',
        'settlement': 'Settlement'
      };
      return labels[type] || type;
    }

    // Select case
    function selectCase(caseId) {
      selectedCase = cases.find(c => c.id === caseId);
      if (selectedCase) {
        renderCaseDetail();
        renderCaseList(); // Re-render to update active state
      }
    }

    // Render case detail
    function renderCaseDetail() {
      if (!selectedCase) return;

      const agents = window.DebtDB.getAgents() || [];
      const agent = agents.find(a => a.id === selectedCase.assignedAgent);
      const agentName = agent ? agent.name : 'Unassigned';

      const totalDebt = selectedCase.totalDebt || 0;
      const creditors = selectedCase.creditors || [];
      const settledAmount = creditors
        .filter(c => c.status === 'settled' && c.settledAmount)
        .reduce((sum, c) => sum + c.settledAmount, 0);
      const savings = totalDebt - settledAmount;
      const savingsPercent = totalDebt > 0 ? ((savings / totalDebt) * 100).toFixed(1) : 0;

      const payments = selectedCase.payments || [];
      const notes = selectedCase.notes || [];
      const documents = selectedCase.documents || [];

      const content = `
        <div class="detail-header">
          <div>
            <div class="detail-title">${selectedCase.client}</div>
            <div class="detail-subtitle">Case ${selectedCase.id} • ${getCaseTypeLabel(selectedCase.caseType)}</div>
          </div>
          <div class="detail-actions">
            <button class="detail-action-btn" onclick="callClient()">
              <i data-lucide="phone" style="width: 16px; height: 16px;"></i>
              Call
            </button>
            <button class="detail-action-btn" onclick="emailClient()">
              <i data-lucide="mail" style="width: 16px; height: 16px;"></i>
              Email
            </button>
            <button class="detail-action-btn" onclick="updateCaseStatus()">
              <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
              Update Status
            </button>
          </div>
        </div>

        <div class="case-tabs">
          <button class="case-tab active" onclick="switchTab('overview')">Overview</button>
          <button class="case-tab" onclick="switchTab('creditors')">Creditors</button>
          <button class="case-tab" onclick="switchTab('payments')">Payments</button>
          <button class="case-tab" onclick="switchTab('documents')">Documents</button>
          <button class="case-tab" onclick="switchTab('notes')">Notes</button>
          <button class="case-tab" onclick="switchTab('timeline')">Timeline</button>
        </div>

        <!-- Overview Tab -->
        <div id="tabOverview" class="tab-content active">
          <div class="overview-grid">
            <div class="overview-card">
              <div class="overview-label">Total Debt</div>
              <div class="overview-value amount">$${totalDebt.toLocaleString()}</div>
            </div>
            <div class="overview-card">
              <div class="overview-label">Settled Amount</div>
              <div class="overview-value amount">$${settledAmount.toLocaleString()}</div>
            </div>
            <div class="overview-card">
              <div class="overview-label">Savings</div>
              <div class="overview-value amount">${savingsPercent}%</div>
            </div>
          </div>

          <div style="background: rgba(30, 41, 59, 0.3); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h4 style="color: white; font-size: 16px; font-weight: 600; margin-bottom: 16px;">Client Information</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div>
                <div style="font-size: 12px; color: #64748B; margin-bottom: 4px;">Email</div>
                <div style="color: white; font-size: 14px;">${selectedCase.email}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748B; margin-bottom: 4px;">Phone</div>
                <div style="color: white; font-size: 14px;">${selectedCase.phone}</div>
              </div>
              <div style="grid-column: 1 / -1;">
                <div style="font-size: 12px; color: #64748B; margin-bottom: 4px;">Address</div>
                <div style="color: white; font-size: 14px;">${selectedCase.address || 'Not provided'}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748B; margin-bottom: 4px;">Assigned Agent</div>
                <div style="color: white; font-size: 14px;">${agentName}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748B; margin-bottom: 4px;">Status</div>
                <div class="case-status ${selectedCase.status.toLowerCase().replace(' ', '-')}">${selectedCase.status}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Creditors Tab -->
        <div id="tabCreditors" class="tab-content">
          <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
            <button class="btn btn-secondary" onclick="addCreditor()">
              <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
              Add Creditor
            </button>
          </div>
          <table class="creditors-table">
            <thead>
              <tr>
                <th>Creditor</th>
                <th>Account</th>
                <th>Original Balance</th>
                <th>Current Balance</th>
                <th>Offer</th>
                <th>Settled</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${creditors.length === 0 ? `
                <tr>
                  <td colspan="7" style="text-align: center; padding: 40px; color: #64748B;">
                    No creditors added yet
                  </td>
                </tr>
              ` : creditors.map(cred => `
                <tr>
                  <td style="font-weight: 600;">${cred.name}</td>
                  <td>${cred.account || 'N/A'}</td>
                  <td>$${(cred.balance || 0).toLocaleString()}</td>
                  <td>$${(cred.currentBalance || cred.balance || 0).toLocaleString()}</td>
                  <td>${cred.offer ? '$' + cred.offer.toLocaleString() : '—'}</td>
                  <td>${cred.settledAmount ? '$' + cred.settledAmount.toLocaleString() : '—'}</td>
                  <td><span class="creditor-status ${cred.status}">${cred.status}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <!-- Payments Tab -->
        <div id="tabPayments" class="tab-content">
          <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
            <button class="btn btn-secondary" onclick="openAddPaymentModal()">
              <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
              Add Payment
            </button>
          </div>
          <table class="payments-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Status</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              ${payments.length === 0 ? `
                <tr>
                  <td colspan="5" style="text-align: center; padding: 40px; color: #64748B;">
                    No payments recorded yet
                  </td>
                </tr>
              ` : payments.map(payment => `
                <tr>
                  <td>${new Date(payment.createdAt).toLocaleDateString()}</td>
                  <td style="font-weight: 600; color: #22C55E;">$${payment.amount.toLocaleString()}</td>
                  <td>${payment.method || 'N/A'}</td>
                  <td><span class="payment-status ${payment.status}">${payment.status}</span></td>
                  <td style="color: #94A3B8;">${payment.notes || '—'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <!-- Documents Tab -->
        <div id="tabDocuments" class="tab-content">
          <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
            <button class="btn btn-secondary" onclick="openAddDocumentModal()">
              <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
              Upload Document
            </button>
          </div>
          ${documents.length === 0 ? `
            <div class="empty-state">
              <div class="empty-icon">
                <i data-lucide="file-text" style="width: 40px; height: 40px; color: #3B82F6;"></i>
              </div>
              <div class="empty-title">No Documents</div>
              <div class="empty-description">Upload financial statements, tax returns, or court documents</div>
            </div>
          ` : `
            <div class="documents-grid">
              ${documents.map(doc => `
                <div class="document-card">
                  <div class="document-icon">
                    <i data-lucide="file-text" style="width: 24px; height: 24px; color: #3B82F6;"></i>
                  </div>
                  <div class="document-name">${doc.name}</div>
                  <div class="document-meta">${doc.category}</div>
                  <div class="document-meta">${new Date(doc.uploadedAt).toLocaleDateString()}</div>
                </div>
              `).join('')}
            </div>
          `}
        </div>

        <!-- Notes Tab -->
        <div id="tabNotes" class="tab-content">
          <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
            <button class="btn btn-secondary" onclick="openAddNoteModal()">
              <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
              Add Note
            </button>
          </div>
          ${notes.length === 0 ? `
            <div class="empty-state">
              <div class="empty-icon">
                <i data-lucide="message-square" style="width: 40px; height: 40px; color: #3B82F6;"></i>
              </div>
              <div class="empty-title">No Notes</div>
              <div class="empty-description">Add case notes and updates</div>
            </div>
          ` : `
            <div class="notes-feed">
              ${notes.map(note => `
                <div class="note-item">
                  <div class="note-header">
                    <div class="note-author">${note.createdBy || 'System'}</div>
                    <div class="note-timestamp">${new Date(note.createdAt).toLocaleString()}</div>
                  </div>
                  <div class="note-text">${note.text}</div>
                </div>
              `).join('')}
            </div>
          `}
        </div>

        <!-- Timeline Tab -->
        <div id="tabTimeline" class="tab-content">
          <div class="timeline">
            ${generateTimeline(selectedCase)}
          </div>
        </div>
      `;

      document.getElementById('caseDetailContent').innerHTML = content;
      lucide.createIcons();
    }

    // Generate timeline
    function generateTimeline(caseItem) {
      const events = [];

      // Case created
      events.push({
        title: 'Case Created',
        description: `${getCaseTypeLabel(caseItem.caseType)} case opened`,
        timestamp: caseItem.createdAt
      });

      // Notes
      (caseItem.notes || []).forEach(note => {
        events.push({
          title: 'Note Added',
          description: note.text,
          timestamp: note.createdAt
        });
      });

      // Payments
      (caseItem.payments || []).forEach(payment => {
        events.push({
          title: 'Payment Received',
          description: `$${payment.amount.toLocaleString()} via ${payment.method}`,
          timestamp: payment.createdAt
        });
      });

      // Documents
      (caseItem.documents || []).forEach(doc => {
        events.push({
          title: 'Document Uploaded',
          description: `${doc.name} (${doc.category})`,
          timestamp: doc.uploadedAt
        });
      });

      // Sort by timestamp (newest first)
      events.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      if (events.length === 0) {
        return `
          <div class="empty-state">
            <div class="empty-icon">
              <i data-lucide="clock" style="width: 40px; height: 40px; color: #3B82F6;"></i>
            </div>
            <div class="empty-title">No Timeline Events</div>
            <div class="empty-description">Case activity will appear here</div>
          </div>
        `;
      }

      return events.map(event => `
        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div class="timeline-content">
            <div class="timeline-title">${event.title}</div>
            <div class="timeline-description">${event.description}</div>
            <div class="timeline-timestamp">${new Date(event.timestamp).toLocaleString()}</div>
          </div>
        </div>
      `).join('');
    }

    // Switch tab
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.case-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.toLowerCase().includes(tabName.toLowerCase())) tab.classList.add('active');
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');

      lucide.createIcons();
    }

    // Filter cases
    function selectFilter(chip, type) {
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      selectedFilter = type;
      renderCaseList();
    }

    function filterCases() {
      renderCaseList();
    }

    // Modals
    function openAddCaseModal() {
      document.getElementById('addCaseModal').classList.add('active');
      lucide.createIcons();
    }

    function closeAddCaseModal() {
      document.getElementById('addCaseModal').classList.remove('active');
      document.getElementById('addCaseForm').reset();
    }

    function openAddPaymentModal() {
      document.getElementById('addPaymentModal').classList.add('active');
      lucide.createIcons();
    }

    function closeAddPaymentModal() {
      document.getElementById('addPaymentModal').classList.remove('active');
      document.getElementById('addPaymentForm').reset();
    }

    function openAddNoteModal() {
      document.getElementById('addNoteModal').classList.add('active');
      lucide.createIcons();
    }

    function closeAddNoteModal() {
      document.getElementById('addNoteModal').classList.remove('active');
      document.getElementById('addNoteForm').reset();
    }

    function openAddDocumentModal() {
      document.getElementById('addDocumentModal').classList.add('active');
      lucide.createIcons();
    }

    function closeAddDocumentModal() {
      document.getElementById('addDocumentModal').classList.remove('active');
      document.getElementById('addDocumentForm').reset();
    }

    // Add/Remove creditor rows
    function addCreditorRow() {
      const container = document.getElementById('creditorsContainer');
      const row = document.createElement('div');
      row.className = 'creditor-row';
      row.innerHTML = `
        <div class="form-group" style="margin: 0;">
          <input type="text" class="form-input" placeholder="Creditor Name" name="creditorName[]" required>
        </div>
        <div class="form-group" style="margin: 0;">
          <input type="text" class="form-input" placeholder="Account Number" name="creditorAccount[]">
        </div>
        <div class="form-group" style="margin: 0;">
          <input type="number" class="form-input" placeholder="Balance" name="creditorBalance[]" step="0.01" required>
        </div>
        <div class="form-group" style="margin: 0;">
          <select class="form-select" name="creditorStatus[]">
            <option value="active">Active</option>
            <option value="negotiating">Negotiating</option>
            <option value="settled">Settled</option>
            <option value="paid">Paid</option>
          </select>
        </div>
        <button type="button" class="btn-danger btn-icon" onclick="removeCreditorRow(this)" title="Remove">
          <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
        </button>
      `;
      container.appendChild(row);
      lucide.createIcons();
    }

    function removeCreditorRow(btn) {
      const row = btn.closest('.creditor-row');
      const container = document.getElementById('creditorsContainer');
      if (container.children.length > 1) {
        row.remove();
      } else {
        Toast.warning('At least one creditor is required');
      }
    }

    // Form submissions
    function submitAddCase(e) {
      e.preventDefault();
      const formData = new FormData(e.target);

      // Collect creditors
      const creditors = [];
      const creditorNames = formData.getAll('creditorName[]');
      const creditorAccounts = formData.getAll('creditorAccount[]');
      const creditorBalances = formData.getAll('creditorBalance[]');
      const creditorStatuses = formData.getAll('creditorStatus[]');

      for (let i = 0; i < creditorNames.length; i++) {
        creditors.push({
          name: creditorNames[i],
          account: creditorAccounts[i],
          balance: parseFloat(creditorBalances[i]),
          currentBalance: parseFloat(creditorBalances[i]),
          status: creditorStatuses[i]
        });
      }

      const caseData = {
        client: formData.get('clientName'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        address: formData.get('address'),
        caseType: formData.get('caseType'),
        totalDebt: parseFloat(formData.get('totalDebt')),
        assignedAgent: formData.get('assignedAgent'),
        status: 'Active',
        creditors: creditors,
        notes: formData.get('notes') ? [{
          text: formData.get('notes'),
          createdAt: new Date().toISOString(),
          createdBy: 'Current User'
        }] : [],
        payments: [],
        documents: []
      };

      const newCase = window.DebtDB?.addCase?.(caseData);
      cases.push(newCase);
      
      closeAddCaseModal();
      renderCaseList();
      selectCase(newCase.id);
      
      Toast.success('Case created successfully!');
    }

    function submitAddPayment(e) {
      e.preventDefault();
      if (!selectedCase) return;

      const formData = new FormData(e.target);
      const paymentData = {
        amount: parseFloat(formData.get('amount')),
        date: formData.get('date'),
        method: formData.get('method'),
        status: formData.get('status'),
        notes: formData.get('notes')
      };

      window.DebtDB?.addCasePayment?.(selectedCase.id, paymentData);
      loadCases();
      selectedCase = cases.find(c => c.id === selectedCase.id);
      
      closeAddPaymentModal();
      renderCaseDetail();
      
      Toast.success('Payment added successfully!');
    }

    function submitAddNote(e) {
      e.preventDefault();
      if (!selectedCase) return;

      const formData = new FormData(e.target);
      const noteText = formData.get('note');

      window.DebtDB?.addCaseNote?.(selectedCase.id, noteText);
      loadCases();
      selectedCase = cases.find(c => c.id === selectedCase.id);
      
      closeAddNoteModal();
      renderCaseDetail();
      
      Toast.success('Note added successfully!');
    }

    function submitAddDocument(e) {
      e.preventDefault();
      if (!selectedCase) return;

      const formData = new FormData(e.target);
      const docData = {
        name: formData.get('name'),
        category: formData.get('category'),
        filename: formData.get('filename')
      };

      window.DebtDB?.addCaseDocument?.(selectedCase.id, docData);
      loadCases();
      selectedCase = cases.find(c => c.id === selectedCase.id);
      
      closeAddDocumentModal();
      renderCaseDetail();
      
      Toast.success('Document uploaded successfully!');
    }

    // Quick actions
    function callClient() {
      Toast.info('Opening Power Dialer...');
      setTimeout(() => {
        window.location.hash = 'power-dialer';
      }, 1000);
    }

    function emailClient() {
      Toast.info('Opening email composer...');
    }

    function updateCaseStatus() {
      const statuses = ['Active', 'Under Review', 'Negotiating', 'Settlement Offered', 'Settled', 'Completed', 'Closed'];
      const currentIndex = statuses.indexOf(selectedCase.status);
      const nextStatus = statuses[(currentIndex + 1) % statuses.length];
      
      window.DebtDB?.updateCase?.(selectedCase.id, { status: nextStatus });
      loadCases();
      selectedCase = cases.find(c => c.id === selectedCase.id);
      
      renderCaseDetail();
      renderCaseList();
      
      Toast.success(`Case status updated to ${nextStatus}`);
    }

    function addCreditor() {
      Toast.info('Add creditor functionality coming soon');
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initCaseManagement);
    
    // Also init immediately if DOM already loaded
    if (document.readyState === 'loading') {
      // Still loading
    } else {
      initCaseManagement();
    }

  // Expose functions to window for onclick handlers
  window.addCreditor = addCreditor;
  window.addCreditorRow = addCreditorRow;
  window.callClient = callClient;
  window.closeAddCaseModal = closeAddCaseModal;
  window.closeAddDocumentModal = closeAddDocumentModal;
  window.closeAddNoteModal = closeAddNoteModal;
  window.closeAddPaymentModal = closeAddPaymentModal;
  window.emailClient = emailClient;
  window.initCaseManagement = initCaseManagement;
  window.openAddCaseModal = openAddCaseModal;
  window.openAddDocumentModal = openAddDocumentModal;
  window.openAddNoteModal = openAddNoteModal;
  window.openAddPaymentModal = openAddPaymentModal;
  window.removeCreditorRow = removeCreditorRow;
  window.selectCase = selectCase;
  window.selectFilter = selectFilter;
  window.switchTab = switchTab;
  window.updateCaseStatus = updateCaseStatus;
  window.filterCases = filterCases;
  window.submitAddCase = submitAddCase;
  window.submitAddPayment = submitAddPayment;
  window.submitAddNote = submitAddNote;
  window.submitAddDocument = submitAddDocument;
})();
</script>
</div>
