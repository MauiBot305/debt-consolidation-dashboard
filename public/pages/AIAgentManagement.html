<!-- AI Agent Management - Command Center -->
<!-- Role: manager, owner only -->

<style>

  .ai-agent-page {
    font-family: 'Inter', sans-serif;
    color: #f1f5f9;
    padding: 1.5rem;
    min-height: 100vh;
  }

  .ai-agent-page .font-orbitron { font-family: 'Orbitron', sans-serif; }

  .ai-agent-page .glass-card-ai {
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(59, 130, 246, 0.1);
    border-radius: 1rem;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .ai-agent-page .glass-card-ai:hover {
    border-color: rgba(59, 130, 246, 0.3);
    box-shadow: 0 12px 48px rgba(59, 130, 246, 0.15), inset 0 1px 0 rgba(255,255,255,0.1);
    transform: translateY(-2px);
  }

  .ai-agent-page .stat-number {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.75rem;
    font-weight: 700;
    background: linear-gradient(135deg, #3B82F6, #06B6D4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .ai-agent-page .section-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.1rem;
    font-weight: 600;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .ai-agent-page .pulse-idle {
    animation: pulseIdle 2s ease-in-out infinite;
  }

  @keyframes pulseIdle {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
  }

  .ai-agent-page .call-timer {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.9rem;
    color: #06B6D4;
  }

  .ai-agent-page .btn-action {
    padding: 0.4rem 0.8rem;
    border: 1px solid rgba(148,163,184,0.2);
    border-radius: 0.5rem;
    background: rgba(30,41,59,0.6);
    color: #f1f5f9;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s;
  }
  .ai-agent-page .btn-action:hover {
    background: rgba(59,130,246,0.2);
    border-color: #3B82F6;
  }

  .ai-agent-page .btn-primary-ai {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 0.5rem;
    background: linear-gradient(135deg, #3B82F6, #06B6D4);
    color: white;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .ai-agent-page .btn-primary-ai:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(59,130,246,0.4);
  }

  .ai-agent-page .btn-danger-ai {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 0.5rem;
    background: linear-gradient(135deg, #EF4444, #DC2626);
    color: white;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .ai-agent-page table {
    width: 100%;
    border-collapse: collapse;
  }
  .ai-agent-page th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #64748b;
    border-bottom: 1px solid rgba(148,163,184,0.1);
  }
  .ai-agent-page td {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    border-bottom: 1px solid rgba(148,163,184,0.05);
    color: #94a3b8;
  }
  .ai-agent-page tr:hover td {
    background: rgba(59,130,246,0.05);
  }
  .ai-agent-page tr { cursor: pointer; }

  .ai-agent-page input, .ai-agent-page textarea, .ai-agent-page select {
    background: rgba(15,23,42,0.6);
    border: 1px solid rgba(148,163,184,0.2);
    border-radius: 0.5rem;
    padding: 0.6rem 0.8rem;
    color: #f1f5f9;
    font-family: 'Inter', sans-serif;
    font-size: 0.875rem;
    width: 100%;
    transition: border-color 0.2s;
  }
  .ai-agent-page input:focus, .ai-agent-page textarea:focus {
    outline: none;
    border-color: #3B82F6;
  }

  .ai-agent-page .sentiment-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .ai-agent-page .sentiment-positive { background: rgba(34,197,94,0.15); color: #22C55E; }
  .ai-agent-page .sentiment-neutral { background: rgba(245,158,11,0.15); color: #F59E0B; }
  .ai-agent-page .sentiment-negative { background: rgba(239,68,68,0.15); color: #EF4444; }

  .ai-agent-page .capacity-bar {
    height: 6px;
    border-radius: 3px;
    background: rgba(148,163,184,0.1);
    overflow: hidden;
  }
  .ai-agent-page .capacity-fill {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, #22C55E, #3B82F6);
    transition: width 0.5s;
  }

  .ai-agent-page .expandable-row { display: none; }
  .ai-agent-page .expandable-row.open { display: table-row; }

  .ai-agent-page .queue-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid rgba(148,163,184,0.05);
  }
</style>

<div class="ai-agent-page" id="aiAgentPage">
  <!-- Access Denied (hidden by default) -->
  <div id="aiAccessDenied" style="display:none; text-align:center; padding:4rem 2rem;">
    <div style="font-size:4rem;">üîí</div>
    <h2 style="font-family:'Orbitron',sans-serif; margin:1rem 0; color:#EF4444;">Access Denied</h2>
    <p style="color:#94a3b8;">This page is restricted to Manager and Owner roles.</p>
  </div>

  <!-- Main Content -->
  <div id="aiAgentContent">
    <!-- 1. Header -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; flex-wrap:wrap; gap:1rem;">
      <div style="display:flex; align-items:center; gap:1rem;">
        <h1 class="font-orbitron" style="font-size:1.5rem; font-weight:700; background:linear-gradient(135deg,#3B82F6,#06B6D4); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
          ü§ñ AI Agent Command Center
        </h1>
        <span id="aiStatusBadge" style="display:inline-flex; align-items:center; gap:0.3rem; padding:0.3rem 0.75rem; border-radius:9999px; background:rgba(34,197,94,0.15); color:#22C55E; font-size:0.8rem; font-weight:600;">
          üü¢ Online
        </span>
      </div>
      <div style="display:flex; align-items:center; gap:1rem;">
        <div>
          <span style="color:#94a3b8; font-size:0.8rem;">Active Calls</span>
          <div style="display:flex; align-items:center; gap:0.5rem;">
            <span id="activeCallCount" class="font-orbitron" style="font-size:1.1rem; color:#06B6D4;">0</span>
            <span style="color:#64748b; font-size:0.8rem;">/50</span>
          </div>
          <div class="capacity-bar" style="width:120px; margin-top:0.25rem;">
            <div id="capacityFill" class="capacity-fill" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Stats Row -->
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:1rem; margin-bottom:2rem;">
      <div class="glass-card-ai" style="padding:1.25rem; text-align:center;">
        <div style="color:#64748b; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem;">Calls Today</div>
        <div id="statCallsToday" class="stat-number">0</div>
      </div>
      <div class="glass-card-ai" style="padding:1.25rem; text-align:center;">
        <div style="color:#64748b; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem;">Avg Handle Time</div>
        <div id="statAvgTime" class="stat-number">0:00</div>
      </div>
      <div class="glass-card-ai" style="padding:1.25rem; text-align:center;">
        <div style="color:#64748b; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem;">Qualification Rate</div>
        <div id="statQualRate" class="stat-number">0%</div>
      </div>
      <div class="glass-card-ai" style="padding:1.25rem; text-align:center;">
        <div style="color:#64748b; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem;">Appointments Set</div>
        <div id="statAppts" class="stat-number">0</div>
      </div>
      <div class="glass-card-ai" style="padding:1.25rem; text-align:center;">
        <div style="color:#64748b; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem;">Revenue Generated</div>
        <div id="statRevenue" class="stat-number">$0</div>
      </div>
      <div class="glass-card-ai" style="padding:1.25rem; text-align:center;">
        <div style="color:#64748b; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem;">Compliance Score</div>
        <div id="statCompliance" class="stat-number">100%</div>
      </div>
    </div>

    <!-- 3. Active Calls Monitor -->
    <div class="glass-card-ai" style="padding:1.5rem; margin-bottom:2rem;">
      <div class="section-title"><i data-lucide="radio" style="width:18px;height:18px;"></i> Active Calls Monitor</div>
      <div id="activeCallsContainer">
        <div class="pulse-idle" style="text-align:center; padding:2rem; color:#64748b;">
          <div style="font-size:2rem; margin-bottom:0.5rem;">üì°</div>
          AI Agent is idle ‚Äî waiting for calls
        </div>
      </div>
    </div>

    <!-- 4. Auto-Dial Section -->
    <div class="glass-card-ai" style="padding:1.5rem; margin-bottom:2rem;">
      <div class="section-title"><i data-lucide="phone-outgoing" style="width:18px;height:18px;"></i> AI Auto-Dial</div>
      <div style="display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-end; margin-bottom:1rem;">
        <div style="flex:1; min-width:200px;">
          <label style="font-size:0.75rem; color:#64748b; display:block; margin-bottom:0.25rem;">Phone Number</label>
          <input type="tel" id="autoDialPhone" placeholder="+1 (555) 000-0000" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label style="font-size:0.75rem; color:#64748b; display:block; margin-bottom:0.25rem;">Lead Name</label>
          <input type="text" id="autoDialName" placeholder="John Doe" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label style="font-size:0.75rem; color:#64748b; display:block; margin-bottom:0.25rem;">Context</label>
          <input type="text" id="autoDialContext" placeholder="Debt consolidation inquiry" />
        </div>
        <button class="btn-primary-ai" onclick="window.aiAutoDialCall()">ü§ñ AI Call</button>
        <button class="btn-action" onclick="window.aiImportCRM()">üìã Import from CRM</button>
      </div>

      <!-- CRM Leads List (hidden by default) -->
      <div id="crmLeadsList" style="display:none; margin-bottom:1rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
          <span style="font-size:0.85rem; color:#94a3b8;">Select leads for campaign:</span>
          <div style="display:flex; gap:0.5rem;">
            <button class="btn-action" onclick="window.aiSelectAllLeads()">Select All</button>
            <button class="btn-primary-ai" onclick="window.aiStartCampaign()">üöÄ Start Campaign</button>
          </div>
        </div>
        <div id="crmLeadsBody" style="max-height:200px; overflow-y:auto;"></div>
      </div>

      <!-- Campaign Queue -->
      <div id="campaignQueue" style="display:none;">
        <div style="font-size:0.85rem; color:#94a3b8; margin-bottom:0.5rem;">üìã Campaign Queue</div>
        <div id="campaignQueueBody"></div>
      </div>
    </div>

    <!-- 5. Caller Memory Database -->
    <div class="glass-card-ai" style="padding:1.5rem; margin-bottom:2rem;">
      <div class="section-title"><i data-lucide="brain" style="width:18px;height:18px;"></i> Caller Memory Database</div>
      <div style="display:flex; gap:0.75rem; margin-bottom:1rem; flex-wrap:wrap;">
        <input type="text" id="callerSearch" placeholder="Search by name or phone..." style="max-width:300px;" oninput="window.aiFilterCallers()" />
        <input type="number" id="callerDebtMin" placeholder="Min Debt" style="max-width:120px;" oninput="window.aiFilterCallers()" />
        <input type="number" id="callerDebtMax" placeholder="Max Debt" style="max-width:120px;" oninput="window.aiFilterCallers()" />
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Name</th><th>Phone</th><th># Calls</th><th>Last Call</th><th>Total Debt</th><th>Sentiment</th><th>Lead Score</th>
            </tr>
          </thead>
          <tbody id="callersTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- 6. Recent Calls Log -->
    <div class="glass-card-ai" style="padding:1.5rem; margin-bottom:2rem;">
      <div class="section-title"><i data-lucide="history" style="width:18px;height:18px;"></i> Recent Calls Log</div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Caller</th><th>Duration</th><th>Disposition</th><th>Sentiment</th><th>Recording</th><th>Data Points</th>
            </tr>
          </thead>
          <tbody id="callsLogBody"></tbody>
        </table>
      </div>
    </div>

    <!-- 7. AI Configuration Panel -->
    <div class="glass-card-ai" style="padding:1.5rem; margin-bottom:2rem;">
      <div class="section-title"><i data-lucide="sliders" style="width:18px;height:18px;"></i> AI Configuration</div>

      <!-- Tab Navigation -->
      <div style="display:flex; gap:0.5rem; margin-bottom:1.5rem; border-bottom:1px solid rgba(139,92,246,0.2); padding-bottom:0.75rem;">
        <button class="cfg-tab active" onclick="window.switchConfigTab('general')" id="cfgTabGeneral">üéØ General</button>
        <button class="cfg-tab" onclick="window.switchConfigTab('voice')" id="cfgTabVoice">üéôÔ∏è Voice & TTS</button>
        <button class="cfg-tab" onclick="window.switchConfigTab('llm')" id="cfgTabLLM">üß† AI Brain</button>
        <button class="cfg-tab" onclick="window.switchConfigTab('behavior')" id="cfgTabBehavior">‚öôÔ∏è Behavior</button>
      </div>
      <style>
        .cfg-tab { background:rgba(139,92,246,0.1); border:1px solid rgba(139,92,246,0.2); color:#a78bfa; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer; font-size:0.8rem; transition:all 0.2s; }
        .cfg-tab:hover { background:rgba(139,92,246,0.2); }
        .cfg-tab.active { background:rgba(139,92,246,0.3); border-color:#8B5CF6; color:#fff; }
        .cfg-panel { display:none; }
        .cfg-panel.active { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; }
        .cfg-label { font-size:0.75rem; color:#64748b; display:block; margin-bottom:0.25rem; }
        .cfg-sublabel { font-size:0.7rem; color:#475569; display:block; margin-top:0.15rem; }
        .slider-row { display:flex; align-items:center; gap:0.75rem; }
        .slider-row input[type=range] { flex:1; accent-color:#8B5CF6; }
        .slider-val { font-family:'Orbitron',monospace; font-size:0.8rem; color:#a78bfa; min-width:2.5rem; text-align:right; }
        .voice-card { background:rgba(15,23,42,0.6); border:1px solid rgba(139,92,246,0.15); border-radius:0.75rem; padding:0.75rem; cursor:pointer; transition:all 0.2s; }
        .voice-card:hover { border-color:#8B5CF6; background:rgba(139,92,246,0.1); }
        .voice-card.selected { border-color:#8B5CF6; background:rgba(139,92,246,0.2); box-shadow:0 0 12px rgba(139,92,246,0.3); }
        .voice-preview-btn { background:rgba(139,92,246,0.2); border:1px solid rgba(139,92,246,0.3); color:#a78bfa; padding:0.25rem 0.5rem; border-radius:0.375rem; cursor:pointer; font-size:0.7rem; }
        .voice-preview-btn:hover { background:rgba(139,92,246,0.4); }
        .toggle-switch { position:relative; width:44px; height:24px; display:inline-block; }
        .toggle-switch input { opacity:0; width:0; height:0; }
        .toggle-slider { position:absolute; cursor:pointer; inset:0; background:rgba(100,116,139,0.4); border-radius:12px; transition:0.3s; }
        .toggle-slider:before { content:''; position:absolute; height:18px; width:18px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition:0.3s; }
        .toggle-switch input:checked + .toggle-slider { background:#8B5CF6; }
        .toggle-switch input:checked + .toggle-slider:before { transform:translateX(20px); }
      </style>

      <!-- General Tab -->
      <div id="cfgPanelGeneral" class="cfg-panel active">
        <div>
          <label class="cfg-label">AI Agent Name / Personality</label>
          <input type="text" id="cfgPersonality" placeholder="Professional debt consolidation specialist named Alex" />
        </div>
        <div>
          <label class="cfg-label">Max Concurrent Calls</label>
          <input type="number" id="cfgMaxCalls" min="1" max="100" />
        </div>
        <div>
          <label class="cfg-label">Working Hours Start</label>
          <input type="time" id="cfgHoursStart" />
        </div>
        <div>
          <label class="cfg-label">Working Hours End</label>
          <input type="time" id="cfgHoursEnd" />
        </div>
        <div>
          <label class="cfg-label">Transfer Number (Escalation)</label>
          <input type="tel" id="cfgTransferNumber" placeholder="+13059659624" />
        </div>
        <div>
          <label class="cfg-label">Timezone</label>
          <select id="cfgTimezone">
            <option value="America/New_York">Eastern (ET)</option>
            <option value="America/Chicago">Central (CT)</option>
            <option value="America/Denver">Mountain (MT)</option>
            <option value="America/Los_Angeles">Pacific (PT)</option>
          </select>
        </div>
        <div style="grid-column: 1 / -1;">
          <label class="cfg-label">Greeting Message</label>
          <textarea id="cfgGreeting" rows="3" placeholder="Hi, this is Alex from DebtFree Solutions. How can I help you today?"></textarea>
        </div>
        <div style="grid-column: 1 / -1;">
          <label class="cfg-label">After-Hours Message</label>
          <textarea id="cfgAfterHours" rows="2" placeholder="Thanks for calling. Our hours are 8 AM to 9 PM Eastern..."></textarea>
        </div>
      </div>

      <!-- Voice & TTS Tab -->
      <div id="cfgPanelVoice" class="cfg-panel">
        <div style="grid-column: 1 / -1;">
          <label class="cfg-label">TTS Model</label>
          <select id="cfgTTSModel" style="width:100%;">
            <option value="eleven_turbo_v2_5">‚ö° Turbo v2.5 (Fastest ‚Äî recommended for calls)</option>
            <option value="eleven_flash_v2_5">üöÄ Flash v2.5 (Ultra Fast)</option>
            <option value="eleven_multilingual_v2">üåç Multilingual v2 (Best Quality)</option>
            <option value="eleven_monolingual_v1">üá∫üá∏ English v1 (Legacy)</option>
          </select>
        </div>
        <div style="grid-column: 1 / -1;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
            <label class="cfg-label" style="margin:0;">ElevenLabs Voice</label>
            <button class="voice-preview-btn" onclick="window.refreshVoices()">üîÑ Refresh from ElevenLabs</button>
          </div>
          <div id="voicesList" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:0.5rem; max-height:300px; overflow-y:auto; padding-right:0.5rem;">
            <div style="color:#64748b; font-size:0.8rem; padding:1rem;">Loading voices...</div>
          </div>
        </div>
        <div>
          <label class="cfg-label">Stability</label>
          <span class="cfg-sublabel">Lower = more expressive, Higher = more consistent</span>
          <div class="slider-row">
            <input type="range" id="cfgStability" min="0" max="100" value="50" oninput="document.getElementById('cfgStabilityVal').textContent=(this.value/100).toFixed(2)">
            <span class="slider-val" id="cfgStabilityVal">0.50</span>
          </div>
        </div>
        <div>
          <label class="cfg-label">Similarity Boost</label>
          <span class="cfg-sublabel">Higher = closer to original voice</span>
          <div class="slider-row">
            <input type="range" id="cfgSimilarity" min="0" max="100" value="75" oninput="document.getElementById('cfgSimilarityVal').textContent=(this.value/100).toFixed(2)">
            <span class="slider-val" id="cfgSimilarityVal">0.75</span>
          </div>
        </div>
        <div>
          <label class="cfg-label">Style Exaggeration</label>
          <span class="cfg-sublabel">Higher = more dramatic delivery</span>
          <div class="slider-row">
            <input type="range" id="cfgStyle" min="0" max="100" value="50" oninput="document.getElementById('cfgStyleVal').textContent=(this.value/100).toFixed(2)">
            <span class="slider-val" id="cfgStyleVal">0.50</span>
          </div>
        </div>
        <div style="grid-column: 1 / -1;">
          <label class="cfg-label">üîä Test Voice</label>
          <div style="display:flex; gap:0.5rem; align-items:center;">
            <input type="text" id="cfgTestText" value="Hi, this is Alex from DebtFree Solutions. How can I help you today?" style="flex:1;" />
            <button class="voice-preview-btn" onclick="window.testVoice()" style="padding:0.4rem 1rem;">‚ñ∂Ô∏è Play</button>
          </div>
          <audio id="voiceTestAudio" style="display:none;"></audio>
        </div>
      </div>

      <!-- AI Brain Tab -->
      <div id="cfgPanelLLM" class="cfg-panel">
        <div>
          <label class="cfg-label">LLM Model</label>
          <select id="cfgLLMModel">
            <option value="claude-sonnet-4-5-20250514">Claude Sonnet 4.5 (Recommended)</option>
            <option value="claude-haiku-3-5-20250514">Claude Haiku 3.5 (Faster/Cheaper)</option>
            <option value="claude-opus-4-6-20250514">Claude Opus 4.6 (Most Capable)</option>
          </select>
        </div>
        <div>
          <label class="cfg-label">Temperature</label>
          <span class="cfg-sublabel">Lower = more focused, Higher = more creative</span>
          <div class="slider-row">
            <input type="range" id="cfgLLMTemp" min="0" max="100" value="70" oninput="document.getElementById('cfgLLMTempVal').textContent=(this.value/100).toFixed(2)">
            <span class="slider-val" id="cfgLLMTempVal">0.70</span>
          </div>
        </div>
        <div>
          <label class="cfg-label">Max Response Tokens</label>
          <input type="number" id="cfgLLMMaxTokens" min="50" max="2000" value="300" />
          <span class="cfg-sublabel">Shorter = faster response, less detailed</span>
        </div>
        <div>
          <label class="cfg-label">Silence Timeout (ms)</label>
          <input type="number" id="cfgSilenceTimeout" min="100" max="2000" value="300" />
          <span class="cfg-sublabel">How long to wait for caller to finish speaking</span>
        </div>
      </div>

      <!-- Behavior Tab -->
      <div id="cfgPanelBehavior" class="cfg-panel">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <label class="cfg-label" style="margin:0;">Auto-Record Calls</label>
            <span class="cfg-sublabel">Record all AI calls for QA & compliance</span>
          </div>
          <label class="toggle-switch"><input type="checkbox" id="cfgAutoRecord" checked><span class="toggle-slider"></span></label>
        </div>
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <label class="cfg-label" style="margin:0;">Caller Memory</label>
            <span class="cfg-sublabel">Remember caller names, preferences, history</span>
          </div>
          <label class="toggle-switch"><input type="checkbox" id="cfgCallerMemory" checked><span class="toggle-slider"></span></label>
        </div>
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <label class="cfg-label" style="margin:0;">65-Point Data Extraction</label>
            <span class="cfg-sublabel">Extract all data points during calls</span>
          </div>
          <label class="toggle-switch"><input type="checkbox" id="cfgDataExtraction" checked><span class="toggle-slider"></span></label>
        </div>
        <div style="grid-column: 1 / -1;">
          <label class="cfg-label">Escalation Triggers (comma-separated)</label>
          <input type="text" id="cfgEscalation" placeholder="lawsuit, attorney, suicide, complaint, manager" />
          <span class="cfg-sublabel">Keywords that trigger immediate transfer to a human</span>
        </div>
      </div>

      <div style="margin-top:1.25rem; display:flex; gap:0.75rem; align-items:center;">
        <button class="btn-primary-ai" onclick="window.aiSaveConfig()">üíæ Save Configuration</button>
        <button class="cfg-tab" onclick="window.aiResetConfig()">‚Ü©Ô∏è Reset to Defaults</button>
        <span id="cfgSaveStatus" style="color:#22C55E; font-size:0.8rem;"></span>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const API_BASE = 'https://debt-voice-stack.fly.dev';
  const DEFAULT_MONITOR_PHONE = '+13059659624';

  // --- Role Gate ---
  const user = window.DebtDB?.getCurrentUser?.();
  const denied = document.getElementById('aiAccessDenied');
  const content = document.getElementById('aiAgentContent');
  if (!user || !['manager', 'owner'].includes(user.role)) {
    if (denied) denied.style.display = 'block';
    if (content) content.style.display = 'none';
    if (typeof lucide !== 'undefined' && lucide.createIcons) { try { lucide.createIcons(); } catch(e) { console.warn('[Lucide]', e.message); } }
    return;
  }

  // --- State ---
  let activeCalls = [];
  let callTimers = {};
  let callerData = [];
  let callsLog = [];
  let campaignQueue = [];
  let campaignRunning = false;

  // --- Helpers ---
  function $(id) { return document.getElementById(id); }

  function fmt(s) { return s || '‚Äî'; }

  function fmtDuration(seconds) {
    if (!seconds && seconds !== 0) return '‚Äî';
    const m = Math.floor(seconds / 60);
    const s2 = Math.floor(seconds % 60);
    return `${m}:${String(s2).padStart(2, '0')}`;
  }

  function fmtMoney(n) {
    if (!n && n !== 0) return '$0';
    return '$' + Number(n).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  }

  function fmtDate(d) {
    if (!d) return '‚Äî';
    const dt = new Date(d);
    return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
  }

  function sentimentBadge(s) {
    const val = (s || '').toLowerCase();
    if (val === 'positive' || val === 'good') return '<span class="sentiment-badge sentiment-positive">üü¢ Positive</span>';
    if (val === 'negative' || val === 'bad' || val === 'angry') return '<span class="sentiment-badge sentiment-negative">üî¥ Negative</span>';
    return '<span class="sentiment-badge sentiment-neutral">üü° Neutral</span>';
  }

  async function apiGet(path) {
    try {
      const r = await fetch(API_BASE + path);
      if (!r.ok) return null;
      return await r.json();
    } catch(e) { console.error('API GET error:', path, e); return null; }
  }

  async function apiPost(path, body) {
    try {
      const r = await fetch(API_BASE + path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      return await r.json();
    } catch(e) { console.error('API POST error:', path, e); return null; }
  }

  async function apiPut(path, body) {
    try {
      const r = await fetch(API_BASE + path, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      return await r.json();
    } catch(e) { console.error('API PUT error:', path, e); return null; }
  }

  // --- 1. Agent Status ---
  async function fetchAgentStatus() {
    const data = await apiGet('/api/agent/status');
    const badge = $('aiStatusBadge');
    if (badge && data) {
      const online = data.status === 'online' || data.online;
      badge.innerHTML = online ? 'üü¢ Online' : 'üî¥ Offline';
      badge.style.background = online ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)';
      badge.style.color = online ? '#22C55E' : '#EF4444';
    }
  }

  // --- 2. Stats ---
  async function fetchStats() {
    const calls = await apiGet('/api/calls');
    if (!calls) return;
    const arr = Array.isArray(calls) ? calls : (calls.calls || []);
    const today = new Date().toDateString();
    const todayCalls = arr.filter(c => new Date(c.created_at || c.date || c.start_time).toDateString() === today);

    const el = (id, v) => { const e = $(id); if (e) e.textContent = v; };
    el('statCallsToday', todayCalls.length);

    const durations = todayCalls.map(c => c.duration || 0).filter(d => d > 0);
    const avg = durations.length ? durations.reduce((a, b) => a + b, 0) / durations.length : 0;
    el('statAvgTime', fmtDuration(avg));

    const qualified = todayCalls.filter(c => c.disposition === 'qualified' || c.qualified).length;
    el('statQualRate', todayCalls.length ? Math.round(qualified / todayCalls.length * 100) + '%' : '0%');

    const appts = todayCalls.filter(c => c.appointment_set || c.disposition === 'appointment').length;
    el('statAppts', appts);

    const rev = todayCalls.reduce((sum, c) => sum + (c.revenue || c.deal_value || 0), 0);
    el('statRevenue', fmtMoney(rev));

    const compliant = todayCalls.filter(c => c.compliant !== false).length;
    el('statCompliance', todayCalls.length ? Math.round(compliant / todayCalls.length * 100) + '%' : '100%');
  }

  // --- 3. Active Calls ---
  async function fetchActiveCalls() {
    const data = await apiGet('/api/calls/active');
    const arr = data ? (Array.isArray(data) ? data : (data.calls || [])) : [];
    activeCalls = arr;

    const container = $('activeCallsContainer');
    if (!container) return;

    const countEl = $('activeCallCount');
    if (countEl) countEl.textContent = arr.length;
    const capEl = $('capacityFill');
    if (capEl) capEl.style.width = Math.min(arr.length / 50 * 100, 100) + '%';

    if (arr.length === 0) {
      container.innerHTML = `<div class="pulse-idle" style="text-align:center; padding:2rem; color:#64748b;">
        <div style="font-size:2rem; margin-bottom:0.5rem;">üì°</div>
        AI Agent is idle ‚Äî waiting for calls
      </div>`;
      if (typeof lucide !== 'undefined' && lucide.createIcons) { try { lucide.createIcons(); } catch(e) { console.warn('[Lucide]', e.message); } }
      return;
    }

    container.innerHTML = arr.map(call => {
      const sid = call.sid || call.call_sid || call.id || '';
      const name = call.caller_name || call.lead_name || 'Unknown';
      const phone = call.from || call.phone || call.caller_phone || '';
      const topic = call.current_topic || call.topic || 'General inquiry';
      const dataPoints = call.data_points_captured || call.data_points || 0;
      const sentiment = call.sentiment || 'neutral';
      const startTime = call.start_time || call.created_at || Date.now();

      // Store start time for timer
      if (!callTimers[sid]) callTimers[sid] = new Date(startTime).getTime() || Date.now();

      return `<div class="glass-card-ai" style="padding:1rem; margin-bottom:0.75rem; border-left:3px solid #22C55E;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:0.5rem;">
          <div>
            <div style="font-weight:600; color:#f1f5f9;">${name}</div>
            <div style="font-size:0.8rem; color:#64748b;">${phone}</div>
          </div>
          <div style="text-align:right;">
            <div class="call-timer" data-sid="${sid}">0:00</div>
            ${sentimentBadge(sentiment)}
          </div>
        </div>
        <div style="margin:0.5rem 0; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem;">
          <span style="font-size:0.8rem; color:#94a3b8;">üìã ${topic}</span>
          <span style="font-size:0.8rem; color:#06B6D4; font-family:'Orbitron',sans-serif;">${dataPoints}/65 captured</span>
        </div>
        <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
          <button class="btn-action" onclick="window.aiListenCall('${sid}')">üéß Listen</button>
          <button class="btn-action" onclick="window.aiWhisperCall('${sid}')">üí¨ Whisper</button>
          <button class="btn-action" onclick="window.aiBargeCall('${sid}')">üìû Barge</button>
        </div>
      </div>`;
    }).join('');

    if (typeof lucide !== 'undefined' && lucide.createIcons) { try { lucide.createIcons(); } catch(e) { console.warn('[Lucide]', e.message); } }
  }

  // Timer tick for active calls
  function tickTimers() {
    const now = Date.now();
    document.querySelectorAll('.call-timer[data-sid]').forEach(el => {
      const sid = el.getAttribute('data-sid');
      const start = callTimers[sid];
      if (start) {
        const elapsed = Math.floor((now - start) / 1000);
        el.textContent = fmtDuration(elapsed);
      }
    });
  }

  // --- Active call actions ---
  window.aiListenCall = function(sid) {
    const phone = prompt('Enter your phone number to listen:', DEFAULT_MONITOR_PHONE);
    if (!phone) return;
    apiPost(`/api/calls/${sid}/listen`, { manager_phone: phone }).then(r => {
      alert(r && !r.error ? 'Listening connected! Your phone will ring.' : 'Failed to connect.');
    });
  };

  window.aiWhisperCall = function(sid) {
    const phone = prompt('Enter your phone number:', DEFAULT_MONITOR_PHONE);
    if (!phone) return;
    const message = prompt('Enter whisper message for the AI agent:');
    if (!message) return;
    apiPost(`/api/calls/${sid}/whisper`, { manager_phone: phone, message }).then(r => {
      alert(r && !r.error ? 'Whisper sent!' : 'Failed to send whisper.');
    });
  };

  window.aiBargeCall = function(sid) {
    const phone = prompt('Enter your phone number to barge in:', DEFAULT_MONITOR_PHONE);
    if (!phone) return;
    if (!confirm('This will connect you directly to the call. Continue?')) return;
    apiPost(`/api/calls/${sid}/barge`, { manager_phone: phone }).then(r => {
      alert(r && !r.error ? 'Barge connected! Your phone will ring.' : 'Failed to barge.');
    });
  };

  // --- 4. Auto-Dial ---
  window.aiAutoDialCall = async function() {
    const phone = ($('autoDialPhone') || {}).value;
    const name = ($('autoDialName') || {}).value;
    const context = ($('autoDialContext') || {}).value;
    if (!phone) { alert('Enter a phone number'); return; }
    const r = await apiPost('/api/calls/outbound-ai', { to: phone, purpose: context || 'AI outbound call' });
    if (r) {
      alert('AI is calling ' + (name || phone) + '!');
      if ($('autoDialPhone')) $('autoDialPhone').value = '';
      if ($('autoDialName')) $('autoDialName').value = '';
      if ($('autoDialContext')) $('autoDialContext').value = '';
      fetchActiveCalls();
    } else {
      alert('Failed to initiate call.');
    }
  };

  window.aiImportCRM = function() {
    const list = $('crmLeadsList');
    if (!list) return;
    const leads = window.DebtDB?.getLeads?.() || [];
    if (leads.length === 0) {
      alert('No leads found in CRM.');
      return;
    }
    list.style.display = 'block';
    const body = $('crmLeadsBody');
    if (body) {
      body.innerHTML = leads.map((l, i) => `
        <div style="display:flex; align-items:center; gap:0.75rem; padding:0.4rem 0; border-bottom:1px solid rgba(148,163,184,0.05);">
          <input type="checkbox" data-lead-idx="${i}" class="crm-lead-check" />
          <span style="color:#f1f5f9; font-size:0.85rem;">${l.name || l.lead_name || 'Unknown'}</span>
          <span style="color:#64748b; font-size:0.8rem;">${l.phone || ''}</span>
          <span style="color:#06B6D4; font-size:0.8rem; margin-left:auto;">${fmtMoney(l.total_debt || l.debt || 0)}</span>
        </div>
      `).join('');
    }
  };

  window.aiSelectAllLeads = function() {
    document.querySelectorAll('.crm-lead-check').forEach(cb => cb.checked = true);
  };

  window.aiStartCampaign = function() {
    const leads = window.DebtDB?.getLeads?.() || [];
    const selected = [];
    document.querySelectorAll('.crm-lead-check:checked').forEach(cb => {
      const idx = parseInt(cb.getAttribute('data-lead-idx'));
      if (leads[idx]) selected.push(leads[idx]);
    });
    if (selected.length === 0) { alert('Select at least one lead.'); return; }
    campaignQueue = selected.map(l => ({
      phone: l.phone,
      name: l.name || l.lead_name || 'Unknown',
      context: `Debt: ${fmtMoney(l.total_debt || l.debt || 0)}`,
      status: 'queued'
    }));
    renderCampaignQueue();
    if (!campaignRunning) runCampaign();
  };

  function renderCampaignQueue() {
    const qEl = $('campaignQueue');
    const body = $('campaignQueueBody');
    if (!qEl || !body) return;
    if (campaignQueue.length === 0) { qEl.style.display = 'none'; return; }
    qEl.style.display = 'block';
    body.innerHTML = campaignQueue.map((q, i) => `
      <div class="queue-item">
        <span style="color:#f1f5f9; font-size:0.85rem;">${i + 1}. ${q.name} ‚Äî ${q.phone}</span>
        <span style="font-size:0.75rem; color:${q.status === 'calling' ? '#22C55E' : q.status === 'done' ? '#64748b' : '#F59E0B'};">
          ${q.status === 'calling' ? 'üìû Calling...' : q.status === 'done' ? '‚úÖ Done' : '‚è≥ Queued'}
        </span>
      </div>
    `).join('');
  }

  async function runCampaign() {
    campaignRunning = true;
    for (let i = 0; i < campaignQueue.length; i++) {
      const q = campaignQueue[i];
      if (q.status === 'done') continue;
      q.status = 'calling';
      renderCampaignQueue();
      await apiPost('/api/calls/outbound-ai', { to: q.phone, purpose: q.context || 'Campaign call' });
      // Wait for call to finish (poll active calls, simple 30s wait)
      await new Promise(r => setTimeout(r, 30000));
      q.status = 'done';
      renderCampaignQueue();
    }
    campaignRunning = false;
  }

  // --- 5. Caller Memory ---
  async function fetchCallers() {
    const data = await apiGet('/api/callers');
    callerData = data ? (Array.isArray(data) ? data : (data.callers || [])) : [];
    renderCallers(callerData);
  }

  function renderCallers(list) {
    const body = $('callersTableBody');
    if (!body) return;
    if (list.length === 0) {
      body.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#64748b; padding:2rem;">No callers found</td></tr>';
      return;
    }
    body.innerHTML = list.map((c, i) => {
      const phone = c.phone || c.phone_number || '';
      const name = c.name || c.caller_name || phone;
      const numCalls = c.call_count || c.num_calls || 0;
      const lastCall = fmtDate(c.last_call || c.last_call_date);
      const debt = fmtMoney(c.total_debt || c.debt || 0);
      const sentiment = c.sentiment || c.overall_sentiment || 'neutral';
      const score = c.lead_score || c.score || 0;
      return `<tr onclick="window.aiExpandCaller('${phone}', this)" data-caller-idx="${i}">
        <td style="color:#f1f5f9; font-weight:500;">${fmt(name)}</td>
        <td>${phone}</td>
        <td style="text-align:center;">${numCalls}</td>
        <td>${lastCall}</td>
        <td style="color:#06B6D4; font-family:'Orbitron',sans-serif;">${debt}</td>
        <td>${sentimentBadge(sentiment)}</td>
        <td><span style="font-family:'Orbitron',sans-serif; color:${score >= 70 ? '#22C55E' : score >= 40 ? '#F59E0B' : '#EF4444'};">${score}</span></td>
      </tr>
      <tr class="expandable-row" id="caller-detail-${i}">
        <td colspan="7" style="padding:1rem; background:rgba(15,23,42,0.6);">
          <div style="color:#64748b;">Loading...</div>
        </td>
      </tr>`;
    }).join('');
  }

  window.aiExpandCaller = async function(phone, rowEl) {
    const idx = rowEl?.getAttribute('data-caller-idx');
    const detailRow = $('caller-detail-' + idx);
    if (!detailRow) return;
    if (detailRow.classList.contains('open')) {
      detailRow.classList.remove('open');
      return;
    }
    detailRow.classList.add('open');
    const data = await apiGet(`/api/callers/${encodeURIComponent(phone)}`);
    if (!data) {
      detailRow.querySelector('td').innerHTML = '<div style="color:#EF4444;">Failed to load caller details.</div>';
      return;
    }
    const history = data.call_history || data.calls || [];
    const dataPoints = data.data_points || data.collected_data || {};
    detailRow.querySelector('td').innerHTML = `
      <div style="margin-bottom:0.75rem;">
        <strong style="color:#f1f5f9;">Conversation History (${history.length} calls)</strong>
      </div>
      ${history.map(h => `
        <div style="margin-bottom:0.5rem; padding:0.5rem; background:rgba(30,41,59,0.5); border-radius:0.5rem;">
          <div style="display:flex; justify-content:space-between;">
            <span style="color:#94a3b8; font-size:0.8rem;">${fmtDate(h.date || h.created_at)}</span>
            <span style="font-size:0.8rem;">${sentimentBadge(h.sentiment)}</span>
          </div>
          <div style="color:#f1f5f9; font-size:0.85rem; margin-top:0.25rem;">${h.summary || h.notes || 'No summary'}</div>
        </div>
      `).join('')}
      <div style="margin-top:1rem;">
        <strong style="color:#f1f5f9;">Data Points Collected</strong>
        <div style="margin-top:0.5rem; display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:0.5rem;">
          ${Object.entries(dataPoints).map(([k, v]) => `
            <div style="font-size:0.8rem;"><span style="color:#64748b;">${k}:</span> <span style="color:#06B6D4;">${v}</span></div>
          `).join('')}
        </div>
      </div>`;
  };

  window.aiFilterCallers = function() {
    const q = ($('callerSearch') || {}).value?.toLowerCase() || '';
    const minDebt = parseFloat(($('callerDebtMin') || {}).value) || 0;
    const maxDebt = parseFloat(($('callerDebtMax') || {}).value) || Infinity;
    const filtered = callerData.filter(c => {
      const name = (c.name || c.caller_name || '').toLowerCase();
      const phone = (c.phone || c.phone_number || '').toLowerCase();
      const debt = c.total_debt || c.debt || 0;
      return (name.includes(q) || phone.includes(q)) && debt >= minDebt && debt <= maxDebt;
    });
    renderCallers(filtered);
  };

  // --- 6. Calls Log ---
  async function fetchCallsLog() {
    const data = await apiGet('/api/calls');
    callsLog = data ? (Array.isArray(data) ? data : (data.calls || [])) : [];
    renderCallsLog(callsLog);
  }

  function renderCallsLog(list) {
    const body = $('callsLogBody');
    if (!body) return;
    if (list.length === 0) {
      body.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#64748b; padding:2rem;">No calls recorded yet</td></tr>';
      return;
    }
    body.innerHTML = list.slice(0, 50).map((c, i) => {
      const date = fmtDate(c.created_at || c.date || c.start_time);
      const caller = c.caller_name || c.from || c.phone || 'Unknown';
      const dur = fmtDuration(c.duration);
      const disp = c.disposition || c.status || '‚Äî';
      const sentiment = c.sentiment || 'neutral';
      const recording = c.recording_url || c.recording || '';
      const dataPoints = c.data_points || c.collected_data || {};
      const transcript = c.transcript || '';
      return `<tr onclick="window.aiExpandCallLog(${i}, this)" data-call-idx="${i}">
        <td>${date}</td>
        <td style="color:#f1f5f9; font-weight:500;">${caller}</td>
        <td class="font-orbitron" style="font-family:'Orbitron',sans-serif; color:#06B6D4;">${dur}</td>
        <td><span style="padding:0.2rem 0.5rem; border-radius:9999px; font-size:0.75rem; background:rgba(59,130,246,0.15); color:#3B82F6;">${disp}</span></td>
        <td>${sentimentBadge(sentiment)}</td>
        <td>${recording ? '<button class="btn-action" onclick="event.stopPropagation(); new Audio(\'' + recording + '\').play()">‚ñ∂Ô∏è Play</button>' : '‚Äî'}</td>
        <td style="color:#64748b; font-size:0.8rem;">${Object.keys(dataPoints).length || 0} points</td>
      </tr>
      <tr class="expandable-row" id="call-detail-${i}">
        <td colspan="7" style="padding:1rem; background:rgba(15,23,42,0.6);"></td>
      </tr>`;
    }).join('');
  }

  window.aiExpandCallLog = function(idx, rowEl) {
    const detailRow = $('call-detail-' + idx);
    if (!detailRow) return;
    if (detailRow.classList.contains('open')) {
      detailRow.classList.remove('open');
      return;
    }
    detailRow.classList.add('open');
    const c = callsLog[idx];
    if (!c) return;
    const dataPoints = c.data_points || c.collected_data || {};
    const transcript = c.transcript || 'No transcript available.';

    // Group data points by category
    const categories = {};
    Object.entries(dataPoints).forEach(([k, v]) => {
      const cat = k.split('_')[0] || 'General';
      if (!categories[cat]) categories[cat] = [];
      categories[cat].push({ key: k, value: v });
    });

    detailRow.querySelector('td').innerHTML = `
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
        <div>
          <strong style="color:#f1f5f9;">Transcript</strong>
          <div style="margin-top:0.5rem; padding:0.75rem; background:rgba(30,41,59,0.5); border-radius:0.5rem; max-height:300px; overflow-y:auto; font-size:0.8rem; color:#94a3b8; white-space:pre-wrap;">${transcript}</div>
        </div>
        <div>
          <strong style="color:#f1f5f9;">65 Data Points</strong>
          <div style="margin-top:0.5rem; max-height:300px; overflow-y:auto;">
            ${Object.entries(categories).map(([cat, items]) => `
              <div style="margin-bottom:0.75rem;">
                <div style="font-size:0.75rem; text-transform:uppercase; color:#3B82F6; font-weight:600; margin-bottom:0.25rem;">${cat}</div>
                ${items.map(({key, value}) => `
                  <div style="font-size:0.8rem; padding:0.15rem 0;"><span style="color:#64748b;">${key.replace(/_/g, ' ')}:</span> <span style="color:#06B6D4;">${value}</span></div>
                `).join('')}
              </div>
            `).join('')}
          </div>
        </div>
      </div>`;
  };

  // --- 7. Config ---
  let voicesCache = [];

  window.switchConfigTab = function(tab) {
    const panelMap = {general:'General', voice:'Voice', llm:'LLM', behavior:'Behavior'};
    const tabMap = {general:'General', voice:'Voice', llm:'LLM', behavior:'Behavior'};
    Object.keys(panelMap).forEach(t => {
      const panel = $('cfgPanel' + panelMap[t]);
      const btn = $('cfgTab' + tabMap[t]);
      if (panel) panel.classList.toggle('active', t === tab);
      if (btn) btn.classList.toggle('active', t === tab);
    });
    if (tab === 'voice' && voicesCache.length === 0) window.refreshVoices();
  };

  window.refreshVoices = async function() {
    const container = $('voicesList');
    if (!container) return;
    container.innerHTML = '<div style="color:#64748b;font-size:0.8rem;padding:1rem;">‚è≥ Loading voices from ElevenLabs...</div>';
    const data = await apiGet('/api/voices');
    if (!data || !data.voices) {
      container.innerHTML = '<div style="color:#EF4444;font-size:0.8rem;padding:1rem;">‚ùå Failed to load voices</div>';
      return;
    }
    voicesCache = data.voices;
    const currentVoiceId = ($('cfgVoiceId') || {}).value || '';
    container.innerHTML = data.voices.map(v => {
      const labels = Object.entries(v.labels || {}).map(([k,val]) => val).filter(Boolean).join(', ');
      const selected = v.voice_id === currentVoiceId ? ' selected' : '';
      return `<div class="voice-card${selected}" data-voice-id="${v.voice_id}" onclick="window.selectVoice('${v.voice_id}','${v.name.replace(/'/g,"\\'")}')">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:0.85rem;font-weight:600;color:#e2e8f0;">${v.name}</span>
          <span style="font-size:0.65rem;color:#64748b;background:rgba(100,116,139,0.2);padding:0.15rem 0.4rem;border-radius:0.25rem;">${v.category}</span>
        </div>
        ${labels ? `<div style="font-size:0.7rem;color:#94a3b8;margin-top:0.25rem;">${labels}</div>` : ''}
        ${v.preview_url ? `<button class="voice-preview-btn" style="margin-top:0.4rem;" onclick="event.stopPropagation();window.playPreview('${v.preview_url}')">‚ñ∂Ô∏è Preview</button>` : ''}
      </div>`;
    }).join('');
  };

  window.selectVoice = function(voiceId, voiceName) {
    document.querySelectorAll('.voice-card').forEach(c => c.classList.remove('selected'));
    const card = document.querySelector(`.voice-card[data-voice-id="${voiceId}"]`);
    if (card) card.classList.add('selected');
    const hiddenInput = $('cfgVoiceId');
    if (hiddenInput) hiddenInput.value = voiceId;
    const nameInput = $('cfgVoiceName');
    if (nameInput) nameInput.value = voiceName;
  };

  window.playPreview = function(url) {
    const audio = $('voiceTestAudio') || new Audio();
    audio.src = url;
    audio.play().catch(e => console.warn('Preview play failed:', e));
  };

  window.testVoice = async function() {
    const text = ($('cfgTestText') || {}).value || 'Hello, this is a test.';
    const voiceId = ($('cfgVoiceId') || {}).value || '';
    if (!voiceId) { alert('Select a voice first'); return; }
    try {
      const resp = await fetch(API_BASE + `/voice/tts?text=${encodeURIComponent(text)}`, { headers: { 'Accept': 'audio/mpeg' }});
      if (resp.ok) {
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const audio = $('voiceTestAudio') || new Audio();
        audio.src = url;
        audio.play();
      }
    } catch(e) { console.warn('Test voice error:', e); }
  };

  async function fetchConfig() {
    const data = await apiGet('/api/agent/config');
    if (!data) return;
    // General
    if ($('cfgPersonality')) $('cfgPersonality').value = data.personality || '';
    if ($('cfgMaxCalls')) $('cfgMaxCalls').value = data.max_concurrent_calls || 50;
    if ($('cfgHoursStart')) $('cfgHoursStart').value = (data.working_hours||{}).start || '08:00';
    if ($('cfgHoursEnd')) $('cfgHoursEnd').value = (data.working_hours||{}).end || '21:00';
    if ($('cfgTimezone')) $('cfgTimezone').value = (data.working_hours||{}).timezone || 'America/New_York';
    if ($('cfgGreeting')) $('cfgGreeting').value = data.greeting_message || '';
    if ($('cfgAfterHours')) $('cfgAfterHours').value = data.after_hours_message || '';
    if ($('cfgTransferNumber')) $('cfgTransferNumber').value = data.transfer_number || '';
    // Voice
    if ($('cfgTTSModel')) $('cfgTTSModel').value = data.tts_model || 'eleven_turbo_v2_5';
    if ($('cfgStability')) { $('cfgStability').value = (data.tts_stability || 0.5) * 100; $('cfgStabilityVal').textContent = (data.tts_stability || 0.5).toFixed(2); }
    if ($('cfgSimilarity')) { $('cfgSimilarity').value = (data.tts_similarity || 0.75) * 100; $('cfgSimilarityVal').textContent = (data.tts_similarity || 0.75).toFixed(2); }
    if ($('cfgStyle')) { $('cfgStyle').value = (data.tts_style || 0.5) * 100; $('cfgStyleVal').textContent = (data.tts_style || 0.5).toFixed(2); }
    // Store voice ID in hidden input
    if (!$('cfgVoiceId')) {
      const h = document.createElement('input'); h.type='hidden'; h.id='cfgVoiceId'; h.value = data.voice_id || ''; document.body.appendChild(h);
    } else { $('cfgVoiceId').value = data.voice_id || ''; }
    if (!$('cfgVoiceName')) {
      const h = document.createElement('input'); h.type='hidden'; h.id='cfgVoiceName'; h.value = data.voice_name || ''; document.body.appendChild(h);
    } else { $('cfgVoiceName').value = data.voice_name || ''; }
    // LLM
    if ($('cfgLLMModel')) $('cfgLLMModel').value = data.llm_model || 'claude-sonnet-4-5-20250514';
    if ($('cfgLLMTemp')) { $('cfgLLMTemp').value = (data.llm_temperature || 0.7) * 100; $('cfgLLMTempVal').textContent = (data.llm_temperature || 0.7).toFixed(2); }
    if ($('cfgLLMMaxTokens')) $('cfgLLMMaxTokens').value = data.llm_max_tokens || 300;
    if ($('cfgSilenceTimeout')) $('cfgSilenceTimeout').value = data.silence_timeout_ms || 300;
    // Behavior
    if ($('cfgAutoRecord')) $('cfgAutoRecord').checked = data.auto_record !== false;
    if ($('cfgCallerMemory')) $('cfgCallerMemory').checked = data.enable_caller_memory !== false;
    if ($('cfgDataExtraction')) $('cfgDataExtraction').checked = data.data_extraction_enabled !== false;
    if ($('cfgEscalation')) $('cfgEscalation').value = (data.escalation_triggers || []).join(', ');
  }

  window.aiSaveConfig = async function() {
    const config = {
      personality: ($('cfgPersonality') || {}).value || '',
      max_concurrent_calls: parseInt(($('cfgMaxCalls') || {}).value) || 50,
      working_hours: {
        start: ($('cfgHoursStart') || {}).value || '08:00',
        end: ($('cfgHoursEnd') || {}).value || '21:00',
        timezone: ($('cfgTimezone') || {}).value || 'America/New_York'
      },
      greeting_message: ($('cfgGreeting') || {}).value || '',
      after_hours_message: ($('cfgAfterHours') || {}).value || '',
      transfer_number: ($('cfgTransferNumber') || {}).value || '',
      voice_id: ($('cfgVoiceId') || {}).value || '',
      voice_name: ($('cfgVoiceName') || {}).value || '',
      tts_model: ($('cfgTTSModel') || {}).value || 'eleven_turbo_v2_5',
      tts_stability: parseFloat(($('cfgStability') || {}).value || 50) / 100,
      tts_similarity: parseFloat(($('cfgSimilarity') || {}).value || 75) / 100,
      tts_style: parseFloat(($('cfgStyle') || {}).value || 50) / 100,
      llm_model: ($('cfgLLMModel') || {}).value || 'claude-sonnet-4-5-20250514',
      llm_temperature: parseFloat(($('cfgLLMTemp') || {}).value || 70) / 100,
      llm_max_tokens: parseInt(($('cfgLLMMaxTokens') || {}).value) || 300,
      silence_timeout_ms: parseInt(($('cfgSilenceTimeout') || {}).value) || 300,
      auto_record: ($('cfgAutoRecord') || {}).checked !== false,
      enable_caller_memory: ($('cfgCallerMemory') || {}).checked !== false,
      data_extraction_enabled: ($('cfgDataExtraction') || {}).checked !== false,
    };
    const r = await apiPut('/api/agent/config', config);
    const status = $('cfgSaveStatus');
    if (status) {
      status.textContent = r ? '‚úÖ Configuration saved & applied!' : '‚ùå Failed to save';
      setTimeout(() => { if (status) status.textContent = ''; }, 3000);
    }
  };

  window.aiResetConfig = async function() {
    if (!confirm('Reset all AI agent settings to defaults?')) return;
    const defaults = {
      personality: 'Professional, empathetic debt consolidation specialist named Alex',
      max_concurrent_calls: 50,
      working_hours: { start: '08:00', end: '21:00', timezone: 'America/New_York' },
      greeting_message: 'Hi, this is Alex from DebtFree Solutions. How can I help you today?',
      after_hours_message: 'Thanks for calling DebtFree Solutions. Our hours are 8 AM to 9 PM Eastern. Please call back during business hours or leave a message.',
      transfer_number: '+13059659624',
      voice_id: 'sDgntYpZw3syMmKQFfje', voice_name: 'DeadCenter Schmoose Patrick',
      tts_model: 'eleven_turbo_v2_5', tts_stability: 0.5, tts_similarity: 0.75, tts_style: 0.5,
      llm_model: 'claude-sonnet-4-5-20250514', llm_temperature: 0.7, llm_max_tokens: 300,
      silence_timeout_ms: 300, auto_record: true, enable_caller_memory: true, data_extraction_enabled: true,
    };
    await apiPut('/api/agent/config', defaults);
    await fetchConfig();
    const status = $('cfgSaveStatus');
    if (status) { status.textContent = '‚Ü©Ô∏è Reset to defaults'; setTimeout(() => { if (status) status.textContent = ''; }, 3000); }
  };

  // --- Init ---
  async function init() {
    if (typeof lucide !== 'undefined' && lucide.createIcons) { try { lucide.createIcons(); } catch(e) { console.warn('[Lucide]', e.message); } }
    fetchAgentStatus();
    fetchStats();
    fetchActiveCalls();
    fetchCallers();
    fetchCallsLog();
    fetchConfig();
  }

  // Cleanup previous intervals
  if (window._pageIntervals) window._pageIntervals.forEach(clearInterval);
  window._pageIntervals = [];

  // Poll active calls every 5s
  window._pageIntervals.push(setInterval(fetchActiveCalls, 5000));
  // Timer tick every 1s
  window._pageIntervals.push(setInterval(tickTimers, 1000));
  // Refresh stats every 30s
  window._pageIntervals.push(setInterval(fetchStats, 30000));

  init();
})();
</script>
