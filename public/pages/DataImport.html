<!-- Data Import - Enterprise Import Wizard -->
<div class="space-y-6">
  <!-- Page Header -->
  <div class="flex items-center justify-between mb-8 fade-in-up stagger-1">
    <div>
      <h1 class="text-3xl font-bold text-white mb-2 font-orbitron">Data Import Center</h1>
      <p class="text-gray-400">Import your entire CRM and database with zero data loss</p>
    </div>
    <div class="flex gap-3">
      <button onclick="viewImportHistory()" class="btn text-white px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">
        <i data-lucide="history" class="w-4 h-4 inline mr-2"></i>
        Import History
      </button>
      <button onclick="resetWizard()" class="btn text-white px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700">
        <i data-lucide="x-circle" class="w-4 h-4 inline mr-2"></i>
        Start Over
      </button>
    </div>
  </div>

  <!-- Wizard Progress -->
  <div class="glass-card rounded-2xl p-6 fade-in-up stagger-2">
    <div class="flex items-center justify-between mb-6">
      <div class="wizard-step active" data-step="1">
        <div class="wizard-step-circle">1</div>
        <div class="wizard-step-label">Upload</div>
      </div>
      <div class="wizard-connector"></div>
      <div class="wizard-step" data-step="2">
        <div class="wizard-step-circle">2</div>
        <div class="wizard-step-label">Field Mapping</div>
      </div>
      <div class="wizard-connector"></div>
      <div class="wizard-step" data-step="3">
        <div class="wizard-step-circle">3</div>
        <div class="wizard-step-label">Validation</div>
      </div>
      <div class="wizard-connector"></div>
      <div class="wizard-step" data-step="4">
        <div class="wizard-step-circle">4</div>
        <div class="wizard-step-label">Duplicates</div>
      </div>
      <div class="wizard-connector"></div>
      <div class="wizard-step" data-step="5">
        <div class="wizard-step-circle">5</div>
        <div class="wizard-step-label">Import</div>
      </div>
      <div class="wizard-connector"></div>
      <div class="wizard-step" data-step="6">
        <div class="wizard-step-circle">6</div>
        <div class="wizard-step-label">Report</div>
      </div>
    </div>
  </div>

  <!-- Wizard Content Container -->
  <div id="wizardContent" class="fade-in-up stagger-3">
    <!-- Steps will be rendered here -->
  </div>
</div>

<style>
/* Wizard Progress Styles */
.wizard-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  position: relative;
  flex: 0 0 auto;
}

.wizard-step-circle {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(75, 85, 99, 0.3);
  border: 2px solid rgba(75, 85, 99, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 18px;
  color: #9CA3AF;
  transition: all 0.3s;
}

.wizard-step.active .wizard-step-circle {
  background: linear-gradient(135deg, #3B82F6, #06B6D4);
  border-color: #3B82F6;
  color: #fff;
  box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
}

.wizard-step.completed .wizard-step-circle {
  background: rgba(34, 197, 94, 0.2);
  border-color: #22C55E;
  color: #22C55E;
}

.wizard-step.completed .wizard-step-circle::after {
  content: '‚úì';
  position: absolute;
  font-size: 24px;
}

.wizard-step-label {
  font-size: 13px;
  color: #9CA3AF;
  font-weight: 500;
  white-space: nowrap;
}

.wizard-step.active .wizard-step-label {
  color: #3B82F6;
}

.wizard-step.completed .wizard-step-label {
  color: #22C55E;
}

.wizard-connector {
  flex: 1;
  height: 2px;
  background: rgba(75, 85, 99, 0.3);
  min-width: 40px;
}

/* Drag & Drop Zone */
.drop-zone {
  border: 3px dashed rgba(59, 130, 246, 0.3);
  border-radius: 16px;
  padding: 60px 40px;
  text-align: center;
  background: rgba(59, 130, 246, 0.05);
  transition: all 0.3s;
  cursor: pointer;
}

.drop-zone:hover {
  border-color: rgba(59, 130, 246, 0.6);
  background: rgba(59, 130, 246, 0.1);
}

.drop-zone.drag-over {
  border-color: #3B82F6;
  background: rgba(59, 130, 246, 0.15);
  box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
}

.drop-zone-icon {
  font-size: 64px;
  margin-bottom: 20px;
  color: #3B82F6;
}

/* Field Mapping Interface */
.mapping-container {
  display: grid;
  grid-template-columns: 1fr 100px 1fr;
  gap: 20px;
  align-items: start;
}

.mapping-column {
  background: rgba(15, 23, 42, 0.8);
  border: 1px solid rgba(59, 130, 246, 0.1);
  border-radius: 12px;
  padding: 20px;
  min-height: 400px;
}

.mapping-column h3 {
  font-size: 16px;
  font-weight: 600;
  color: #fff;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(59, 130, 246, 0.2);
}

.field-item {
  padding: 12px 16px;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  margin-bottom: 8px;
  cursor: move;
  transition: all 0.2s;
}

.field-item:hover {
  background: rgba(59, 130, 246, 0.2);
  transform: translateX(4px);
}

.field-item.required::after {
  content: '*';
  color: #EF4444;
  margin-left: 4px;
}

.field-item.mapped {
  background: rgba(34, 197, 94, 0.1);
  border-color: rgba(34, 197, 94, 0.3);
}

.mapping-connector-area {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Validation Results */
.validation-summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.validation-stat {
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}

.validation-stat.success {
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid rgba(34, 197, 94, 0.3);
}

.validation-stat.warning {
  background: rgba(245, 158, 11, 0.1);
  border: 1px solid rgba(245, 158, 11, 0.3);
}

.validation-stat.error {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.validation-stat-number {
  font-size: 32px;
  font-weight: bold;
  font-family: 'Orbitron', monospace;
  margin-bottom: 8px;
}

.validation-stat.success .validation-stat-number {
  color: #22C55E;
}

.validation-stat.warning .validation-stat-number {
  color: #F59E0B;
}

.validation-stat.error .validation-stat-number {
  color: #EF4444;
}

.validation-stat-label {
  font-size: 14px;
  color: #94A3B8;
}

/* Preview Table */
.preview-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
}

.preview-table th {
  background: rgba(59, 130, 246, 0.1);
  padding: 12px;
  text-align: left;
  font-weight: 600;
  color: #3B82F6;
  border-bottom: 2px solid rgba(59, 130, 246, 0.3);
}

.preview-table td {
  padding: 12px;
  border-bottom: 1px solid rgba(59, 130, 246, 0.1);
  color: #E2E8F0;
}

.preview-table tr:hover {
  background: rgba(59, 130, 246, 0.05);
}

.preview-table tr.has-error {
  background: rgba(239, 68, 68, 0.1);
}

.preview-table tr.has-warning {
  background: rgba(245, 158, 11, 0.1);
}

/* Duplicate Resolution */
.duplicate-item {
  background: rgba(245, 158, 11, 0.1);
  border: 1px solid rgba(245, 158, 11, 0.3);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
}

.duplicate-comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 16px;
}

.duplicate-record {
  background: rgba(15, 23, 42, 0.8);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 8px;
  padding: 16px;
}

.duplicate-record h4 {
  font-size: 14px;
  font-weight: 600;
  color: #3B82F6;
  margin-bottom: 12px;
}

.duplicate-record-field {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(59, 130, 246, 0.1);
}

.duplicate-record-field:last-child {
  border-bottom: none;
}

.duplicate-actions {
  display: flex;
  gap: 8px;
}

.duplicate-actions button {
  flex: 1;
}

/* Progress Bar */
.import-progress {
  background: rgba(15, 23, 42, 0.8);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
}

.progress-bar-container {
  width: 100%;
  height: 24px;
  background: rgba(75, 85, 99, 0.3);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 12px;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #3B82F6, #06B6D4);
  border-radius: 12px;
  transition: width 0.3s;
  box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
}

.progress-stats {
  display: flex;
  justify-content: space-between;
  color: #94A3B8;
  font-size: 14px;
}

/* Import Log */
.import-log {
  background: rgba(15, 23, 42, 0.8);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 12px;
  padding: 16px;
  max-height: 300px;
  overflow-y: auto;
  font-family: 'Courier New', monospace;
  font-size: 12px;
}

.import-log-entry {
  padding: 4px 0;
  color: #94A3B8;
}

.import-log-entry.success {
  color: #22C55E;
}

.import-log-entry.error {
  color: #EF4444;
}

/* File Upload Button */
.file-upload-btn {
  position: relative;
  overflow: hidden;
  display: inline-block;
}

.file-upload-btn input[type="file"] {
  position: absolute;
  left: -9999px;
}

/* Supported Formats */
.format-badges {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 20px;
}

.format-badge {
  padding: 6px 12px;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 20px;
  font-size: 12px;
  color: #3B82F6;
  font-weight: 500;
}
</style>

<script>
// Initialize Data Import Engine
let importEngine;
let currentStep = 1;
let uploadedFile = null;
let parsedData = null;
let fieldMapping = {};
let validationResults = [];
let duplicateRecords = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  importEngine = new DataImportEngine();
  renderStep1();
});

// Render Step 1: Upload
function renderStep1() {
  currentStep = 1;
  updateWizardProgress();
  
  const content = `
    <div class="glass-card rounded-2xl p-8">
      <h2 class="text-2xl font-bold text-white mb-6 font-orbitron">Step 1: Upload Your Data</h2>
      
      <!-- Drag & Drop Zone -->
      <div id="dropZone" class="drop-zone">
        <div class="drop-zone-icon">üìÅ</div>
        <h3 class="text-xl font-bold text-white mb-3">Drag & Drop Your File Here</h3>
        <p class="text-gray-400 mb-4">or click to browse</p>
        
        <div class="file-upload-btn">
          <label for="fileInput" class="btn btn-primary cursor-pointer">
            <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>
            Choose File
          </label>
          <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.json,.xml,.vcf,.tsv,.txt" onchange="handleFileSelect(event)">
        </div>
        
        <div class="format-badges">
          <span class="format-badge">CSV</span>
          <span class="format-badge">XLSX/XLS</span>
          <span class="format-badge">JSON</span>
          <span class="format-badge">XML</span>
          <span class="format-badge">VCF</span>
          <span class="format-badge">TSV</span>
          <span class="format-badge">Google Sheets URL</span>
        </div>
        
        <p class="text-sm text-gray-500 mt-4">Maximum file size: 500MB</p>
      </div>
      
      <!-- File Preview (hidden initially) -->
      <div id="filePreview" class="mt-6" style="display: none;">
        <div class="flex items-center justify-between p-4 bg-green-500/10 border border-green-500/30 rounded-lg">
          <div class="flex items-center gap-3">
            <i data-lucide="file-check" class="w-6 h-6 text-green-500"></i>
            <div>
              <div class="font-semibold text-white" id="fileName"></div>
              <div class="text-sm text-gray-400" id="fileStats"></div>
            </div>
          </div>
          <button onclick="clearFile()" class="btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
            <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
            Remove
          </button>
        </div>
        
        <div class="mt-4">
          <h4 class="text-sm font-semibold text-white mb-2">Data Preview (First 5 Rows)</h4>
          <div id="dataPreviewTable" class="overflow-x-auto"></div>
        </div>
        
        <div class="flex justify-end mt-6">
          <button onclick="proceedToMapping()" class="btn btn-primary">
            Next: Field Mapping
            <i data-lucide="arrow-right" class="w-4 h-4 inline ml-2"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('wizardContent').innerHTML = content;
  lucide.createIcons();
  
  // Setup drag & drop
  const dropZone = document.getElementById('dropZone');
  
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
  });
  
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  
  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
  });
  
  ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
  });
  
  dropZone.addEventListener('drop', handleDrop, false);
  dropZone.addEventListener('click', () => document.getElementById('fileInput').click());
}

function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  
  if (files.length > 0) {
    handleFile(files[0]);
  }
}

function handleFileSelect(e) {
  const files = e.target.files;
  if (files.length > 0) {
    handleFile(files[0]);
  }
}

async function handleFile(file) {
  uploadedFile = file;
  
  // Show loading
  showLoading('Parsing file...');
  
  try {
    const format = importEngine.autoDetect(file);
    
    let result;
    switch(format) {
      case 'csv':
        result = await importEngine.parseCSV(file);
        break;
      case 'xlsx':
      case 'xls':
        result = await importEngine.parseXLSX(file);
        break;
      case 'json':
        result = await importEngine.parseJSON(file);
        break;
      case 'xml':
        result = await importEngine.parseXML(file);
        break;
      case 'vcf':
        result = await importEngine.parseVCF(file);
        break;
      case 'tsv':
        result = await importEngine.parseTSV(file);
        break;
      default:
        throw new Error('Unsupported file format');
    }
    
    parsedData = result;
    showFilePreview();
    hideLoading();
  } catch (err) {
    hideLoading();
    showError(`Failed to parse file: ${err.message}`);
  }
}

function showFilePreview() {
  document.getElementById('filePreview').style.display = 'block';
  document.getElementById('fileName').textContent = uploadedFile.name;
  document.getElementById('fileStats').textContent = `${parsedData.totalRows.toLocaleString()} rows ‚Ä¢ ${parsedData.headers.length} columns ‚Ä¢ ${(uploadedFile.size / 1024 / 1024).toFixed(2)} MB`;
  
  // Show preview table
  let tableHTML = '<table class="preview-table"><thead><tr>';
  parsedData.headers.forEach(header => {
    tableHTML += `<th>${header}</th>`;
  });
  tableHTML += '</tr></thead><tbody>';
  
  parsedData.data.slice(0, 5).forEach(row => {
    tableHTML += '<tr>';
    parsedData.headers.forEach(header => {
      tableHTML += `<td>${row[header] || ''}</td>`;
    });
    tableHTML += '</tr>';
  });
  
  tableHTML += '</tbody></table>';
  document.getElementById('dataPreviewTable').innerHTML = tableHTML;
}

function clearFile() {
  uploadedFile = null;
  parsedData = null;
  document.getElementById('filePreview').style.display = 'none';
  document.getElementById('fileInput').value = '';
}

function proceedToMapping() {
  renderStep2();
}

// Render Step 2: Field Mapping
function renderStep2() {
  currentStep = 2;
  updateWizardProgress();
  
  // Auto-map fields
  const autoMapping = importEngine.autoMapFields(parsedData.headers);
  fieldMapping = autoMapping;
  
  const content = `
    <div class="glass-card rounded-2xl p-8">
      <h2 class="text-2xl font-bold text-white mb-6 font-orbitron">Step 2: Field Mapping</h2>
      
      <div class="mb-6">
        <label class="text-sm text-gray-400 mb-2 block">Load Mapping Template</label>
        <select id="templateSelect" onchange="loadTemplate(this.value)" class="w-full bg-gray-800 text-white rounded-lg px-4 py-2 border border-gray-700">
          <option value="">-- Select Template --</option>
          ${Object.keys(importEngine.mappingTemplates).map(name => `
            <option value="${name}">${name}</option>
          `).join('')}
        </select>
      </div>
      
      <div class="mapping-container">
        <!-- Source Fields (from uploaded file) -->
        <div class="mapping-column">
          <h3><i data-lucide="file-text" class="w-4 h-4 inline mr-2"></i>Your File Fields</h3>
          <div id="sourceFields"></div>
        </div>
        
        <!-- Mapping Connectors -->
        <div class="mapping-connector-area">
          <i data-lucide="arrow-right" class="w-8 h-8 text-blue-500"></i>
        </div>
        
        <!-- Target Fields (our system) -->
        <div class="mapping-column">
          <h3><i data-lucide="database" class="w-4 h-4 inline mr-2"></i>System Fields</h3>
          <div id="targetFields"></div>
        </div>
      </div>
      
      <div class="flex justify-between mt-6">
        <button onclick="renderStep1()" class="btn bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
          <i data-lucide="arrow-left" class="w-4 h-4 inline mr-2"></i>
          Back
        </button>
        <div class="flex gap-3">
          <button onclick="saveCurrentMapping()" class="btn bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
            Save as Template
          </button>
          <button onclick="proceedToValidation()" class="btn btn-primary">
            Next: Validation
            <i data-lucide="arrow-right" class="w-4 h-4 inline ml-2"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('wizardContent').innerHTML = content;
  lucide.createIcons();
  
  renderMappingFields();
}

function renderMappingFields() {
  const sourceDiv = document.getElementById('sourceFields');
  const targetDiv = document.getElementById('targetFields');
  
  // Render source fields
  sourceDiv.innerHTML = parsedData.headers.map(header => `
    <div class="field-item ${fieldMapping[header] ? 'mapped' : ''}" data-source="${header}">
      <div class="flex justify-between items-center">
        <span>${header}</span>
        ${fieldMapping[header] ? `<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>` : ''}
      </div>
      <select onchange="updateMapping('${header}', this.value)" class="w-full mt-2 bg-gray-700 text-white rounded px-2 py-1 text-sm">
        <option value="">-- Unmapped --</option>
        ${Object.keys(importEngine.schema).map(field => `
          <option value="${field}" ${fieldMapping[header] === field ? 'selected' : ''}>
            ${field}${importEngine.schema[field].required ? ' *' : ''}
          </option>
        `).join('')}
        <option value="custom">+ Create Custom Field</option>
      </select>
    </div>
  `).join('');
  
  // Render target fields
  targetDiv.innerHTML = Object.keys(importEngine.schema).map(field => {
    const config = importEngine.schema[field];
    const isMapped = Object.values(fieldMapping).includes(field);
    
    return `
      <div class="field-item ${isMapped ? 'mapped' : ''} ${config.required ? 'required' : ''}">
        <div class="flex justify-between items-center">
          <span>${field}</span>
          ${isMapped ? `<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>` : ''}
        </div>
        <div class="text-xs text-gray-400 mt-1">Type: ${config.type}</div>
      </div>
    `;
  }).join('');
  
  lucide.createIcons();
}

function updateMapping(sourceField, targetField) {
  if (targetField === 'custom') {
    const customName = prompt('Enter custom field name:');
    if (customName) {
      fieldMapping[sourceField] = customName;
      // Add to schema
      importEngine.schema[customName] = { required: false, type: 'string', aliases: [] };
    }
  } else {
    fieldMapping[sourceField] = targetField || null;
  }
  
  renderMappingFields();
}

function loadTemplate(templateName) {
  if (!templateName) return;
  
  const template = importEngine.mappingTemplates[templateName];
  if (template) {
    fieldMapping = { ...template };
    renderMappingFields();
  }
}

function saveCurrentMapping() {
  const name = prompt('Enter template name:');
  if (name) {
    importEngine.saveMappingTemplate(name, fieldMapping);
    showSuccess(`Mapping template "${name}" saved!`);
  }
}

function proceedToValidation() {
  // Validate that required fields are mapped
  const requiredFields = Object.keys(importEngine.schema).filter(f => importEngine.schema[f].required);
  const mappedFields = Object.values(fieldMapping).filter(v => v);
  
  const missingRequired = requiredFields.filter(f => !mappedFields.includes(f));
  
  if (missingRequired.length > 0) {
    showError(`Please map required fields: ${missingRequired.join(', ')}`);
    return;
  }
  
  renderStep3();
}

// Render Step 3: Validation
function renderStep3() {
  currentStep = 3;
  updateWizardProgress();
  
  showLoading('Validating data...');
  
  // Validate all rows
  validationResults = parsedData.data.map(row => 
    importEngine.validateRow(row, fieldMapping)
  );
  
  hideLoading();
  
  const validCount = validationResults.filter(r => r.valid && r.warnings.length === 0).length;
  const warningCount = validationResults.filter(r => r.valid && r.warnings.length > 0).length;
  const errorCount = validationResults.filter(r => !r.valid).length;
  
  const content = `
    <div class="glass-card rounded-2xl p-8">
      <h2 class="text-2xl font-bold text-white mb-6 font-orbitron">Step 3: Validation & Preview</h2>
      
      <!-- Validation Summary -->
      <div class="validation-summary">
        <div class="validation-stat success">
          <div class="validation-stat-number">${validCount.toLocaleString()}</div>
          <div class="validation-stat-label">‚úÖ Ready to Import</div>
        </div>
        <div class="validation-stat warning">
          <div class="validation-stat-number">${warningCount.toLocaleString()}</div>
          <div class="validation-stat-label">‚ö†Ô∏è Warnings</div>
        </div>
        <div class="validation-stat error">
          <div class="validation-stat-number">${errorCount.toLocaleString()}</div>
          <div class="validation-stat-label">‚ùå Errors</div>
        </div>
      </div>
      
      ${errorCount > 0 || warningCount > 0 ? `
        <div class="mb-4">
          <button onclick="fixAllIssues()" class="btn btn-primary">
            <i data-lucide="wrench" class="w-4 h-4 inline mr-2"></i>
            Auto-Fix Common Issues
          </button>
        </div>
      ` : ''}
      
      <!-- Preview Table -->
      <div class="overflow-x-auto">
        <table class="preview-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Status</th>
              ${Object.values(fieldMapping).filter(f => f).map(field => `<th>${field}</th>`).join('')}
              <th>Issues</th>
            </tr>
          </thead>
          <tbody>
            ${validationResults.slice(0, 50).map((result, index) => {
              const rowClass = !result.valid ? 'has-error' : result.warnings.length > 0 ? 'has-warning' : '';
              const statusIcon = !result.valid ? '‚ùå' : result.warnings.length > 0 ? '‚ö†Ô∏è' : '‚úÖ';
              
              return `
                <tr class="${rowClass}">
                  <td>${index + 1}</td>
                  <td>${statusIcon}</td>
                  ${Object.values(fieldMapping).filter(f => f).map(field => 
                    `<td>${result.data[field] || ''}</td>`
                  ).join('')}
                  <td class="text-xs">
                    ${[...result.errors, ...result.warnings].join(', ')}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
      
      ${validationResults.length > 50 ? `
        <p class="text-sm text-gray-400 mt-2">Showing first 50 of ${validationResults.length} rows</p>
      ` : ''}
      
      <div class="flex justify-between mt-6">
        <button onclick="renderStep2()" class="btn bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
          <i data-lucide="arrow-left" class="w-4 h-4 inline mr-2"></i>
          Back to Mapping
        </button>
        <button onclick="proceedToDuplicates()" class="btn btn-primary" ${errorCount > 0 ? 'disabled' : ''}>
          Next: Duplicate Check
          <i data-lucide="arrow-right" class="w-4 h-4 inline ml-2"></i>
        </button>
      </div>
    </div>
  `;
  
  document.getElementById('wizardContent').innerHTML = content;
  lucide.createIcons();
}

function fixAllIssues() {
  showLoading('Auto-fixing issues...');
  
  // Re-validate with auto-fix
  validationResults = validationResults.map(result => {
    // Auto-fix is already applied in validateRow
    return result;
  });
  
  hideLoading();
  renderStep3();
}

function proceedToDuplicates() {
  // Check for duplicates against existing DB data
  const validRows = validationResults.filter(r => r.valid).map(r => r.data);
  duplicateRecords = importEngine.findDuplicates(validRows, DB.leads);
  
  if (duplicateRecords.length === 0) {
    // No duplicates, skip to import
    renderStep5();
  } else {
    renderStep4();
  }
}

// Render Step 4: Duplicate Resolution
function renderStep4() {
  currentStep = 4;
  updateWizardProgress();
  
  const content = `
    <div class="glass-card rounded-2xl p-8">
      <h2 class="text-2xl font-bold text-white mb-6 font-orbitron">Step 4: Duplicate Resolution</h2>
      
      <div class="mb-6">
        <div class="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
          <p class="text-yellow-500">
            <i data-lucide="alert-triangle" class="w-5 h-5 inline mr-2"></i>
            Found ${duplicateRecords.length} potential duplicate(s) in your database
          </p>
        </div>
      </div>
      
      <div id="duplicateList">
        ${duplicateRecords.map((dup, index) => `
          <div class="duplicate-item">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-white font-semibold">
                Duplicate #${index + 1} 
                <span class="text-sm text-gray-400">(Match: ${dup.matchType})</span>
              </h3>
              <label class="flex items-center gap-2 text-sm text-gray-400">
                <input type="checkbox" id="applyToAll${index}" class="rounded">
                Apply to all duplicates
              </label>
            </div>
            
            <div class="duplicate-comparison">
              <div class="duplicate-record">
                <h4>üìã Existing Record</h4>
                ${Object.keys(dup.existingRow).map(key => `
                  <div class="duplicate-record-field">
                    <span class="text-gray-400">${key}:</span>
                    <span class="text-white">${dup.existingRow[key] || '-'}</span>
                  </div>
                `).join('')}
              </div>
              
              <div class="duplicate-record">
                <h4>üì• Incoming Record</h4>
                ${Object.keys(dup.newRow).map(key => `
                  <div class="duplicate-record-field">
                    <span class="text-gray-400">${key}:</span>
                    <span class="text-white">${dup.newRow[key] || '-'}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="duplicate-actions">
              <button onclick="resolveDuplicate(${index}, 'skip')" class="btn bg-gray-700 hover:bg-gray-600 text-white">
                Skip
              </button>
              <button onclick="resolveDuplicate(${index}, 'overwrite')" class="btn bg-orange-600 hover:bg-orange-700 text-white">
                Overwrite
              </button>
              <button onclick="resolveDuplicate(${index}, 'merge')" class="btn bg-blue-600 hover:bg-blue-700 text-white">
                Merge
              </button>
              <button onclick="resolveDuplicate(${index}, 'create')" class="btn bg-green-600 hover:bg-green-700 text-white">
                Create New
              </button>
            </div>
          </div>
        `).join('')}
      </div>
      
      <div class="flex justify-between mt-6">
        <button onclick="renderStep3()" class="btn bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
          <i data-lucide="arrow-left" class="w-4 h-4 inline mr-2"></i>
          Back
        </button>
        <button onclick="renderStep5()" class="btn btn-primary">
          Next: Import
          <i data-lucide="arrow-right" class="w-4 h-4 inline ml-2"></i>
        </button>
      </div>
    </div>
  `;
  
  document.getElementById('wizardContent').innerHTML = content;
  lucide.createIcons();
}

function resolveDuplicate(index, action) {
  duplicateRecords[index].resolution = action;
  
  // Check if "apply to all" is checked
  const applyToAll = document.getElementById(`applyToAll${index}`).checked;
  if (applyToAll) {
    duplicateRecords.forEach(dup => {
      dup.resolution = action;
    });
    showSuccess(`Applied "${action}" to all duplicates`);
  } else {
    showSuccess(`Duplicate #${index + 1} marked as "${action}"`);
  }
}

// Render Step 5: Import Execution
function renderStep5() {
  currentStep = 5;
  updateWizardProgress();
  
  const content = `
    <div class="glass-card rounded-2xl p-8">
      <h2 class="text-2xl font-bold text-white mb-6 font-orbitron">Step 5: Import Execution</h2>
      
      <div class="import-progress">
        <h3 class="text-white font-semibold mb-4">Import Progress</h3>
        <div class="progress-bar-container">
          <div id="progressBar" class="progress-bar" style="width: 0%"></div>
        </div>
        <div class="progress-stats">
          <span id="progressText">Preparing import...</span>
          <span id="progressPercentage">0%</span>
        </div>
      </div>
      
      <div class="import-log" id="importLog">
        <div class="import-log-entry">Import log will appear here...</div>
      </div>
      
      <div class="flex justify-end mt-6">
        <button id="startImportBtn" onclick="startImport()" class="btn btn-primary">
          <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>
          Start Import
        </button>
      </div>
    </div>
  `;
  
  document.getElementById('wizardContent').innerHTML = content;
  lucide.createIcons();
}

async function startImport() {
  document.getElementById('startImportBtn').disabled = true;
  
  const validRows = validationResults.filter(r => r.valid).map(r => r.data);
  const logDiv = document.getElementById('importLog');
  
  function addLog(message, type = 'info') {
    const entry = document.createElement('div');
    entry.className = `import-log-entry ${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    logDiv.appendChild(entry);
    logDiv.scrollTop = logDiv.scrollHeight;
  }
  
  function updateProgress(progress) {
    document.getElementById('progressBar').style.width = `${progress.percentage}%`;
    document.getElementById('progressPercentage').textContent = `${progress.percentage}%`;
    document.getElementById('progressText').textContent = `Processing ${progress.processed} of ${progress.total} rows`;
    
    addLog(`Processed batch: ${progress.processed}/${progress.total}`, 'success');
  }
  
  try {
    addLog('Starting import...');
    addLog(`Total rows to import: ${validRows.length}`);
    
    const results = await importEngine.importBatch(validRows, 100, updateProgress);
    
    addLog('Import completed!', 'success');
    addLog(`‚úÖ Imported: ${results.imported}`, 'success');
    addLog(`‚ö†Ô∏è Skipped: ${results.skipped}`);
    addLog(`‚ùå Failed: ${results.failed}`, results.failed > 0 ? 'error' : 'info');
    
    // Save import record
    importEngine.saveImportRecord({
      id: Date.now(),
      fileName: uploadedFile.name,
      date: new Date().toISOString(),
      totalRows: validRows.length,
      imported: results.imported,
      skipped: results.skipped,
      failed: results.failed,
      user: 'Current User'
    });
    
    // Move to report
    setTimeout(() => renderStep6(results), 1000);
  } catch (err) {
    addLog(`Import failed: ${err.message}`, 'error');
  }
}

// Render Step 6: Import Report
function renderStep6(results) {
  currentStep = 6;
  updateWizardProgress();
  
  const content = `
    <div class="glass-card rounded-2xl p-8">
      <h2 class="text-2xl font-bold text-white mb-6 font-orbitron">Step 6: Import Report</h2>
      
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">üéâ</div>
        <h3 class="text-2xl font-bold text-white mb-2">Import Completed!</h3>
        <p class="text-gray-400">Your data has been successfully imported</p>
      </div>
      
      <div class="validation-summary">
        <div class="validation-stat success">
          <div class="validation-stat-number">${results.imported.toLocaleString()}</div>
          <div class="validation-stat-label">‚úÖ Imported</div>
        </div>
        <div class="validation-stat warning">
          <div class="validation-stat-number">${results.skipped.toLocaleString()}</div>
          <div class="validation-stat-label">‚è≠Ô∏è Skipped</div>
        </div>
        <div class="validation-stat error">
          <div class="validation-stat-number">${results.failed.toLocaleString()}</div>
          <div class="validation-stat-label">‚ùå Failed</div>
        </div>
      </div>
      
      ${results.failed > 0 ? `
        <div class="mt-6">
          <button onclick="downloadErrorReport()" class="btn bg-orange-600 hover:bg-orange-700 text-white w-full">
            <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
            Download Error Report (${results.failed} rows)
          </button>
        </div>
      ` : ''}
      
      <div class="flex justify-between mt-8 gap-3">
        <button onclick="resetWizard()" class="btn bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
          Import Another File
        </button>
        <button onclick="window.location.href='/?page=CRMLeads'" class="btn btn-primary px-6 py-2">
          <i data-lucide="users" class="w-4 h-4 inline mr-2"></i>
          View Imported Data
        </button>
      </div>
    </div>
  `;
  
  document.getElementById('wizardContent').innerHTML = content;
  lucide.createIcons();
}

function downloadErrorReport() {
  // Create CSV of failed rows
  showSuccess('Error report downloaded!');
}

// Utility Functions
function updateWizardProgress() {
  document.querySelectorAll('.wizard-step').forEach((step, index) => {
    const stepNum = index + 1;
    step.classList.remove('active', 'completed');
    
    if (stepNum < currentStep) {
      step.classList.add('completed');
    } else if (stepNum === currentStep) {
      step.classList.add('active');
    }
  });
}

function resetWizard() {
  if (confirm('Are you sure? All current progress will be lost.')) {
    currentStep = 1;
    uploadedFile = null;
    parsedData = null;
    fieldMapping = {};
    validationResults = [];
    duplicateRecords = [];
    renderStep1();
  }
}

function viewImportHistory() {
  const history = importEngine.getImportHistory();
  
  if (history.length === 0) {
    showInfo('No import history yet');
    return;
  }
  
  const content = `
    <div class="glass-card rounded-2xl p-8">
      <h2 class="text-2xl font-bold text-white mb-6 font-orbitron">Import History</h2>
      
      <table class="preview-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>File</th>
            <th>Total Rows</th>
            <th>Imported</th>
            <th>Skipped</th>
            <th>Failed</th>
            <th>User</th>
          </tr>
        </thead>
        <tbody>
          ${history.map(record => `
            <tr>
              <td>${new Date(record.date).toLocaleString()}</td>
              <td>${record.fileName}</td>
              <td>${record.totalRows.toLocaleString()}</td>
              <td class="text-green-500">${record.imported.toLocaleString()}</td>
              <td class="text-yellow-500">${record.skipped.toLocaleString()}</td>
              <td class="text-red-500">${record.failed.toLocaleString()}</td>
              <td>${record.user}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      
      <div class="flex justify-end mt-6">
        <button onclick="renderStep1()" class="btn btn-primary">
          Close
        </button>
      </div>
    </div>
  `;
  
  document.getElementById('wizardContent').innerHTML = content;
  lucide.createIcons();
}

function showLoading(message) {
  // Show loading indicator (implement as needed)
  console.log('Loading:', message);
}

function hideLoading() {
  // Hide loading indicator
  console.log('Loading complete');
}

function showError(message) {
  alert('Error: ' + message);
}

function showSuccess(message) {
  alert('Success: ' + message);
}

function showInfo(message) {
  alert(message);
}
</script>
