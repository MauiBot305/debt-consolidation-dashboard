<div id="crmLeads" class="page-container">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght:400;500;600;700;800;900&display=swap');

    .leads-container {
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .leads-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 24px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 24px;
      backdrop-filter: blur(10px);
    }

    .leads-header h2 {
      margin: 0;
      color: white;
      font-weight: 700;
      font-size: 28px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .action-btn {
      padding: 12px 24px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
      color: white;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .action-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .action-btn:hover::before {
      opacity: 1;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
      border-color: #3B82F6;
    }

    .action-btn span {
      position: relative;
      z-index: 1;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      border-color: #3B82F6;
    }

    .filters-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 24px;
      backdrop-filter: blur(10px);
    }

    .search-box {
      flex: 1;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 14px 48px 14px 20px;
      background: rgba(10, 15, 26, 0.6);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      color: white;
      font-size: 15px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .search-input:focus {
      outline: none;
      border-color: #3B82F6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      opacity: 0.5;
    }

    .filter-select {
      padding: 14px 20px;
      background: rgba(10, 15, 26, 0.6);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .filter-select:hover {
      border-color: #3B82F6;
    }

    .filter-select:focus {
      outline: none;
      border-color: #3B82F6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .leads-table-container {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 24px;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .leads-table {
      width: 100%;
      border-collapse: collapse;
    }

    .leads-table thead {
      background: linear-gradient(135deg, rgba(10, 15, 26, 0.9), rgba(10, 15, 26, 0.7));
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .leads-table th {
      padding: 16px;
      text-align: left;
      color: #64748B;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 600;
      border-bottom: 2px solid rgba(59, 130, 246, 0.2);
      cursor: pointer;
      transition: all 0.3s;
      user-select: none;
    }

    .leads-table th:hover {
      color: #3B82F6;
      background: rgba(59, 130, 246, 0.05);
    }

    .leads-table th.sortable::after {
      content: ' ‚áÖ';
      opacity: 0.3;
      font-size: 14px;
    }

    .leads-table th.sorted-asc::after {
      content: ' ‚Üë';
      opacity: 1;
      color: #3B82F6;
    }

    .leads-table th.sorted-desc::after {
      content: ' ‚Üì';
      opacity: 1;
      color: #3B82F6;
    }

    .leads-table tbody tr {
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .leads-table tbody tr:nth-child(even) {
      background: rgba(10, 15, 26, 0.3);
    }

    .leads-table tbody tr:hover {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
      box-shadow: inset 4px 0 0 #3B82F6, 0 2px 8px rgba(59, 130, 246, 0.2);
      transform: translateX(4px);
    }

    .leads-table td {
      padding: 16px;
      color: white;
      font-size: 14px;
    }

    .lead-name {
      font-weight: 600;
      color: #3B82F6;
    }

    .lead-phone {
      font-family: 'Orbitron', monospace;
      color: #94A3B8;
      font-size: 13px;
    }

    .lead-debt {
      font-family: 'Orbitron', monospace;
      font-weight: 600;
      font-size: 15px;
    }

    .debt-low {
      color: #22C55E;
      text-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
    }

    .debt-medium {
      color: #F59E0B;
      text-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
    }

    .debt-high {
      color: #EF4444;
      text-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
    }

    .lead-score {
      position: relative;
      width: 60px;
      height: 60px;
    }

    .score-circle {
      transform: rotate(-90deg);
    }

    .score-bg {
      fill: none;
      stroke: rgba(59, 130, 246, 0.1);
      stroke-width: 6;
    }

    .score-progress {
      fill: none;
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      font-size: 14px;
      color: white;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid;
    }

    .status-new {
      background: rgba(59, 130, 246, 0.2);
      border-color: #3B82F6;
      color: #3B82F6;
    }

    .status-contacted {
      background: rgba(245, 158, 11, 0.2);
      border-color: #F59E0B;
      color: #F59E0B;
    }

    .status-qualified {
      background: rgba(6, 182, 212, 0.2);
      border-color: #06B6D4;
      color: #06B6D4;
    }

    .status-enrolled {
      background: rgba(34, 197, 94, 0.2);
      border-color: #22C55E;
      color: #22C55E;
    }

    .bulk-actions {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      background: rgba(10, 15, 26, 0.6);
      border-top: 1px solid rgba(59, 130, 246, 0.2);
      align-items: center;
    }

    .bulk-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #3B82F6;
    }

    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: rgba(10, 15, 26, 0.6);
      border-top: 1px solid rgba(59, 130, 246, 0.2);
    }

    .pagination-info {
      color: #94A3B8;
      font-size: 14px;
    }

    .pagination-controls {
      display: flex;
      gap: 8px;
    }

    .page-btn {
      padding: 8px 16px;
      background: rgba(10, 15, 26, 0.6);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    .page-btn:hover:not(:disabled) {
      background: rgba(59, 130, 246, 0.2);
      border-color: #3B82F6;
    }

    .page-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .page-btn.active {
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      border-color: #3B82F6;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(10, 15, 26, 0.98));
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 24px;
      padding: 32px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.5);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid rgba(59, 130, 246, 0.2);
    }

    .modal-header h3 {
      margin: 0;
      color: white;
      font-size: 24px;
      font-weight: 700;
    }

    .modal-close {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(239, 68, 68, 0.2);
      color: #EF4444;
      border-radius: 10px;
      cursor: pointer;
      font-size: 24px;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: #EF4444;
      color: white;
      transform: rotate(90deg);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      color: #94A3B8;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input {
      padding: 12px 16px;
      background: rgba(10, 15, 26, 0.6);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 10px;
      color: white;
      font-size: 15px;
      transition: all 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #3B82F6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .debt-items {
      margin-top: 16px;
    }

    .debt-item {
      padding: 16px;
      background: rgba(10, 15, 26, 0.4);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      margin-bottom: 12px;
    }

    .debt-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .remove-debt-btn {
      padding: 6px 12px;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #EF4444;
      border-radius: 6px;
      color: #EF4444;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }

    .remove-debt-btn:hover {
      background: #EF4444;
      color: white;
    }

    .add-debt-btn {
      width: 100%;
      padding: 12px;
      background: rgba(59, 130, 246, 0.2);
      border: 2px dashed rgba(59, 130, 246, 0.5);
      border-radius: 10px;
      color: #3B82F6;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .add-debt-btn:hover {
      background: rgba(59, 130, 246, 0.3);
      border-color: #3B82F6;
    }

    .calculated-value {
      padding: 16px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(6, 182, 212, 0.2));
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      text-align: center;
    }

    .calculated-label {
      color: #94A3B8;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .calculated-amount {
      color: white;
      font-size: 28px;
      font-weight: 700;
      font-family: 'Orbitron', monospace;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid rgba(59, 130, 246, 0.2);
    }

    .modal-btn {
      flex: 1;
      padding: 14px 24px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      background: rgba(10, 15, 26, 0.6);
      color: white;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
    }

    .modal-btn.primary {
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      border-color: #3B82F6;
    }

    .modal-btn.primary:hover {
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
    }
  </style>

  <div class="leads-container">
    <!-- Header -->
    <div class="leads-header">
      <h2>CRM Leads</h2>
      <div class="header-actions">
        <button class="action-btn" onclick="importCSV()">
          <span>üì• Import CSV</span>
        </button>
        <button class="action-btn" onclick="exportCSV()">
          <span>üì§ Export CSV</span>
        </button>
        <button class="action-btn primary" onclick="openAddLeadModal()">
          <span>‚ûï Add New Lead</span>
        </button>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
      <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="Search leads by name, phone, email..." />
        <span class="search-icon">üîç</span>
      </div>
      <select class="filter-select" id="statusFilter">
        <option value="">All Statuses</option>
        <option value="new">New</option>
        <option value="contacted">Contacted</option>
        <option value="qualified">Qualified</option>
        <option value="enrolled">Enrolled</option>
      </select>
      <select class="filter-select" id="sourceFilter">
        <option value="">All Sources</option>
        <option value="web">Web</option>
        <option value="referral">Referral</option>
        <option value="social">Social Media</option>
        <option value="cold-call">Cold Call</option>
      </select>
      <select class="filter-select" id="agentFilter">
        <option value="">All Agents</option>
        <option value="John Doe">John Doe</option>
        <option value="Jane Smith">Jane Smith</option>
        <option value="Mike Johnson">Mike Johnson</option>
      </select>
    </div>

    <!-- Table -->
    <div class="leads-table-container">
      <table class="leads-table">
        <thead>
          <tr>
            <th style="width: 40px;"><input type="checkbox" class="bulk-checkbox" id="selectAll" /></th>
            <th class="sortable" data-sort="name">Name</th>
            <th class="sortable" data-sort="phone">Phone</th>
            <th class="sortable" data-sort="email">Email</th>
            <th class="sortable" data-sort="totalDebt">Total Debt</th>
            <th class="sortable" data-sort="monthlyIncome">Monthly Income</th>
            <th class="sortable" data-sort="dtiRatio">DTI Ratio</th>
            <th class="sortable" data-sort="source">Source</th>
            <th class="sortable" data-sort="status">Status</th>
            <th>Agent</th>
            <th class="sortable" data-sort="lastContact">Last Contact</th>
            <th class="sortable" data-sort="score">Score</th>
          </tr>
        </thead>
        <tbody id="leadsTableBody">
          <!-- Dynamic rows -->
        </tbody>
      </table>

      <!-- Bulk Actions -->
      <div class="bulk-actions" id="bulkActions" style="display: none;">
        <span style="color: white; font-weight: 600;"><span id="selectedCount">0</span> selected</span>
        <button class="action-btn" onclick="bulkAssign()">
          <span>üë§ Assign</span>
        </button>
        <button class="action-btn" onclick="bulkTag()">
          <span>üè∑Ô∏è Tag</span>
        </button>
        <button class="action-btn" onclick="bulkExport()">
          <span>üì§ Export</span>
        </button>
        <button class="action-btn" style="border-color: #EF4444; color: #EF4444;" onclick="bulkDelete()">
          <span>üóëÔ∏è Delete</span>
        </button>
      </div>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pagination-info">
          Showing <span id="showingStart">1</span>-<span id="showingEnd">25</span> of <span id="totalLeads">0</span> leads
        </div>
        <div class="pagination-controls">
          <button class="page-btn" id="prevPage" onclick="previousPage()">‚Üê Previous</button>
          <button class="page-btn active" id="page1" onclick="goToPage(1)">1</button>
          <button class="page-btn" id="page2" onclick="goToPage(2)">2</button>
          <button class="page-btn" id="page3" onclick="goToPage(3)">3</button>
          <button class="page-btn" id="nextPage" onclick="nextPage()">Next ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Lead Modal (hidden by default) -->
  <div id="addLeadModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Lead</h3>
        <button class="modal-close" onclick="closeAddLeadModal()">√ó</button>
      </div>

      <form id="addLeadForm" onsubmit="submitLead(event)">
        <!-- Personal Info -->
        <h4 style="color: #3B82F6; margin-bottom: 16px;">Personal Information</h4>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Full Name *</label>
            <input type="text" class="form-input" name="name" required />
          </div>
          <div class="form-group">
            <label class="form-label">Phone *</label>
            <input type="tel" class="form-input" name="phone" required />
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" name="email" />
          </div>
          <div class="form-group">
            <label class="form-label">SSN Last 4</label>
            <input type="text" class="form-input" name="ssnLast4" maxlength="4" pattern="[0-9]{4}" />
          </div>
          <div class="form-group full-width">
            <label class="form-label">Address</label>
            <input type="text" class="form-input" name="address" />
          </div>
        </div>

        <!-- Financial Info -->
        <h4 style="color: #3B82F6; margin: 24px 0 16px;">Financial Information</h4>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Monthly Income</label>
            <input type="number" class="form-input" name="monthlyIncome" id="monthlyIncome" oninput="calculateDTI()" />
          </div>
          <div class="form-group">
            <label class="form-label">Employment Status</label>
            <select class="form-input" name="employmentStatus">
              <option value="employed">Employed</option>
              <option value="self-employed">Self-Employed</option>
              <option value="unemployed">Unemployed</option>
              <option value="retired">Retired</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label class="form-label">Employer</label>
            <input type="text" class="form-input" name="employer" />
          </div>
        </div>

        <!-- Debt Details -->
        <h4 style="color: #3B82F6; margin: 24px 0 16px;">Debt Details</h4>
        <div class="debt-items" id="debtItems">
          <!-- Dynamic debt items -->
        </div>
        <button type="button" class="add-debt-btn" onclick="addDebtItem()">‚ûï Add Creditor</button>

        <!-- Calculated Values -->
        <div class="form-grid" style="margin-top: 24px;">
          <div class="calculated-value">
            <div class="calculated-label">Total Debt</div>
            <div class="calculated-amount" id="totalDebtDisplay">$0</div>
          </div>
          <div class="calculated-value">
            <div class="calculated-label">DTI Ratio</div>
            <div class="calculated-amount" id="dtiRatioDisplay">0%</div>
          </div>
        </div>

        <!-- Lead Metadata -->
        <h4 style="color: #3B82F6; margin: 24px 0 16px;">Lead Information</h4>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Lead Source</label>
            <select class="form-input" name="source">
              <option value="web">Web</option>
              <option value="referral">Referral</option>
              <option value="social">Social Media</option>
              <option value="cold-call">Cold Call</option>
              <option value="event">Event</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Assigned Agent</label>
            <select class="form-input" name="assignedAgent">
              <option value="">Unassigned</option>
              <option value="John Doe">John Doe</option>
              <option value="Jane Smith">Jane Smith</option>
              <option value="Mike Johnson">Mike Johnson</option>
            </select>
          </div>
        </div>

        <!-- Actions -->
        <div class="modal-actions">
          <button type="button" class="modal-btn" onclick="closeAddLeadModal()">Cancel</button>
          <button type="submit" class="modal-btn primary">üíæ Save Lead</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Sample lead data
    let leads = [];
    let currentPage = 1;
    const leadsPerPage = 25;
    let currentSort = { field: null, direction: 'asc' };
    let selectedLeads = new Set();
    let debtItemCounter = 0;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadLeads();
      setupFilters();
      setupSort();
      renderLeads();
    });

    // Load leads from localStorage or generate sample data
    function loadLeads() {
      const stored = localStorage.getItem('crmLeads');
      if (stored) {
        leads = JSON.parse(stored);
      } else {
        // Generate sample leads
        leads = generateSampleLeads(50);
        saveLeads();
      }
    }

    // Save leads to localStorage
    function saveLeads() {
      localStorage.setItem('crmLeads', JSON.stringify(leads));
    }

    // Generate sample leads
    function generateSampleLeads(count) {
      const names = ['John Smith', 'Sarah Johnson', 'Michael Brown', 'Emily Davis', 'David Wilson', 'Jennifer Martinez', 'Robert Taylor', 'Lisa Anderson', 'William Thomas', 'Mary Jackson'];
      const sources = ['web', 'referral', 'social', 'cold-call', 'event'];
      const statuses = ['new', 'contacted', 'qualified', 'enrolled'];
      const agents = ['John Doe', 'Jane Smith', 'Mike Johnson'];

      const sampleLeads = [];
      for (let i = 0; i < count; i++) {
        const totalDebt = Math.floor(Math.random() * 50000) + 5000;
        const monthlyIncome = Math.floor(Math.random() * 5000) + 2000;
        const monthlyPayment = Math.floor(totalDebt * 0.02);
        const dtiRatio = Math.round((monthlyPayment / monthlyIncome) * 100);
        const score = Math.min(100, Math.max(0, 100 - (dtiRatio * 0.5) + (monthlyIncome / 100)));

        sampleLeads.push({
          id: `LEAD_${Date.now()}_${i}`,
          name: names[Math.floor(Math.random() * names.length)],
          phone: `(555) ${String(Math.floor(Math.random() * 900) + 100)}-${String(Math.floor(Math.random() * 9000) + 1000)}`,
          email: `lead${i}@example.com`,
          totalDebt: totalDebt,
          monthlyIncome: monthlyIncome,
          dtiRatio: dtiRatio,
          source: sources[Math.floor(Math.random() * sources.length)],
          status: statuses[Math.floor(Math.random() * statuses.length)],
          assignedAgent: agents[Math.floor(Math.random() * agents.length)],
          lastContact: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
          score: Math.round(score),
          createdAt: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toISOString()
        });
      }
      return sampleLeads;
    }

    // Render leads table
    function renderLeads() {
      const filtered = filterLeads();
      const sorted = sortLeads(filtered);
      const paginated = paginateLeads(sorted);

      const tbody = document.getElementById('leadsTableBody');
      tbody.innerHTML = paginated.map(lead => {
        const debtClass = lead.totalDebt < 15000 ? 'debt-low' : lead.totalDebt < 30000 ? 'debt-medium' : 'debt-high';
        const scoreColor = lead.score >= 70 ? '#22C55E' : lead.score >= 40 ? '#F59E0B' : '#EF4444';
        const circumference = 2 * Math.PI * 24;
        const offset = circumference - (lead.score / 100) * circumference;

        return `
          <tr onclick="viewLead('${lead.id}')">
            <td onclick="event.stopPropagation()">
              <input type="checkbox" class="bulk-checkbox lead-checkbox" data-id="${lead.id}" onchange="toggleSelect(event, '${lead.id}')" ${selectedLeads.has(lead.id) ? 'checked' : ''} />
            </td>
            <td class="lead-name">${lead.name}</td>
            <td class="lead-phone">${lead.phone}</td>
            <td>${lead.email}</td>
            <td class="lead-debt ${debtClass}">$${lead.totalDebt.toLocaleString()}</td>
            <td class="lead-debt">$${lead.monthlyIncome.toLocaleString()}</td>
            <td class="lead-debt">${lead.dtiRatio}%</td>
            <td>${capitalizeFirst(lead.source)}</td>
            <td><span class="status-badge status-${lead.status}">${lead.status}</span></td>
            <td>${lead.assignedAgent}</td>
            <td>${new Date(lead.lastContact).toLocaleDateString()}</td>
            <td>
              <div class="lead-score">
                <svg class="score-circle" width="60" height="60">
                  <circle class="score-bg" cx="30" cy="30" r="24" />
                  <circle class="score-progress" cx="30" cy="30" r="24" 
                    stroke="${scoreColor}"
                    stroke-dasharray="${circumference}"
                    stroke-dashoffset="${offset}"
                    style="filter: drop-shadow(0 0 4px ${scoreColor});" />
                </svg>
                <div class="score-text">${lead.score}</div>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      updatePagination(filtered.length);
    }

    // Filter leads
    function filterLeads() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const sourceFilter = document.getElementById('sourceFilter').value;
      const agentFilter = document.getElementById('agentFilter').value;

      return leads.filter(lead => {
        const matchesSearch = !search || 
          lead.name.toLowerCase().includes(search) ||
          lead.phone.includes(search) ||
          lead.email.toLowerCase().includes(search);
        
        const matchesStatus = !statusFilter || lead.status === statusFilter;
        const matchesSource = !sourceFilter || lead.source === sourceFilter;
        const matchesAgent = !agentFilter || lead.assignedAgent === agentFilter;

        return matchesSearch && matchesStatus && matchesSource && matchesAgent;
      });
    }

    // Sort leads
    function sortLeads(leadsArray) {
      if (!currentSort.field) return leadsArray;

      return [...leadsArray].sort((a, b) => {
        let aVal = a[currentSort.field];
        let bVal = b[currentSort.field];

        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    // Paginate leads
    function paginateLeads(leadsArray) {
      const start = (currentPage - 1) * leadsPerPage;
      const end = start + leadsPerPage;
      return leadsArray.slice(start, end);
    }

    // Update pagination UI
    function updatePagination(totalFiltered) {
      const start = (currentPage - 1) * leadsPerPage + 1;
      const end = Math.min(currentPage * leadsPerPage, totalFiltered);
      
      document.getElementById('showingStart').textContent = start;
      document.getElementById('showingEnd').textContent = end;
      document.getElementById('totalLeads').textContent = totalFiltered;

      const totalPages = Math.ceil(totalFiltered / leadsPerPage);
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage >= totalPages;

      // Update page buttons
      for (let i = 1; i <= 3; i++) {
        const btn = document.getElementById(`page${i}`);
        if (i <= totalPages) {
          btn.style.display = 'block';
          btn.classList.toggle('active', i === currentPage);
          btn.textContent = i;
        } else {
          btn.style.display = 'none';
        }
      }
    }

    // Setup filters
    function setupFilters() {
      const inputs = ['searchInput', 'statusFilter', 'sourceFilter', 'agentFilter'];
      inputs.forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
          currentPage = 1;
          renderLeads();
        });
      });
    }

    // Setup sorting
    function setupSort() {
      document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const field = th.dataset.sort;
          
          if (currentSort.field === field) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.field = field;
            currentSort.direction = 'asc';
          }

          // Update UI
          document.querySelectorAll('.sortable').forEach(t => {
            t.classList.remove('sorted-asc', 'sorted-desc');
          });
          th.classList.add(`sorted-${currentSort.direction}`);

          renderLeads();
        });
      });
    }

    // Toggle select
    function toggleSelect(event, leadId) {
      event.stopPropagation();
      if (selectedLeads.has(leadId)) {
        selectedLeads.delete(leadId);
      } else {
        selectedLeads.add(leadId);
      }
      updateBulkActions();
    }

    // Select all
    document.getElementById('selectAll')?.addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.lead-checkbox');
      checkboxes.forEach(cb => {
        const leadId = cb.dataset.id;
        if (e.target.checked) {
          selectedLeads.add(leadId);
          cb.checked = true;
        } else {
          selectedLeads.delete(leadId);
          cb.checked = false;
        }
      });
      updateBulkActions();
    });

    // Update bulk actions
    function updateBulkActions() {
      const bulkActions = document.getElementById('bulkActions');
      const count = selectedLeads.size;
      document.getElementById('selectedCount').textContent = count;
      bulkActions.style.display = count > 0 ? 'flex' : 'none';
    }

    // Pagination functions
    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        renderLeads();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filterLeads().length / leadsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderLeads();
      }
    }

    function goToPage(page) {
      currentPage = page;
      renderLeads();
    }

    // View lead details
    function viewLead(leadId) {
      const lead = leads.find(l => l.id === leadId);
      if (lead) {
        alert(`View lead: ${lead.name}\n\nThis would open a slide-out panel with full lead details.`);
        // TODO: Implement slide-out panel
      }
    }

    // Add lead modal functions
    function openAddLeadModal() {
      document.getElementById('addLeadModal').style.display = 'flex';
      debtItemCounter = 0;
      document.getElementById('debtItems').innerHTML = '';
      addDebtItem(); // Add first debt item by default
    }

    function closeAddLeadModal() {
      document.getElementById('addLeadModal').style.display = 'none';
      document.getElementById('addLeadForm').reset();
    }

    // Add debt item
    function addDebtItem() {
      const container = document.getElementById('debtItems');
      const id = ++debtItemCounter;
      
      const item = document.createElement('div');
      item.className = 'debt-item';
      item.id = `debt-item-${id}`;
      item.innerHTML = `
        <div class="debt-item-header">
          <strong style="color: white;">Creditor ${id}</strong>
          <button type="button" class="remove-debt-btn" onclick="removeDebtItem(${id})">Remove</button>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Creditor Name</label>
            <input type="text" class="form-input debt-input" name="debtCreditor${id}" />
          </div>
          <div class="form-group">
            <label class="form-label">Debt Type</label>
            <select class="form-input debt-input" name="debtType${id}">
              <option value="credit-card">Credit Card</option>
              <option value="personal-loan">Personal Loan</option>
              <option value="medical">Medical</option>
              <option value="auto">Auto Loan</option>
              <option value="student">Student Loan</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Balance</label>
            <input type="number" class="form-input debt-input debt-balance" name="debtBalance${id}" oninput="calculateTotals()" />
          </div>
          <div class="form-group">
            <label class="form-label">Interest Rate (%)</label>
            <input type="number" class="form-input debt-input" name="debtRate${id}" step="0.01" />
          </div>
          <div class="form-group">
            <label class="form-label">Monthly Payment</label>
            <input type="number" class="form-input debt-input debt-payment" name="debtPayment${id}" oninput="calculateDTI()" />
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-input debt-input" name="debtStatus${id}">
              <option value="current">Current</option>
              <option value="30-days">30 Days Late</option>
              <option value="60-days">60 Days Late</option>
              <option value="90-days">90+ Days Late</option>
              <option value="collections">In Collections</option>
            </select>
          </div>
        </div>
      `;
      container.appendChild(item);
    }

    // Remove debt item
    function removeDebtItem(id) {
      const item = document.getElementById(`debt-item-${id}`);
      if (item) {
        item.remove();
        calculateTotals();
      }
    }

    // Calculate totals
    function calculateTotals() {
      const balances = document.querySelectorAll('.debt-balance');
      let totalDebt = 0;
      balances.forEach(input => {
        totalDebt += parseFloat(input.value) || 0;
      });
      document.getElementById('totalDebtDisplay').textContent = `$${totalDebt.toLocaleString()}`;
      calculateDTI();
    }

    // Calculate DTI ratio
    function calculateDTI() {
      const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value) || 0;
      const payments = document.querySelectorAll('.debt-payment');
      let totalPayment = 0;
      payments.forEach(input => {
        totalPayment += parseFloat(input.value) || 0;
      });

      const dtiRatio = monthlyIncome > 0 ? Math.round((totalPayment / monthlyIncome) * 100) : 0;
      document.getElementById('dtiRatioDisplay').textContent = `${dtiRatio}%`;
    }

    // Submit lead form
    function submitLead(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const newLead = {
        id: `LEAD_${Date.now()}`,
        name: formData.get('name'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        totalDebt: parseFloat(document.getElementById('totalDebtDisplay').textContent.replace(/[$,]/g, '')),
        monthlyIncome: parseFloat(formData.get('monthlyIncome')) || 0,
        dtiRatio: parseInt(document.getElementById('dtiRatioDisplay').textContent.replace('%', '')),
        source: formData.get('source'),
        status: 'new',
        assignedAgent: formData.get('assignedAgent') || 'Unassigned',
        lastContact: new Date().toISOString(),
        score: 50, // Default score
        createdAt: new Date().toISOString()
      };

      leads.unshift(newLead);
      saveLeads();
      renderLeads();
      closeAddLeadModal();
      
      alert(`‚úÖ Lead "${newLead.name}" added successfully!`);
    }

    // Bulk actions
    function bulkAssign() {
      const agent = prompt('Assign to agent:');
      if (agent) {
        selectedLeads.forEach(id => {
          const lead = leads.find(l => l.id === id);
          if (lead) lead.assignedAgent = agent;
        });
        saveLeads();
        renderLeads();
        selectedLeads.clear();
        updateBulkActions();
      }
    }

    function bulkTag() {
      alert('Bulk tagging feature coming soon!');
    }

    function bulkExport() {
      const selected = leads.filter(l => selectedLeads.has(l.id));
      const csv = convertToCSV(selected);
      downloadCSV(csv, 'selected-leads.csv');
      alert(`Exported ${selected.length} leads`);
    }

    function bulkDelete() {
      if (confirm(`Delete ${selectedLeads.size} leads? This cannot be undone.`)) {
        leads = leads.filter(l => !selectedLeads.has(l.id));
        saveLeads();
        renderLeads();
        selectedLeads.clear();
        updateBulkActions();
      }
    }

    // Import/Export CSV
    function importCSV() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.csv';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            alert('CSV import functionality coming soon!');
            // TODO: Parse CSV and add to leads
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    function exportCSV() {
      const csv = convertToCSV(leads);
      downloadCSV(csv, 'all-leads.csv');
      alert(`Exported ${leads.length} leads`);
    }

    function convertToCSV(data) {
      const headers = ['Name', 'Phone', 'Email', 'Total Debt', 'Monthly Income', 'DTI Ratio', 'Source', 'Status', 'Agent', 'Score'];
      const rows = data.map(l => [
        l.name, l.phone, l.email, l.totalDebt, l.monthlyIncome, l.dtiRatio,
        l.source, l.status, l.assignedAgent, l.score
      ]);
      return [headers, ...rows].map(row => row.join(',')).join('\n');
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Helper function
    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1).replace('-', ' ');
    }
  </script>
</div>
