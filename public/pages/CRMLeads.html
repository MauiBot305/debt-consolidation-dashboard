<!-- CRM LEADS - Complete Rebuild by SONNET AGENT 2 -->
<!-- Enterprise-scale for 7,840+ client base -->
<!-- All JavaScript is INLINE (executes via loadPage fix) -->

<div id="crmLeads" class="page-container">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap');

    * { box-sizing: border-box; }

    .page-container { animation: fadeInUp 0.6s ease-out; }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Header */
    .leads-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 24px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 24px;
      backdrop-filter: blur(10px);
    }

    .leads-header h2 { margin: 0; color: white; font-weight: 700; font-size: 28px; }

    .header-actions { display: flex; gap: 12px; }

    .action-btn {
      padding: 12px 24px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
      color: white;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
      border-color: #3B82F6;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      border-color: #3B82F6;
    }

    /* Filters Bar */
    .filters-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 24px;
      backdrop-filter: blur(10px);
      flex-wrap: wrap;
    }

    .search-box { flex: 1; position: relative; min-width: 300px; }

    .search-input {
      width: 100%;
      padding: 14px 48px 14px 20px;
      background: rgba(10, 15, 26, 0.6);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      color: white;
      font-size: 15px;
      transition: all 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #3B82F6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      opacity: 0.5;
    }

    .filter-select {
      padding: 14px 20px;
      background: rgba(10, 15, 26, 0.6);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-select:hover { border-color: #3B82F6; }

    .filter-select:focus {
      outline: none;
      border-color: #3B82F6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    /* Table Container */
    .leads-table-container {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 24px;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .leads-table {
      width: 100%;
      border-collapse: collapse;
    }

    .leads-table thead {
      background: linear-gradient(135deg, rgba(10, 15, 26, 0.9), rgba(10, 15, 26, 0.7));
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .leads-table th {
      padding: 16px;
      text-align: left;
      color: #64748B;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 600;
      border-bottom: 2px solid rgba(59, 130, 246, 0.2);
      cursor: pointer;
      transition: all 0.3s;
      user-select: none;
    }

    .leads-table th:hover { color: #3B82F6; background: rgba(59, 130, 246, 0.05); }

    .leads-table th.sortable::after {
      content: ' ‚áÖ';
      opacity: 0.3;
      font-size: 14px;
    }

    .leads-table th.sorted-asc::after {
      content: ' ‚Üë';
      opacity: 1;
      color: #3B82F6;
    }

    .leads-table th.sorted-desc::after {
      content: ' ‚Üì';
      opacity: 1;
      color: #3B82F6;
    }

    .leads-table tbody tr {
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
      transition: all 0.3s;
      cursor: pointer;
    }

    .leads-table tbody tr:nth-child(even) { background: rgba(10, 15, 26, 0.3); }

    .leads-table tbody tr:hover {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
      box-shadow: inset 4px 0 0 #3B82F6;
      transform: translateX(4px);
    }

    .leads-table td {
      padding: 16px;
      color: white;
      font-size: 14px;
    }

    .lead-name { font-weight: 600; color: #3B82F6; }
    .lead-phone { font-family: 'Orbitron', monospace; color: #94A3B8; font-size: 13px; }
    .lead-debt { font-family: 'Orbitron', monospace; font-weight: 600; font-size: 15px; }

    .debt-low { color: #22C55E; text-shadow: 0 0 10px rgba(34, 197, 94, 0.3); }
    .debt-medium { color: #F59E0B; text-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
    .debt-high { color: #EF4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid;
    }

    .status-new { background: rgba(59, 130, 246, 0.2); border-color: #3B82F6; color: #3B82F6; }
    .status-contacted { background: rgba(245, 158, 11, 0.2); border-color: #F59E0B; color: #F59E0B; }
    .status-qualified { background: rgba(6, 182, 212, 0.2); border-color: #06B6D4; color: #06B6D4; }
    .status-enrolled { background: rgba(34, 197, 94, 0.2); border-color: #22C55E; color: #22C55E; }

    /* Bulk Actions */
    .bulk-actions {
      display: none;
      gap: 12px;
      padding: 16px 20px;
      background: rgba(10, 15, 26, 0.6);
      border-top: 1px solid rgba(59, 130, 246, 0.2);
      align-items: center;
    }

    .bulk-actions.visible { display: flex; }

    .bulk-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #3B82F6;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: rgba(10, 15, 26, 0.6);
      border-top: 1px solid rgba(59, 130, 246, 0.2);
    }

    .pagination-info { color: #94A3B8; font-size: 14px; }

    .pagination-controls { display: flex; gap: 8px; }

    .page-btn {
      padding: 8px 16px;
      background: rgba(10, 15, 26, 0.6);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    .page-btn:hover:not(:disabled) {
      background: rgba(59, 130, 246, 0.2);
      border-color: #3B82F6;
    }

    .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .page-btn.active { background: linear-gradient(135deg, #3B82F6, #06B6D4); border-color: #3B82F6; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open { display: flex; }

    .modal-content {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(10, 15, 26, 0.98));
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 24px;
      padding: 32px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid rgba(59, 130, 246, 0.2);
    }

    .modal-header h3 { margin: 0; color: white; font-size: 24px; font-weight: 700; }

    .modal-close {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(239, 68, 68, 0.2);
      color: #EF4444;
      border-radius: 10px;
      cursor: pointer;
      font-size: 24px;
    }

    .modal-close:hover { background: #EF4444; color: white; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group.full-width { grid-column: 1 / -1; }

    .form-label {
      color: #94A3B8;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input {
      padding: 12px 16px;
      background: rgba(10, 15, 26, 0.6);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 10px;
      color: white;
      font-size: 15px;
      transition: all 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #3B82F6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid rgba(59, 130, 246, 0.2);
    }

    .modal-btn {
      flex: 1;
      padding: 14px 24px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      background: rgba(10, 15, 26, 0.6);
      color: white;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s;
    }

    .modal-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3); }
    .modal-btn.primary { background: linear-gradient(135deg, #3B82F6, #06B6D4); border-color: #3B82F6; }

    /* Detail Panel */
    .detail-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 600px;
      height: 100vh;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(10, 15, 26, 0.98));
      backdrop-filter: blur(20px);
      border-left: 2px solid rgba(59, 130, 246, 0.3);
      box-shadow: -8px 0 32px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
    }

    .detail-panel.open { transform: translateX(0); }

    .detail-panel-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .detail-panel-overlay.open { opacity: 1; pointer-events: all; }

    .detail-panel-header {
      padding: 24px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(6, 182, 212, 0.1));
      border-bottom: 2px solid rgba(59, 130, 246, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(20px);
    }

    .detail-panel-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      font-family: 'Orbitron', sans-serif;
    }

    .detail-panel-close {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid rgba(239, 68, 68, 0.3);
      color: #EF4444;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .detail-panel-close:hover {
      background: rgba(239, 68, 68, 0.4);
      transform: scale(1.1);
    }

    .detail-panel-content { padding: 24px; }

    .detail-section {
      margin-bottom: 32px;
      padding: 20px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 16px;
    }

    .detail-section-title {
      font-size: 18px;
      font-weight: 700;
      color: #3B82F6;
      margin-bottom: 16px;
    }

    .detail-field {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
    }

    .detail-field:last-child { border-bottom: none; }

    .detail-field-label { color: #94a3b8; font-size: 14px; font-weight: 500; }
    .detail-field-value { color: white; font-size: 14px; font-weight: 600; text-align: right; }

    .detail-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 24px;
    }

    .detail-action-btn {
      padding: 14px 20px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(6, 182, 212, 0.1));
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .detail-action-btn:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), rgba(6, 182, 212, 0.2));
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
    }
  </style>

  <!-- Header -->
  <div class="leads-header">
    <h2>CRM Leads</h2>
    <div class="header-actions">
      <button class="action-btn" onclick="importCSV()">üì• Import CSV</button>
      <button class="action-btn" onclick="exportCSV()">üì§ Export CSV</button>
      <button class="action-btn primary" onclick="openAddLeadModal()">‚ûï Add Lead</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <input type="text" class="search-input" id="searchInput" placeholder="Search leads by name, phone, email..." />
      <span class="search-icon">üîç</span>
    </div>
    <select class="filter-select" id="statusFilter">
      <option value="">All Statuses</option>
      <option value="new">New</option>
      <option value="contacted">Contacted</option>
      <option value="qualified">Qualified</option>
      <option value="enrolled">Enrolled</option>
    </select>
    <select class="filter-select" id="sourceFilter">
      <option value="">All Sources</option>
      <option value="web">Web</option>
      <option value="referral">Referral</option>
      <option value="social">Social Media</option>
      <option value="cold-call">Cold Call</option>
    </select>
    <select class="filter-select" id="priorityFilter">
      <option value="">All Priorities</option>
      <option value="high">High</option>
      <option value="medium">Medium</option>
      <option value="low">Low</option>
    </select>
  </div>

  <!-- Table -->
  <div class="leads-table-container">
    <table class="leads-table">
      <thead>
        <tr>
          <th style="width: 40px;"><input type="checkbox" class="bulk-checkbox" id="selectAll" /></th>
          <th class="sortable" data-sort="name">Name</th>
          <th class="sortable" data-sort="phone">Phone</th>
          <th class="sortable" data-sort="email">Email</th>
          <th class="sortable" data-sort="totalDebt">Total Debt</th>
          <th class="sortable" data-sort="monthlyIncome">Monthly Income</th>
          <th class="sortable" data-sort="dtiRatio">DTI Ratio</th>
          <th class="sortable" data-sort="status">Status</th>
          <th class="sortable" data-sort="source">Source</th>
          <th class="sortable" data-sort="priority">Priority</th>
          <th class="sortable" data-sort="lastContact">Last Contact</th>
        </tr>
      </thead>
      <tbody id="leadsTableBody">
        <!-- Populated by JS -->
      </tbody>
    </table>

    <!-- Bulk Actions -->
    <div class="bulk-actions" id="bulkActions">
      <span style="color: white; font-weight: 600;"><span id="selectedCount">0</span> selected</span>
      <button class="action-btn" onclick="bulkAssign()">üë§ Assign</button>
      <button class="action-btn" onclick="bulkChangeStatus()">üìù Change Status</button>
      <button class="action-btn" onclick="bulkExport()">üì§ Export</button>
      <button class="action-btn" style="border-color: #EF4444; color: #EF4444;" onclick="bulkDelete()">üóëÔ∏è Delete</button>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <div class="pagination-info">
        Showing <span id="showingStart">1</span>-<span id="showingEnd">25</span> of <span id="totalLeads">0</span> leads
      </div>
      <div class="pagination-controls">
        <button class="page-btn" id="prevPage" onclick="previousPage()">‚Üê Previous</button>
        <button class="page-btn active" id="page1" onclick="goToPage(1)">1</button>
        <button class="page-btn" id="page2" onclick="goToPage(2)">2</button>
        <button class="page-btn" id="page3" onclick="goToPage(3)">3</button>
        <button class="page-btn" id="nextPage" onclick="nextPage()">Next ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- Add Lead Modal -->
  <div id="addLeadModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Lead</h3>
        <button class="modal-close" onclick="closeAddLeadModal()">√ó</button>
      </div>

      <form id="addLeadForm" onsubmit="submitLead(event)">
        <h4 style="color: #3B82F6; margin-bottom: 16px;">Personal Information</h4>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Full Name *</label>
            <input type="text" class="form-input" name="name" required />
          </div>
          <div class="form-group">
            <label class="form-label">Phone *</label>
            <input type="tel" class="form-input" name="phone" required />
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" name="email" />
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-input" name="status">
              <option value="new">New</option>
              <option value="contacted">Contacted</option>
              <option value="qualified">Qualified</option>
              <option value="enrolled">Enrolled</option>
            </select>
          </div>
        </div>

        <h4 style="color: #3B82F6; margin: 24px 0 16px;">Financial Information</h4>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Total Debt</label>
            <input type="number" class="form-input" name="totalDebt" />
          </div>
          <div class="form-group">
            <label class="form-label">Monthly Income</label>
            <input type="number" class="form-input" name="monthlyIncome" />
          </div>
          <div class="form-group">
            <label class="form-label">Source</label>
            <select class="form-input" name="source">
              <option value="web">Web</option>
              <option value="referral">Referral</option>
              <option value="social">Social Media</option>
              <option value="cold-call">Cold Call</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Priority</label>
            <select class="form-input" name="priority">
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="modal-btn" onclick="closeAddLeadModal()">Cancel</button>
          <button type="submit" class="modal-btn primary">üíæ Save Lead</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Detail Panel -->
  <div id="detailPanelOverlay" class="detail-panel-overlay" onclick="closeDetailPanel()"></div>
  <div id="detailPanel" class="detail-panel">
    <div class="detail-panel-header">
      <h2 class="detail-panel-title" id="detailLeadName">Lead Details</h2>
      <button class="detail-panel-close" onclick="closeDetailPanel()">√ó</button>
    </div>
    <div class="detail-panel-content">
      <div class="detail-section">
        <div class="detail-section-title">Basic Information</div>
        <div class="detail-field">
          <span class="detail-field-label">Lead ID</span>
          <span class="detail-field-value" id="detailLeadId">-</span>
        </div>
        <div class="detail-field">
          <span class="detail-field-label">Phone</span>
          <span class="detail-field-value" id="detailPhone">-</span>
        </div>
        <div class="detail-field">
          <span class="detail-field-label">Email</span>
          <span class="detail-field-value" id="detailEmail">-</span>
        </div>
        <div class="detail-field">
          <span class="detail-field-label">Status</span>
          <span class="detail-field-value" id="detailStatus">-</span>
        </div>
        <div class="detail-field">
          <span class="detail-field-label">Source</span>
          <span class="detail-field-value" id="detailSource">-</span>
        </div>
        <div class="detail-field">
          <span class="detail-field-label">Priority</span>
          <span class="detail-field-value" id="detailPriority">-</span>
        </div>
      </div>

      <div class="detail-section">
        <div class="detail-section-title">Financial Information</div>
        <div class="detail-field">
          <span class="detail-field-label">Total Debt</span>
          <span class="detail-field-value" id="detailTotalDebt">-</span>
        </div>
        <div class="detail-field">
          <span class="detail-field-label">Monthly Income</span>
          <span class="detail-field-value" id="detailMonthlyIncome">-</span>
        </div>
        <div class="detail-field">
          <span class="detail-field-label">DTI Ratio</span>
          <span class="detail-field-value" id="detailDtiRatio">-</span>
        </div>
      </div>

      <div class="detail-section">
        <div class="detail-section-title">Timeline</div>
        <div class="detail-field">
          <span class="detail-field-label">Last Contact</span>
          <span class="detail-field-value" id="detailLastContact">-</span>
        </div>
        <div class="detail-field">
          <span class="detail-field-label">Created</span>
          <span class="detail-field-value" id="detailCreatedAt">-</span>
        </div>
      </div>

      <div class="detail-actions">
        <button class="detail-action-btn" onclick="callLead()">üìû Call Lead</button>
        <button class="detail-action-btn" onclick="showToast('Email coming soon', 'info')">üìß Email</button>
        <button class="detail-action-btn" onclick="editLead()">‚úèÔ∏è Edit</button>
        <button class="detail-action-btn" onclick="deleteLead()">üóëÔ∏è Delete</button>
      </div>
    </div>
  </div>

  <script>
(function() {
'use strict';

'use strict';

    // =====================
    // GLOBAL STATE
    // =====================
    let leads = [];
    let filteredLeads = [];
    let currentPage = 1;
    const leadsPerPage = 25;
    let currentSort = { field: null, direction: 'asc' };
    let selectedLeads = new Set();
    let currentLeadId = null;

    // =====================
    // INITIALIZATION
    // =====================
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ CRM Leads initializing...');
      
      loadLeads();
      setupFilters();
      setupSort();
      renderLeads();
      
      // Select All handler
      document.getElementById('selectAll').addEventListener('change', handleSelectAll);
    });

    // =====================
    // LOAD LEADS
    // =====================
    function loadLeads() {
      if (!window.DebtDB) {
        console.error('‚ùå DebtDB not loaded');
        showToast('Database not available', 'error');
        return;
      }

      leads = window.DebtDB.getLeads();
      console.log(`‚úÖ Loaded ${leads.length} leads`);
      
      if (leads.length === 0) {
        // Generate sample data for demo
        leads = generateSampleLeads(100);
        window.DebtDB.saveLeads(leads);
      }
    }

    function generateSampleLeads(count) {
      const names = ['John Smith', 'Sarah Johnson', 'Michael Brown', 'Emily Davis', 'David Wilson', 'Jennifer Martinez', 'Robert Taylor', 'Lisa Anderson', 'William Thomas', 'Mary Jackson'];
      const sources = ['web', 'referral', 'social', 'cold-call'];
      const statuses = ['new', 'contacted', 'qualified', 'enrolled'];
      const priorities = ['low', 'medium', 'high'];

      const sampleLeads = [];
      for (let i = 0; i < count; i++) {
        const totalDebt = Math.floor(Math.random() * 50000) + 5000;
        const monthlyIncome = Math.floor(Math.random() * 5000) + 2000;
        const dtiRatio = Math.round((totalDebt * 0.02 / monthlyIncome) * 100);

        sampleLeads.push({
          id: `LEAD${String(i + 1).padStart(4, '0')}`,
          name: names[Math.floor(Math.random() * names.length)] + ' ' + (i + 1),
          phone: `(555) ${String(Math.floor(Math.random() * 900) + 100)}-${String(Math.floor(Math.random() * 9000) + 1000)}`,
          email: `lead${i + 1}@example.com`,
          totalDebt: totalDebt,
          monthlyIncome: monthlyIncome,
          dtiRatio: dtiRatio,
          status: statuses[Math.floor(Math.random() * statuses.length)],
          source: sources[Math.floor(Math.random() * sources.length)],
          priority: priorities[Math.floor(Math.random() * priorities.length)],
          lastContact: Math.random() > 0.5 ? new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString() : null,
          createdAt: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toISOString()
        });
      }
      return sampleLeads;
    }

    // =====================
    // RENDER LEADS
    // =====================
    function renderLeads() {
      applyFilters();
      applySort();
      const paginated = paginateLeads();
      
      const tbody = document.getElementById('leadsTableBody');
      
      if (paginated.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #64748B; padding: 40px;">No leads found</td></tr>';
        updatePagination();
        return;
      }

      tbody.innerHTML = paginated.map(lead => {
        const debtClass = lead.totalDebt < 15000 ? 'debt-low' : lead.totalDebt < 30000 ? 'debt-medium' : 'debt-high';
        
        return `
          <tr onclick="viewLeadDetail('${lead.id}')">
            <td onclick="event.stopPropagation()">
              <input type="checkbox" class="bulk-checkbox lead-checkbox" data-id="${lead.id}" onchange="toggleSelect('${lead.id}')" ${selectedLeads.has(lead.id) ? 'checked' : ''} />
            </td>
            <td class="lead-name">${lead.name}</td>
            <td class="lead-phone">${lead.phone}</td>
            <td>${lead.email}</td>
            <td class="lead-debt ${debtClass}">$${lead.totalDebt.toLocaleString()}</td>
            <td class="lead-debt">$${lead.monthlyIncome.toLocaleString()}</td>
            <td class="lead-debt">${lead.dtiRatio}%</td>
            <td><span class="status-badge status-${lead.status}">${lead.status}</span></td>
            <td>${capitalizeFirst(lead.source)}</td>
            <td>${capitalizeFirst(lead.priority)}</td>
            <td>${lead.lastContact ? new Date(lead.lastContact).toLocaleDateString() : 'Never'}</td>
          </tr>
        `;
      }).join('');

      updatePagination();
    }

    // =====================
    // FILTERS & SORT
    // =====================
    function applyFilters() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const sourceFilter = document.getElementById('sourceFilter').value;
      const priorityFilter = document.getElementById('priorityFilter').value;

      filteredLeads = leads.filter(lead => {
        const matchesSearch = !search || 
          lead.name.toLowerCase().includes(search) ||
          lead.phone.includes(search) ||
          lead.email.toLowerCase().includes(search);
        
        const matchesStatus = !statusFilter || lead.status === statusFilter;
        const matchesSource = !sourceFilter || lead.source === sourceFilter;
        const matchesPriority = !priorityFilter || lead.priority === priorityFilter;

        return matchesSearch && matchesStatus && matchesSource && matchesPriority;
      });
    }

    function applySort() {
      if (!currentSort.field) return;

      filteredLeads.sort((a, b) => {
        let aVal = a[currentSort.field];
        let bVal = b[currentSort.field];

        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function paginateLeads() {
      const start = (currentPage - 1) * leadsPerPage;
      const end = start + leadsPerPage;
      return filteredLeads.slice(start, end);
    }

    function updatePagination() {
      const totalFiltered = filteredLeads.length;
      const start = (currentPage - 1) * leadsPerPage + 1;
      const end = Math.min(currentPage * leadsPerPage, totalFiltered);
      
      document.getElementById('showingStart').textContent = totalFiltered > 0 ? start : 0;
      document.getElementById('showingEnd').textContent = end;
      document.getElementById('totalLeads').textContent = totalFiltered;

      const totalPages = Math.ceil(totalFiltered / leadsPerPage);
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage >= totalPages;

      // Update page buttons
      for (let i = 1; i <= 3; i++) {
        const btn = document.getElementById(`page${i}`);
        if (i <= totalPages) {
          btn.style.display = 'block';
          btn.classList.toggle('active', i === currentPage);
          btn.textContent = i;
        } else {
          btn.style.display = 'none';
        }
      }
    }

    function setupFilters() {
      const inputs = ['searchInput', 'statusFilter', 'sourceFilter', 'priorityFilter'];
      inputs.forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
          currentPage = 1;
          renderLeads();
        });
      });
    }

    function setupSort() {
      document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const field = th.dataset.sort;
          
          if (currentSort.field === field) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.field = field;
            currentSort.direction = 'asc';
          }

          // Update UI
          document.querySelectorAll('.sortable').forEach(t => {
            t.classList.remove('sorted-asc', 'sorted-desc');
          });
          th.classList.add(`sorted-${currentSort.direction}`);

          renderLeads();
        });
      });
    }

    // =====================
    // SELECTION
    // =====================
    function toggleSelect(leadId) {
      if (selectedLeads.has(leadId)) {
        selectedLeads.delete(leadId);
      } else {
        selectedLeads.add(leadId);
      }
      updateBulkActions();
    }

    function handleSelectAll(e) {
      const checkboxes = document.querySelectorAll('.lead-checkbox');
      checkboxes.forEach(cb => {
        const leadId = cb.dataset.id;
        if (e.target.checked) {
          selectedLeads.add(leadId);
          cb.checked = true;
        } else {
          selectedLeads.delete(leadId);
          cb.checked = false;
        }
      });
      updateBulkActions();
    }

    function updateBulkActions() {
      const count = selectedLeads.size;
      document.getElementById('selectedCount').textContent = count;
      
      if (count > 0) {
        document.getElementById('bulkActions').classList.add('visible');
      } else {
        document.getElementById('bulkActions').classList.remove('visible');
      }
    }

    // =====================
    // PAGINATION
    // =====================
    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        renderLeads();
        window.scrollTo(0, 0);
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredLeads.length / leadsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderLeads();
        window.scrollTo(0, 0);
      }
    }

    function goToPage(page) {
      currentPage = page;
      renderLeads();
      window.scrollTo(0, 0);
    }

    // =====================
    // LEAD DETAIL PANEL
    // =====================
    function viewLeadDetail(leadId) {
      const lead = leads.find(l => l.id === leadId);
      if (!lead) return;

      currentLeadId = leadId;

      // Populate panel
      document.getElementById('detailLeadName').textContent = lead.name;
      document.getElementById('detailLeadId').textContent = lead.id;
      document.getElementById('detailPhone').textContent = lead.phone;
      document.getElementById('detailEmail').textContent = lead.email || 'N/A';
      document.getElementById('detailStatus').textContent = capitalizeFirst(lead.status);
      document.getElementById('detailSource').textContent = capitalizeFirst(lead.source);
      document.getElementById('detailPriority').textContent = capitalizeFirst(lead.priority);
      document.getElementById('detailTotalDebt').textContent = `$${lead.totalDebt.toLocaleString()}`;
      document.getElementById('detailMonthlyIncome').textContent = `$${lead.monthlyIncome.toLocaleString()}`;
      document.getElementById('detailDtiRatio').textContent = `${lead.dtiRatio}%`;
      document.getElementById('detailLastContact').textContent = lead.lastContact ? new Date(lead.lastContact).toLocaleString() : 'Never';
      document.getElementById('detailCreatedAt').textContent = new Date(lead.createdAt).toLocaleString();

      // Show panel
      document.getElementById('detailPanelOverlay').classList.add('open');
      document.getElementById('detailPanel').classList.add('open');
    }

    function closeDetailPanel() {
      document.getElementById('detailPanelOverlay').classList.remove('open');
      document.getElementById('detailPanel').classList.remove('open');
      currentLeadId = null;
    }

    function callLead() {
      const lead = leads.find(l => l.id === currentLeadId);
      if (lead) {
        // Switch to Power Dialer and populate phone
        window.location.hash = 'power-dialer';
        setTimeout(() => {
          const phoneInput = document.getElementById('phoneInput');
          if (phoneInput) {
            phoneInput.value = lead.phone;
          }
        }, 500);
        closeDetailPanel();
      }
    }

    function editLead() {
      showToast('Edit functionality coming soon', 'info');
    }

    function deleteLead() {
      if (confirm(`Delete lead ${currentLeadId}?`)) {
        leads = leads.filter(l => l.id !== currentLeadId);
        window.DebtDB.saveLeads(leads);
        renderLeads();
        closeDetailPanel();
        showToast('Lead deleted', 'success');
      }
    }

    // =====================
    // ADD LEAD MODAL
    // =====================
    function openAddLeadModal() {
      document.getElementById('addLeadModal').classList.add('open');
    }

    function closeAddLeadModal() {
      document.getElementById('addLeadModal').classList.remove('open');
      document.getElementById('addLeadForm').reset();
    }

    function submitLead(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const totalDebt = parseFloat(formData.get('totalDebt')) || 0;
      const monthlyIncome = parseFloat(formData.get('monthlyIncome')) || 1;
      const dtiRatio = Math.round((totalDebt * 0.02 / monthlyIncome) * 100);

      const newLead = {
        id: `LEAD${String(leads.length + 1).padStart(4, '0')}`,
        name: formData.get('name'),
        phone: formData.get('phone'),
        email: formData.get('email') || '',
        totalDebt: totalDebt,
        monthlyIncome: monthlyIncome,
        dtiRatio: dtiRatio,
        status: formData.get('status'),
        source: formData.get('source'),
        priority: formData.get('priority'),
        lastContact: null,
        createdAt: new Date().toISOString()
      };

      leads.unshift(newLead);
      window.DebtDB.saveLeads(leads);
      renderLeads();
      closeAddLeadModal();
      
      showToast(`Lead "${newLead.name}" added successfully!`, 'success');
    }

    // =====================
    // BULK ACTIONS
    // =====================
    function bulkAssign() {
      const agent = prompt('Assign to agent:');
      if (agent) {
        selectedLeads.forEach(id => {
          const lead = leads.find(l => l.id === id);
          if (lead) lead.assignedAgent = agent;
        });
        window.DebtDB.saveLeads(leads);
        renderLeads();
        selectedLeads.clear();
        updateBulkActions();
        showToast(`Assigned ${selectedLeads.size} leads to ${agent}`, 'success');
      }
    }

    function bulkChangeStatus() {
      const status = prompt('Change status to (new/contacted/qualified/enrolled):');
      if (status && ['new', 'contacted', 'qualified', 'enrolled'].includes(status)) {
        selectedLeads.forEach(id => {
          const lead = leads.find(l => l.id === id);
          if (lead) lead.status = status;
        });
        window.DebtDB.saveLeads(leads);
        renderLeads();
        selectedLeads.clear();
        updateBulkActions();
        showToast(`Updated ${selectedLeads.size} leads to ${status}`, 'success');
      }
    }

    function bulkExport() {
      const selected = leads.filter(l => selectedLeads.has(l.id));
      const csv = convertToCSV(selected);
      downloadCSV(csv, 'selected-leads.csv');
      showToast(`Exported ${selected.length} leads`, 'success');
    }

    function bulkDelete() {
      if (confirm(`Delete ${selectedLeads.size} leads? This cannot be undone.`)) {
        leads = leads.filter(l => !selectedLeads.has(l.id));
        window.DebtDB.saveLeads(leads);
        renderLeads();
        selectedLeads.clear();
        updateBulkActions();
        showToast('Leads deleted', 'success');
      }
    }

    // =====================
    // IMPORT/EXPORT CSV
    // =====================
    function importCSV() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.csv';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const csv = event.target.result;
              const parsed = parseCSV(csv);
              
              if (parsed.length === 0) {
                showToast('No valid leads found in CSV file', 'warning');
                return;
              }

              let successCount = 0;
              parsed.forEach(row => {
                try {
                  const newLead = {
                    id: `LEAD${String(leads.length + successCount + 1).padStart(4, '0')}`,
                    name: row.name || 'Unknown',
                    phone: row.phone || '',
                    email: row.email || '',
                    totalDebt: parseFloat(row.totalDebt) || 0,
                    monthlyIncome: parseFloat(row.monthlyIncome) || 0,
                    dtiRatio: parseFloat(row.dtiRatio) || 0,
                    status: row.status || 'new',
                    source: row.source || 'CSV Import',
                    priority: row.priority || 'medium',
                    lastContact: null,
                    createdAt: new Date().toISOString()
                  };

                  leads.unshift(newLead);
                  successCount++;
                } catch (err) {
                  console.error('Error adding lead:', err);
                }
              });

              window.DebtDB.saveLeads(leads);
              renderLeads();
              showToast(`Successfully imported ${successCount} leads!`, 'success');
            } catch (error) {
              showToast('Failed to parse CSV file', 'error');
              console.error('CSV import error:', error);
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    function parseCSV(csv) {
      const lines = csv.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/\s+/g, ''));
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const row = {};
        
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });

        if (row.name || row.phone) {
          data.push(row);
        }
      }

      return data;
    }

    function exportCSV() {
      const csv = convertToCSV(filteredLeads);
      downloadCSV(csv, 'all-leads.csv');
      showToast(`Exported ${filteredLeads.length} leads`, 'success');
    }

    function convertToCSV(data) {
      const headers = ['Name', 'Phone', 'Email', 'Total Debt', 'Monthly Income', 'DTI Ratio', 'Status', 'Source', 'Priority'];
      const rows = data.map(l => [
        l.name, l.phone, l.email, l.totalDebt, l.monthlyIncome, l.dtiRatio,
        l.status, l.source, l.priority
      ]);
      return [headers, ...rows].map(row => row.join(',')).join('\n');
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // =====================
    // HELPERS
    // =====================
    function capitalizeFirst(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1).replace('-', ' ');
    }

    function showToast(message, type = 'info') {
      if (typeof Toast !== 'undefined') {
        Toast[type](message);
      } else {
        console.log(`[${type.toUpperCase()}] ${message}`);
      }
    }

  // Expose functions to window for onclick handlers
  window.bulkAssign = bulkAssign;
  window.bulkChangeStatus = bulkChangeStatus;
  window.bulkDelete = bulkDelete;
  window.bulkExport = bulkExport;
  window.callLead = callLead;
  window.closeAddLeadModal = closeAddLeadModal;
  window.closeDetailPanel = closeDetailPanel;
  window.deleteLead = deleteLead;
  window.editLead = editLead;
  window.exportCSV = exportCSV;
  window.goToPage = goToPage;
  window.importCSV = importCSV;
  window.nextPage = nextPage;
  window.openAddLeadModal = openAddLeadModal;
  window.previousPage = previousPage;
  window.showToast = showToast;
  window.viewLeadDetail = viewLeadDetail;
  window.submitLead = submitLead;
  window.toggleSelect = toggleSelect;
})();
</script>
</div>
