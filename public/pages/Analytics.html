<!-- Analytics Dashboard -->
<div class="space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-white font-orbitron mb-2">Business Intelligence</h1>
      <p class="text-gray-400">Real-time analytics and performance insights</p>
    </div>
    <button onclick="exportAnalytics()" class="btn btn-primary flex items-center gap-2">
      <i data-lucide="download" class="w-4 h-4"></i>
      <span>Export CSV</span>
    </button>
  </div>

  <!-- 12 KPI Cards Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
    <!-- Total Revenue KPI -->
    <div class="kpi-card fade-in-up stagger-1">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-lg">
          <i data-lucide="dollar-sign" class="w-5 h-5 text-blue-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          <span>+12.5%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Total Revenue</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-revenue">$0</h3>
      <canvas id="sparkline-revenue" class="w-full h-8"></canvas>
    </div>

    <!-- Total Enrolled KPI -->
    <div class="kpi-card fade-in-up stagger-2">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-green-500/20 to-emerald-500/20 rounded-lg">
          <i data-lucide="users-2" class="w-5 h-5 text-green-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          <span>+8.3%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Total Enrolled</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-enrolled">0</h3>
      <canvas id="sparkline-enrolled" class="w-full h-8"></canvas>
    </div>

    <!-- Active Cases KPI -->
    <div class="kpi-card fade-in-up stagger-3">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-cyan-500/20 to-blue-500/20 rounded-lg">
          <i data-lucide="briefcase" class="w-5 h-5 text-cyan-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          <span>+5.2%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Active Cases</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-active">0</h3>
      <canvas id="sparkline-active" class="w-full h-8"></canvas>
    </div>

    <!-- Settlement Rate KPI -->
    <div class="kpi-card fade-in-up stagger-4">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-emerald-500/20 to-green-500/20 rounded-lg">
          <i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          <span>+2.1%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Settlement Rate</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-settlement-rate">0%</h3>
      <canvas id="sparkline-settlement" class="w-full h-8"></canvas>
    </div>

    <!-- Avg Settlement % KPI -->
    <div class="kpi-card fade-in-up stagger-1">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-yellow-500/20 to-amber-500/20 rounded-lg">
          <i data-lucide="percent" class="w-5 h-5 text-yellow-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-down" class="w-4 h-4"></i>
          <span>-3.2%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Avg Settlement %</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-avg-settlement">0%</h3>
      <canvas id="sparkline-avg-settlement" class="w-full h-8"></canvas>
    </div>

    <!-- Client Satisfaction KPI -->
    <div class="kpi-card fade-in-up stagger-2">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-pink-500/20 to-rose-500/20 rounded-lg">
          <i data-lucide="heart" class="w-5 h-5 text-pink-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          <span>+4.7%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Client Satisfaction</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-satisfaction">0%</h3>
      <canvas id="sparkline-satisfaction" class="w-full h-8"></canvas>
    </div>

    <!-- Agent Utilization KPI -->
    <div class="kpi-card fade-in-up stagger-3">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-purple-500/20 to-violet-500/20 rounded-lg">
          <i data-lucide="activity" class="w-5 h-5 text-purple-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          <span>+6.8%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Agent Utilization</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-utilization">0%</h3>
      <canvas id="sparkline-utilization" class="w-full h-8"></canvas>
    </div>

    <!-- Call Volume KPI -->
    <div class="kpi-card fade-in-up stagger-4">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-orange-500/20 to-red-500/20 rounded-lg">
          <i data-lucide="phone" class="w-5 h-5 text-orange-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          <span>+15.3%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Call Volume</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-calls">0</h3>
      <canvas id="sparkline-calls" class="w-full h-8"></canvas>
    </div>

    <!-- Conversion Rate KPI -->
    <div class="kpi-card fade-in-up stagger-1">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-teal-500/20 to-cyan-500/20 rounded-lg">
          <i data-lucide="target" class="w-5 h-5 text-teal-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          <span>+3.4%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Conversion Rate</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-conversion">0%</h3>
      <canvas id="sparkline-conversion" class="w-full h-8"></canvas>
    </div>

    <!-- Churn Rate KPI -->
    <div class="kpi-card fade-in-up stagger-2">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-red-500/20 to-rose-500/20 rounded-lg">
          <i data-lucide="user-x" class="w-5 h-5 text-red-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-down" class="w-4 h-4"></i>
          <span>-1.2%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Churn Rate</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-churn">0%</h3>
      <canvas id="sparkline-churn" class="w-full h-8"></canvas>
    </div>

    <!-- LTV KPI -->
    <div class="kpi-card fade-in-up stagger-3">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-indigo-500/20 to-blue-500/20 rounded-lg">
          <i data-lucide="trending-up" class="w-5 h-5 text-indigo-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          <span>+7.9%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Client LTV</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-ltv">$0</h3>
      <canvas id="sparkline-ltv" class="w-full h-8"></canvas>
    </div>

    <!-- Time to Settlement KPI -->
    <div class="kpi-card fade-in-up stagger-4">
      <div class="flex items-start justify-between mb-3">
        <div class="p-2 bg-gradient-to-br from-lime-500/20 to-green-500/20 rounded-lg">
          <i data-lucide="clock" class="w-5 h-5 text-lime-400"></i>
        </div>
        <div class="flex items-center gap-1 text-green-400 text-sm">
          <i data-lucide="trending-down" class="w-4 h-4"></i>
          <span>-8.1%</span>
        </div>
      </div>
      <p class="text-gray-400 text-sm mb-1">Time to Settlement</p>
      <h3 class="text-2xl font-bold text-white font-orbitron mb-2" id="kpi-time">0d</h3>
      <canvas id="sparkline-time" class="w-full h-8"></canvas>
    </div>
  </div>

  <!-- Performance Trends & Agent Scorecards -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Performance Trends (Last 6 Months) -->
    <div class="glass-card rounded-2xl p-6 fade-in-up stagger-5">
      <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
        <i data-lucide="trending-up" class="w-5 h-5 text-blue-400"></i>
        Performance Trends
      </h2>
      <div class="space-y-4" id="performance-trends">
        <!-- Dynamically populated -->
      </div>
    </div>

    <!-- Agent Scorecards -->
    <div class="glass-card rounded-2xl p-6 fade-in-up stagger-6">
      <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
        <i data-lucide="award" class="w-5 h-5 text-yellow-400"></i>
        Agent Scorecards
      </h2>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="text-gray-400 text-xs uppercase border-b border-gray-800">
              <th class="text-left pb-3">Rank</th>
              <th class="text-left pb-3">Agent</th>
              <th class="text-right pb-3">Calls</th>
              <th class="text-right pb-3">Enrolled</th>
              <th class="text-right pb-3">Revenue</th>
              <th class="text-right pb-3">Rate</th>
            </tr>
          </thead>
          <tbody id="agent-scorecards" class="divide-y divide-gray-800">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Conversion Funnel & Revenue by Channel -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Conversion Funnel -->
    <div class="glass-card rounded-2xl p-6 fade-in-up stagger-5">
      <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
        <i data-lucide="filter" class="w-5 h-5 text-cyan-400"></i>
        Conversion Funnel
      </h2>
      <div id="conversion-funnel" class="space-y-3">
        <!-- SVG Funnel -->
      </div>
    </div>

    <!-- Revenue by Channel -->
    <div class="glass-card rounded-2xl p-6 fade-in-up stagger-6">
      <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
        <i data-lucide="pie-chart" class="w-5 h-5 text-emerald-400"></i>
        Revenue by Channel
      </h2>
      <div id="revenue-channels" class="space-y-3">
        <!-- Horizontal bar charts -->
      </div>
    </div>
  </div>

  <!-- Geographic Breakdown -->
  <div class="glass-card rounded-2xl p-6 fade-in-up stagger-5">
    <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
      <i data-lucide="map-pin" class="w-5 h-5 text-purple-400"></i>
      Geographic Breakdown
    </h2>
    <div id="geographic-breakdown" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
      <!-- State cards -->
    </div>
  </div>

  <!-- Custom Report Builder & Forecasting -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Custom Report Builder -->
    <div class="glass-card rounded-2xl p-6 fade-in-up stagger-5">
      <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
        <i data-lucide="file-text" class="w-5 h-5 text-orange-400"></i>
        Custom Report Builder
      </h2>
      <div class="space-y-4">
        <div>
          <label class="text-gray-400 text-sm mb-2 block">Metrics</label>
          <select id="report-metrics" multiple class="w-full bg-[#0a0f1a] border border-gray-800 rounded-lg p-2 text-white">
            <option value="revenue">Revenue</option>
            <option value="enrollments">Enrollments</option>
            <option value="calls">Calls</option>
            <option value="conversion">Conversion Rate</option>
            <option value="settlement">Settlement Rate</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-gray-400 text-sm mb-2 block">Start Date</label>
            <input type="date" id="report-start" class="w-full bg-[#0a0f1a] border border-gray-800 rounded-lg p-2 text-white">
          </div>
          <div>
            <label class="text-gray-400 text-sm mb-2 block">End Date</label>
            <input type="date" id="report-end" class="w-full bg-[#0a0f1a] border border-gray-800 rounded-lg p-2 text-white">
          </div>
        </div>
        <div>
          <label class="text-gray-400 text-sm mb-2 block">Group By</label>
          <select id="report-grouping" class="w-full bg-[#0a0f1a] border border-gray-800 rounded-lg p-2 text-white">
            <option value="day">Daily</option>
            <option value="week">Weekly</option>
            <option value="month">Monthly</option>
            <option value="agent">By Agent</option>
          </select>
        </div>
        <button onclick="generateReport()" class="btn btn-primary w-full">
          <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>
          Generate Report
        </button>
      </div>
      <div id="custom-report-results" class="mt-6">
        <!-- Results table -->
      </div>
    </div>

    <!-- Forecasting Panel -->
    <div class="glass-card rounded-2xl p-6 fade-in-up stagger-6">
      <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
        <i data-lucide="zap" class="w-5 h-5 text-yellow-400"></i>
        Revenue Forecast
      </h2>
      <div id="forecast-panel" class="space-y-4">
        <!-- Forecast cards -->
      </div>
    </div>
  </div>

  <!-- Real-time Activity Feed -->
  <div class="glass-card rounded-2xl p-6 fade-in-up stagger-5">
    <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
      <i data-lucide="activity" class="w-5 h-5 text-green-400"></i>
      Real-time Activity Feed
    </h2>
    <div id="activity-feed" class="space-y-3">
      <!-- Live activity items -->
    </div>
  </div>
</div>

<script>
function initAnalytics() {
  try {
    // Load KPI data
    loadKPIs();
    loadPerformanceTrends();
    loadAgentScorecard();
    loadConversionFunnel();
    loadRevenueChannels();
    loadGeographicBreakdown();
    loadForecast();
    loadActivityFeed();
    
    // Reinitialize icons
    lucide.createIcons();
  } catch (error) {
    console.error('Failed to load Analytics:', error);
    Toast.error('Failed to load analytics data. Please refresh the page.');
  }
}

function loadKPIs() {
  try {
    // Calculate KPIs from DB
    const totalRevenue = DB.revenue.thisMonth;
    const totalEnrolled = DB.cases.length;
    const activeCases = DB.cases.filter(c => ['In Program', 'Negotiating'].includes(c.stage)).length;
    const settledCases = DB.cases.filter(c => ['Settled', 'Completed'].includes(c.stage)).length;
  const settlementRate = totalEnrolled > 0 ? ((settledCases / totalEnrolled) * 100).toFixed(1) : 0;
  const avgSettlement = 42.3; // Mock
  const satisfaction = 94.7; // Mock
  const utilization = 87.2; // Mock
  const totalCalls = DB.agents.reduce((sum, a) => sum + a.stats.callsToday, 0);
  const conversion = 34.5; // Mock
  const churn = 3.8; // Mock
  const ltv = 8450; // Mock
  const timeToSettlement = 247; // Mock days

  // Update DOM
  document.getElementById('kpi-revenue').textContent = DBHelpers.formatCurrency(totalRevenue);
  document.getElementById('kpi-enrolled').textContent = totalEnrolled;
  document.getElementById('kpi-active').textContent = activeCases;
  document.getElementById('kpi-settlement-rate').textContent = settlementRate + '%';
  document.getElementById('kpi-avg-settlement').textContent = avgSettlement + '%';
  document.getElementById('kpi-satisfaction').textContent = satisfaction + '%';
  document.getElementById('kpi-utilization').textContent = utilization + '%';
  document.getElementById('kpi-calls').textContent = totalCalls;
  document.getElementById('kpi-conversion').textContent = conversion + '%';
  document.getElementById('kpi-churn').textContent = churn + '%';
  document.getElementById('kpi-ltv').textContent = DBHelpers.formatCurrency(ltv);
  document.getElementById('kpi-time').textContent = timeToSettlement + 'd';

  // Draw sparklines
  drawSparkline('sparkline-revenue', [420, 450, 480, 510, 560, 645]);
  drawSparkline('sparkline-enrolled', [15, 18, 20, 17, 19, 20]);
  drawSparkline('sparkline-active', [12, 14, 13, 15, 16, 18]);
  drawSparkline('sparkline-settlement', [68, 71, 73, 72, 75, 78]);
  drawSparkline('sparkline-avg-settlement', [45, 44, 43, 42.5, 42.8, 42.3]);
  drawSparkline('sparkline-satisfaction', [89, 91, 92, 93, 94, 94.7]);
  drawSparkline('sparkline-utilization', [82, 84, 85, 86, 86.5, 87.2]);
  drawSparkline('sparkline-calls', [320, 340, 360, 380, 410, 450]);
  drawSparkline('sparkline-conversion', [31, 32, 33, 33.5, 34, 34.5]);
    drawSparkline('sparkline-churn', [5.2, 4.8, 4.5, 4.2, 4.0, 3.8]);
    drawSparkline('sparkline-ltv', [7200, 7500, 7800, 8000, 8200, 8450]);
    drawSparkline('sparkline-time', [285, 275, 268, 260, 252, 247]);
  } catch (error) {
    console.error('Failed to load KPIs:', error);
    Toast.error('Failed to load KPI data');
  }
}

function drawSparkline(canvasId, data) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const width = canvas.offsetWidth;
  const height = 32;
  canvas.width = width;
  canvas.height = height;

  const max = Math.max(...data);
  const min = Math.min(...data);
  const range = max - min || 1;
  const step = width / (data.length - 1);

  ctx.clearRect(0, 0, width, height);
  ctx.strokeStyle = 'rgba(59, 130, 246, 0.8)';
  ctx.lineWidth = 2;
  ctx.beginPath();

  data.forEach((val, i) => {
    const x = i * step;
    const y = height - ((val - min) / range) * height;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });

  ctx.stroke();

  // Fill gradient
  ctx.lineTo(width, height);
  ctx.lineTo(0, height);
  ctx.closePath();
  const gradient = ctx.createLinearGradient(0, 0, 0, height);
  gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
  gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
  ctx.fillStyle = gradient;
  ctx.fill();
}

function loadPerformanceTrends() {
  const months = ['Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb'];
  const revenue = [480, 510, 550, 590, 610, 645];
  const enrollments = [18, 20, 22, 21, 19, 20];
  
  const maxRevenue = Math.max(...revenue);
  const maxEnrollments = Math.max(...enrollments);

  const html = months.map((month, i) => {
    const revPct = (revenue[i] / maxRevenue * 100).toFixed(1);
    const enrPct = (enrollments[i] / maxEnrollments * 100).toFixed(1);
    
    return `
      <div class="space-y-2">
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-400">${month}</span>
          <span class="text-white font-semibold">${DBHelpers.formatCurrency(revenue[i] * 1000)} / ${enrollments[i]} enrolled</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${revPct}%"></div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('performance-trends').innerHTML = html;
}

function loadAgentScorecard() {
  const agents = DB.agents
    .map(a => ({
      ...a,
      score: a.stats.enrollments * 100 + a.stats.callsToday
    }))
    .sort((a, b) => b.score - a.score)
    .slice(0, 10);

  const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];

  const html = agents.map((agent, i) => {
    const rank = i + 1;
    const medal = i < 3 ? medals[i] : '';
    
    return `
      <tr class="hover:bg-blue-500/5 transition-colors">
        <td class="py-3 text-center">
          <span class="text-lg">${medal || rank}</span>
        </td>
        <td class="py-3">
          <div class="flex items-center gap-2">
            <img src="${agent.avatar}" class="w-8 h-8 rounded-full" />
            <span class="text-white text-sm">${agent.name}</span>
          </div>
        </td>
        <td class="py-3 text-right text-white font-orbitron">${agent.stats.callsToday}</td>
        <td class="py-3 text-right text-white font-orbitron">${agent.stats.enrollments}</td>
        <td class="py-3 text-right text-white font-orbitron">${DBHelpers.formatCurrency(agent.stats.revenue)}</td>
        <td class="py-3 text-right">
          <span class="text-green-400 font-orbitron">${agent.stats.conversionRate}%</span>
        </td>
      </tr>
    `;
  }).join('');

  document.getElementById('agent-scorecards').innerHTML = html;
}

function loadConversionFunnel() {
  const stages = [
    { name: 'Lead', count: 450, color: '#3B82F6' },
    { name: 'Contact', count: 320, color: '#06B6D4' },
    { name: 'Qualify', count: 180, color: '#10B981' },
    { name: 'Enroll', count: 92, color: '#F59E0B' },
    { name: 'Complete', count: 68, color: '#22C55E' }
  ];

  const maxCount = stages[0].count;

  const html = stages.map((stage, i) => {
    const width = (stage.count / maxCount * 100);
    const dropOff = i > 0 ? ((stages[i-1].count - stage.count) / stages[i-1].count * 100).toFixed(1) : 0;
    
    return `
      <div class="space-y-1">
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-400">${stage.name}</span>
          <div class="flex items-center gap-3">
            <span class="text-white font-orbitron">${stage.count}</span>
            ${i > 0 ? `<span class="text-red-400 text-xs">-${dropOff}%</span>` : ''}
          </div>
        </div>
        <div class="h-10 rounded-lg overflow-hidden" style="background: rgba(15,23,42,0.5)">
          <div class="h-full flex items-center justify-center transition-all duration-1000" 
               style="width: ${width}%; background: linear-gradient(90deg, ${stage.color}, ${stage.color}AA)">
          </div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('conversion-funnel').innerHTML = html;
}

function loadRevenueChannels() {
  const channels = [
    { name: 'Organic Search', revenue: 285000, color: '#3B82F6' },
    { name: 'Paid Ads', revenue: 195000, color: '#06B6D4' },
    { name: 'Referrals', revenue: 98000, color: '#22C55E' },
    { name: 'Social Media', revenue: 42000, color: '#F59E0B' },
    { name: 'Email', revenue: 25000, color: '#8B5CF6' }
  ];

  const maxRevenue = Math.max(...channels.map(c => c.revenue));

  const html = channels.map(channel => {
    const width = (channel.revenue / maxRevenue * 100);
    
    return `
      <div class="space-y-1">
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-400">${channel.name}</span>
          <span class="text-white font-orbitron">${DBHelpers.formatCurrency(channel.revenue)}</span>
        </div>
        <div class="h-8 rounded-lg overflow-hidden" style="background: rgba(15,23,42,0.5)">
          <div class="h-full transition-all duration-1000" 
               style="width: ${width}%; background: linear-gradient(90deg, ${channel.color}, ${channel.color}AA)">
          </div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('revenue-channels').innerHTML = html;
}

function loadGeographicBreakdown() {
  const states = [
    { code: 'CA', leads: 127, color: '#1e40af' },
    { code: 'TX', leads: 98, color: '#2563eb' },
    { code: 'FL', leads: 89, color: '#3b82f6' },
    { code: 'NY', leads: 76, color: '#60a5fa' },
    { code: 'IL', leads: 54, color: '#93c5fd' },
    { code: 'PA', leads: 48, color: '#bfdbfe' },
    { code: 'OH', leads: 42, color: '#dbeafe' },
    { code: 'GA', leads: 38, color: '#eff6ff' },
    { code: 'NC', leads: 32, color: '#f0f9ff' },
    { code: 'MI', leads: 28, color: '#f0f9ff' }
  ];

  const html = states.map(state => `
    <div class="p-4 rounded-xl text-center transition-all hover:scale-105 cursor-pointer"
         style="background: linear-gradient(135deg, ${state.color}44, ${state.color}22)">
      <div class="text-2xl font-bold text-white font-orbitron mb-1">${state.code}</div>
      <div class="text-sm text-gray-400">${state.leads} leads</div>
    </div>
  `).join('');

  document.getElementById('geographic-breakdown').innerHTML = html;
}

function loadForecast() {
  const forecast = [
    { month: 'March 2026', projected: 695000, low: 650000, high: 740000 },
    { month: 'April 2026', projected: 745000, low: 690000, high: 800000 },
    { month: 'May 2026', projected: 810000, low: 750000, high: 870000 }
  ];

  const html = forecast.map(f => `
    <div class="p-4 rounded-xl bg-gradient-to-br from-blue-500/10 to-cyan-500/10 border border-blue-500/20">
      <div class="text-gray-400 text-sm mb-1">${f.month}</div>
      <div class="text-2xl font-bold text-white font-orbitron mb-2">${DBHelpers.formatCurrency(f.projected)}</div>
      <div class="flex items-center justify-between text-xs text-gray-500">
        <span>Low: ${DBHelpers.formatCurrency(f.low)}</span>
        <span>High: ${DBHelpers.formatCurrency(f.high)}</span>
      </div>
      <div class="mt-2 h-2 bg-[#0a0f1a] rounded-full overflow-hidden">
        <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full" style="width: 68%"></div>
      </div>
    </div>
  `).join('');

  document.getElementById('forecast-panel').innerHTML = html;
}

function loadActivityFeed() {
  const activities = [
    { icon: 'user-plus', text: 'Sarah M. enrolled $45K case', time: '2 min ago', color: 'green' },
    { icon: 'phone', text: 'Agent Maria made 50th call today', time: '8 min ago', color: 'blue' },
    { icon: 'check-circle', text: 'Case #CASE042 settled for $18K', time: '15 min ago', color: 'emerald' },
    { icon: 'dollar-sign', text: 'Revenue milestone: $650K this month', time: '32 min ago', color: 'yellow' },
    { icon: 'star', text: 'Client gave 5-star review', time: '1 hr ago', color: 'pink' },
    { icon: 'target', text: 'Conversion rate hit 35%', time: '1 hr ago', color: 'cyan' },
    { icon: 'trending-up', text: 'Lead volume up 18% this week', time: '2 hrs ago', color: 'purple' },
    { icon: 'users', text: 'New team member onboarded', time: '3 hrs ago', color: 'indigo' },
    { icon: 'award', text: 'Agent John hit monthly quota', time: '4 hrs ago', color: 'orange' },
    { icon: 'zap', text: 'Automated 120 follow-ups', time: '5 hrs ago', color: 'teal' }
  ];

  const html = activities.map(a => `
    <div class="flex items-center gap-3 p-3 rounded-lg bg-${a.color}-500/5 border border-${a.color}-500/20 fade-in-up">
      <div class="p-2 bg-${a.color}-500/20 rounded-lg">
        <i data-lucide="${a.icon}" class="w-4 h-4 text-${a.color}-400"></i>
      </div>
      <div class="flex-1">
        <p class="text-white text-sm">${a.text}</p>
        <p class="text-gray-500 text-xs">${a.time}</p>
      </div>
    </div>
  `).join('');

  document.getElementById('activity-feed').innerHTML = html;
  lucide.createIcons();
}

function generateReport() {
  const results = document.getElementById('custom-report-results');
  results.innerHTML = `
    <div class="mt-4 p-4 rounded-lg bg-blue-500/10 border border-blue-500/20">
      <div class="text-white text-sm mb-2">Report Generated Successfully</div>
      <div class="text-gray-400 text-xs">Showing results for selected metrics and date range</div>
    </div>
  `;
}

function exportAnalytics() {
  // Mock CSV export
  const csv = 'Metric,Value\nRevenue,$645000\nEnrollments,20\nActive Cases,18';
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'analytics-export.csv';
  a.click();
}

// Initialize on load
if (typeof initAnalytics === 'function') {
  initAnalytics();
}
</script>
